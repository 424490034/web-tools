<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>å±å¹•å½•åˆ¶å·¥å…·</title>
    <script src="./RecordRTC.js"></script>
    <!-- æ·»åŠ ffmpeg.js -->
    <script src="./ffmpeg.min.js"></script>
    <style>
      /* ä¿æŒåŸå§‹æ ·å¼ä¸å˜ï¼Œä»…æ·»åŠ æ–°å…ƒç´ çš„æ ·å¼ */
      .recordings-panel {
        display: none;
        margin-top: 25px;
      }

      .recordings-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-bottom: 15px;
        border-bottom: 1px solid var(--border-color);
      }

      .clear-btn {
        background: transparent;
        color: var(--text-primary);
        border: 1px solid var(--border-color);
        padding: 6px 12px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 13px;
        transition: all 0.2s;
      }

      .clear-btn:hover {
        background: rgba(var(--btn-bg-rgb), 0.1);
      }

      .recordings-list {
        max-height: 300px;
        overflow-y: auto;
        margin-top: 15px;
      }

      .recording-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 15px;
        margin-bottom: 10px;
        background: rgba(var(--border-color-rgb), 0.1);
        border-radius: 8px;
        border: 1px solid var(--border-color);
        transition: all 0.2s;
      }

      .recording-item:hover {
        background: rgba(var(--btn-bg-rgb), 0.1);
        transform: translateY(-2px);
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      }

      .recording-info {
        display: flex;
        flex-direction: column;
      }

      .recording-title {
        font-weight: 500;
        margin-bottom: 5px;
      }

      .recording-meta {
        display: flex;
        font-size: 13px;
        color: #777;
      }

      .recording-meta span {
        margin-right: 15px;
      }

      .recording-controls {
        display: flex;
        gap: 8px;
      }

      .recording-btn {
        padding: 8px 12px;
        border-radius: 6px;
        border: none;
        cursor: pointer;
        font-size: 13px;
        transition: all 0.2s;
        display: flex;
        align-items: center;
      }

      .play-btn {
        background: #4a6cf7;
        color: white;
      }

      .download-btn {
        background: #34a853;
        color: white;
      }

      .download-mp4-btn {
        background: #ff9800;
        color: white;
      }

      .delete-btn {
        background: #ea4335;
        color: white;
      }

      .recording-btn i {
        margin-right: 5px;
        font-size: 14px;
      }

      .no-recordings {
        text-align: center;
        padding: 30px;
        color: #777;
        border: 1px dashed var(--border-color);
        border-radius: 8px;
      }

      /* è§†é¢‘å¼¹æ¡†æ ·å¼ */
      .video-modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.8);
        justify-content: center;
        align-items: center;
      }

      .video-modal-content {
        position: relative;
        background-color: var(--card-bg);
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3);
        max-width: 90%;
        max-height: 90vh;
        display: flex;
        flex-direction: column;
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
      }

      .modal-title {
        font-weight: 600;
        font-size: 20px;
        color: var(--text-primary);
      }

      .close-modal {
        background: none;
        border: none;
        font-size: 28px;
        cursor: pointer;
        color: var(--text-primary);
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: background-color 0.2s;
      }

      .close-modal:hover {
        background-color: rgba(var(--btn-bg-rgb), 0.1);
      }

      .modal-video-container {
        position: relative;
        width: 800px;
        max-width: 80vw;
        height: 0;
        padding-bottom: 56.25%;
        /* 16:9 aspect ratio */
      }

      .modal-video {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        border-radius: 8px;
      }

      .modal-info {
        margin-top: 15px;
        color: var(--text-primary);
        font-size: 14px;
      }

      /* åŠ è½½æŒ‡ç¤ºå™¨ */
      .loading-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        z-index: 2000;
        justify-content: center;
        align-items: center;
        flex-direction: column;
        color: white;
        font-size: 18px;
      }

      .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top: 4px solid #fff;
        animation: spin 1s linear infinite;
        margin-bottom: 15px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }

        100% {
          transform: rotate(360deg);
        }
      }

      /* ç®€çº¦å±‚å é£æ ¼CSSå˜é‡ */
      :root {
        --bg-primary: #f8fafc;
        --bg-secondary: #ffffff;
        --text-primary: #1a202c;
        --text-secondary: #64748b;
        --btn-bg: #3b82f6;
        --btn-hover-bg: #2563eb;
        --btn-text: white;
        --border-color: #e2e8f0;
        --card-bg: #ffffff;
        --card-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        --btn-bg-rgb: 59, 130, 246;
        --border-color-rgb: 226, 232, 240;
        --accent-color: #10b981;
        --warning-color: #f59e0b;
        --danger-color: #ef4444;
        --layer-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
          0 2px 4px -1px rgba(0, 0, 0, 0.06);
        --layer-shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1),
          0 4px 6px -2px rgba(0, 0, 0, 0.05);
      }

      .dark-theme {
        --bg-primary: #0f172a;
        --bg-secondary: #1e293b;
        --text-primary: #f1f5f9;
        --text-secondary: #94a3b8;
        --btn-bg: #3b82f6;
        --btn-hover-bg: #2563eb;
        --border-color: #334155;
        --card-bg: #1e293b;
        --card-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        --border-color-rgb: 51, 65, 85;
        --layer-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3),
          0 2px 4px -1px rgba(0, 0, 0, 0.2);
        --layer-shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.3),
          0 4px 6px -2px rgba(0, 0, 0, 0.2);
      }

      body {
        background: var(--bg-primary);
        color: var(--text-primary);
        font-family: 'Inter', 'Segoe UI', system-ui, -apple-system, sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 24px;
        transition: all 0.3s ease;
        line-height: 1.6;
        min-height: 100vh;
      }

      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 32px;
        padding: 24px 32px;
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        box-shadow: var(--layer-shadow);
        position: relative;
        z-index: 10;
      }

      h1 {
        margin: 0;
        font-size: 24px;
        font-weight: 600;
        color: var(--text-primary);
      }

      .theme-toggle {
        background: var(--btn-bg);
        color: var(--btn-text);
        border: none;
        padding: 10px 16px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.2s ease;
        box-shadow: var(--card-shadow);
      }

      .theme-toggle:hover {
        background: var(--btn-hover-bg);
        transform: translateY(-1px);
        box-shadow: var(--layer-shadow);
      }

      .card {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 24px;
        margin: 20px 0;
        box-shadow: var(--card-shadow);
        transition: all 0.2s ease;
        position: relative;
      }

      .card:hover {
        transform: translateY(-2px);
        box-shadow: var(--layer-shadow-lg);
      }

      .card:nth-child(even) {
        transform: translateX(8px);
      }

      .card:nth-child(odd) {
        transform: translateX(-8px);
      }

      .card:nth-child(even):hover {
        transform: translateX(8px) translateY(-2px);
      }

      .card:nth-child(odd):hover {
        transform: translateX(-8px) translateY(-2px);
      }

      .card-title {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
      }

      .card-title i {
        margin-right: 10px;
        font-size: 20px;
      }

      #videoPreview {
        width: 100%;
        background: #000;
        border-radius: 8px;
        margin-top: 10px;
        display: none;
      }

      .controls {
        display: flex;
        gap: 12px;
        margin: 20px 0;
        flex-wrap: wrap;
      }

      .btn {
        background: var(--btn-bg);
        color: var(--btn-text);
        border: none;
        padding: 12px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.2s ease;
        flex: 1;
        min-width: 120px;
        text-align: center;
        display: flex;
        justify-content: center;
        align-items: center;
        box-shadow: var(--card-shadow);
      }

      .btn:hover:not(:disabled) {
        background: var(--btn-hover-bg);
        transform: translateY(-1px);
        box-shadow: var(--layer-shadow);
      }

      .btn i {
        margin-right: 8px;
        font-size: 16px;
      }

      .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
        box-shadow: var(--card-shadow);
      }

      #recordedVideo {
        width: 100%;
        border-radius: 8px;
        background: #000;
        display: none;
        margin-top: 20px;
      }

      .status {
        margin-top: 16px;
        padding: 12px 16px;
        border-radius: 8px;
        text-align: center;
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        font-size: 14px;
        color: var(--text-secondary);
      }

      .row {
        display: flex;
        gap: 24px;
        position: relative;
      }

      .col {
        flex: 1;
        position: relative;
      }

      .col:first-child {
        z-index: 2;
      }

      .col:last-child {
        z-index: 1;
      }

      .recorded-video-container {
        display: none;
      }

      .preview-container {
        position: relative;
      }

      .recording-indicator {
        position: absolute;
        top: 16px;
        right: 16px;
        background: var(--danger-color);
        color: white;
        padding: 6px 12px;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 500;
        display: none;
        animation: pulse 1.5s infinite;
        box-shadow: var(--card-shadow);
      }

      @keyframes pulse {
        0% {
          opacity: 1;
        }

        50% {
          opacity: 0.7;
        }

        100% {
          opacity: 1;
        }
      }

      .icon {
        display: inline-block;
        width: 20px;
        height: 20px;
        background-size: contain;
        margin-right: 8px;
        vertical-align: middle;
      }

      .record-icon {
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='white'%3E%3Cpath d='M12 2C6.48 E 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8z'/%3E%3Ccircle cx='12' cy='12' r='5' fill='red'/%3E%3C/svg%3E");
      }

      .stop-icon {
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='white'%3E%3Crect x='6' y='6' width='12' height='12' rx='1' fill='white'/%3E%3C/svg%3E");
      }

      .download-icon {
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='white'%3E%3Cpath d='M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z'/%3E%3C/svg%3E");
      }

      .play-icon {
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='white'%3E%3Cpath d='M8 5v14l11-7z'/%3E%3C/svg%3E");
      }

      /* æµ®åŠ¨æŒ‰é’®å®¹å™¨ */
      .fab-container {
        position: fixed;
        bottom: 30px;
        right: 30px;
        z-index: 1000;
        display: flex;
        flex-direction: column-reverse;
        align-items: flex-end;
        gap: 15px;
      }

      /* ä¸»æŒ‰é’®æ ·å¼ */
      .fab-main {
        width: 56px;
        height: 56px;
        border-radius: 50%;
        background: var(--btn-bg);
        color: var(--btn-text);
        border: none;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
      }

      .fab-main:hover {
        background: var(--btn-hover-bg);
        transform: scale(1.05);
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
      }

      /* èœå•å®¹å™¨ */
      .fab-menu {
        display: flex;
        flex-direction: column;
        gap: 12px;
        opacity: 0;
        transform: translateY(20px);
        pointer-events: none;
        transition: all 0.3s ease;
      }

      .fab-container.active .fab-menu {
        opacity: 1;
        transform: translateY(0);
        pointer-events: all;
      }

      /* å­èœå•é¡¹ */
      .fab-item {
        width: 56px;
        height: 56px;
        border-radius: 50%;
        background: var(--card-bg);
        color: var(--text-primary);
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        transition: all 0.2s ease;
        position: relative;
      }

      .fab-item:hover {
        transform: translateY(-3px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }

      .fab-item::after {
        content: attr(title);
        position: absolute;
        right: 50px;
        white-space: nowrap;
        background: var(--card-bg);
        color: var(--text-primary);
        padding: 6px 12px;
        border-radius: 4px;
        font-size: 13px;
        opacity: 0;
        pointer-events: none;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        transition: opacity 0.2s ease;
      }

      .fab-item:hover::after {
        opacity: 1;
      }

      /* æˆæƒå¼¹æ¡†æ ·å¼ */
      .auth-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(10px);
        z-index: 2000;
        justify-content: center;
        align-items: center;
        animation: fadeIn 0.3s ease;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      @keyframes slideUp {
        from {
          opacity: 0;
          transform: translateY(30px) scale(0.95);
        }
        to {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }

      .auth-modal-content {
        background: var(--glass-bg);
        backdrop-filter: blur(20px);
        border: 1px solid var(--glass-border);
        border-radius: 25px;
        padding: 40px;
        max-width: 450px;
        width: 90%;
        text-align: center;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        animation: slideUp 0.3s ease;
        position: relative;
        overflow: hidden;
      }

      .auth-modal-content::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 1px;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.4),
          transparent
        );
      }

      .auth-step-indicator {
        display: flex;
        justify-content: center;
        margin-bottom: 30px;
        gap: 15px;
      }

      .step-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: var(--border-color);
        transition: all 0.3s ease;
      }

      .step-dot.active {
        background: var(--accent-color);
        transform: scale(1.2);
        box-shadow: 0 0 20px rgba(16, 185, 129, 0.4);
      }

      .auth-icon {
        width: 80px;
        height: 80px;
        margin: 0 auto 25px;
        background: var(--accent-color);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 10px 30px rgba(16, 185, 129, 0.3);
      }

      .auth-icon svg {
        width: 40px;
        height: 40px;
        color: white;
      }

      .auth-title {
        font-size: 24px;
        font-weight: 700;
        margin-bottom: 15px;
        color: #fff;
      }

      .auth-description {
        font-size: 16px;
        color: var(--text-secondary);
        margin-bottom: 30px;
        line-height: 1.6;
      }

      .auth-buttons {
        display: flex;
        gap: 15px;
        justify-content: center;
      }

      .auth-btn {
        padding: 14px 28px;
        border: none;
        border-radius: 15px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        min-width: 120px;
        position: relative;
        overflow: hidden;
      }

      .auth-btn-primary {
        background: var(--accent-color);
        color: white;
        box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
      }

      .auth-btn-primary:hover {
        background: #059669;
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
      }

      .auth-btn-secondary {
        background: transparent;
        color: var(--text-secondary);
        border: 2px solid var(--border-color);
      }

      .auth-btn-secondary:hover {
        background: var(--glass-bg);
        color: var(--text-primary);
        border-color: var(--text-secondary);
        transform: translateY(-2px);
      }

      /* éº¦å…‹é£å’Œå±å¹•å›¾æ ‡ */
      .mic-icon {
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='white'%3E%3Cpath d='M12 2a3 3 0 0 1 3 3v6a3 3 0 0 1-6 0V5a3 3 0 0 1 3-3z'/%3E%3Cpath d='M19 10v1a7 7 0 0 1-14 0v-1'/%3E%3Cpath d='M12 18v4'/%3E%3Cpath d='M8 22h8'/%3E%3C/svg%3E");
      }

      .screen-icon {
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='white'%3E%3Crect x='2' y='3' width='20' height='14' rx='2' ry='2'/%3E%3Cline x1='8' y1='21' x2='16' y2='21'/%3E%3Cline x1='12' y1='17' x2='12' y2='21'/%3E%3C/svg%3E");
      }

      /* macOSæƒé™è¯´æ˜æ ·å¼ */
      .macos-permission-notice {
        background: linear-gradient(135deg, rgba(255, 149, 0, 0.1), rgba(255, 59, 48, 0.1));
        border: 1px solid rgba(255, 149, 0, 0.3);
        border-radius: 12px;
        padding: 20px;
        margin: 20px 0;
        animation: fadeInUp 0.5s ease-out;
      }

      .notice-header {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 15px;
        color: #ff9500;
        font-weight: 600;
      }

      .apple-icon {
        font-size: 20px;
        filter: drop-shadow(0 2px 4px rgba(255, 149, 0, 0.3));
      }

      .notice-content {
        color: var(--text-secondary);
        line-height: 1.6;
      }

      .notice-content p {
        margin: 10px 0;
      }

      .notice-content ol {
        margin: 15px 0;
        padding-left: 20px;
      }

      .notice-content li {
        margin: 8px 0;
        color: var(--text-primary);
      }

      .notice-content strong {
        color: #ff9500;
        font-weight: 600;
      }

      .notice-tip {
        background: rgba(255, 149, 0, 0.1);
        border-left: 3px solid #ff9500;
        padding: 10px 15px;
        margin: 15px 0 5px 0;
        border-radius: 0 8px 8px 0;
        font-size: 14px;
        color: var(--text-primary);
      }

      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
    </style>
  </head>

  <body>
    <div class="fab-container">
      <button class="fab-main" id="fabMain">
        <svg
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path d="M12 5V19M5 12H19" stroke="currentColor" stroke-width="2" />
        </svg>
      </button>

      <div class="fab-menu">
        <a
          href="https://tinypng.com/"
          class="fab-item"
          target="_blank"
          title="å›¾ç‰‡å‹ç¼©"
        >
          <svg
            width="24"
            height="24"
            viewBox="0 0 48 48"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              d="M10 38V44H38V38"
              stroke="#333"
              stroke-width="4"
              stroke-linecap="round"
              stroke-linejoin="round"
            />
            <path
              d="M38 20V14L30 4H10V20"
              stroke="#333"
              stroke-width="4"
              stroke-linecap="round"
              stroke-linejoin="round"
            />
            <path
              d="M28 4V14H38"
              stroke="#333"
              stroke-width="4"
              stroke-linecap="round"
              stroke-linejoin="round"
            />
            <path
              d="M16 12H20"
              stroke="#333"
              stroke-width="4"
              stroke-linecap="round"
            />
            <rect
              x="4"
              y="20"
              width="40"
              height="18"
              rx="2"
              stroke="#333"
              stroke-width="4"
              stroke-linejoin="round"
            />
            <path
              d="M11 25H17L11 33H17"
              stroke="#333"
              stroke-width="4"
              stroke-linecap="round"
              stroke-linejoin="round"
            />
            <path
              d="M24 25V33"
              stroke="#333"
              stroke-width="4"
              stroke-linecap="round"
            />
            <path
              d="M31 25V33"
              stroke="#333"
              stroke-width="4"
              stroke-linecap="round"
            />
            <path
              d="M31 25H34.5C35.8807 25 37 26.1193 37 27.5V27.5C37 28.8807 35.8807 30 34.5 30H31"
              stroke="#333"
              stroke-width="4"
              stroke-linecap="round"
              stroke-linejoin="round"
            />
          </svg>
        </a>
        <a
          href="https://open.996day.com/imgFormat.html"
          target="_blank"
          class="fab-item"
          title="å›¾ç‰‡è½¬æ¢"
        >
          <svg
            width="24"
            height="24"
            viewBox="0 0 48 48"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
          >
            <rect
              x="6"
              y="22"
              width="20"
              height="20"
              rx="3"
              stroke="#333"
              stroke-width="4"
              stroke-linejoin="round"
            />
            <path
              d="M30 6L42 6L42 18"
              stroke="#333"
              stroke-width="4"
              stroke-linecap="round"
              stroke-linejoin="round"
            />
            <circle cx="34" cy="42" r="1.5" fill="#333" stroke="#333" />
            <circle
              r="1.5"
              transform="matrix(1 0 0 -1 6 14)"
              fill="#333"
              stroke="#333"
            />
            <circle cx="42" cy="42" r="1.5" fill="#333" stroke="#333" />
            <circle
              r="1.5"
              transform="matrix(1 0 0 -1 6 6)"
              fill="#333"
              stroke="#333"
            />
            <circle cx="42" cy="34" r="1.5" fill="#333" stroke="#333" />
            <circle
              r="1.5"
              transform="matrix(1 0 0 -1 14 6)"
              fill="#333"
              stroke="#333"
            />
            <circle cx="42" cy="26" r="1.5" fill="#333" stroke="#333" />
            <circle
              r="1.5"
              transform="matrix(1 0 0 -1 22 6)"
              fill="#333"
              stroke="#333"
            />
            <path
              d="M6 34L12.1195 29.4103C13.2239 28.5821 14.7509 28.6143 15.8192 29.4885L25 37"
              stroke="#333"
              stroke-width="4"
              stroke-linecap="round"
              stroke-linejoin="round"
            />
            <path
              d="M42 6L30 18"
              stroke="#333"
              stroke-width="4"
              stroke-linecap="round"
              stroke-linejoin="round"
            />
          </svg>
        </a>
        <a
          href="https://open.996day.com/jj.html"
          target="_blank"
          class="fab-item"
          title="éŸ³è§†é¢‘å‰ªè¾‘"
        >
          <svg
            width="24"
            height="24"
            viewBox="0 0 48 48"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path d="M43 9V17V31V39H34V31H43V17H34V9H43Z" fill="none" />
            <path d="M5 17V9H14V17H5V31H14V39H5V31V17Z" fill="none" />
            <path
              d="M43 17V9H34M43 17V31M43 17H34M5 17V9H14M5 17V31M5 17H14M5 31V39H14M5 31H14M43 31V39H34M43 31H34M34 9V17M34 9H30M34 39V31M34 39H30M14 9V17M14 9H18M14 39V31M14 39H18M14 17H18M34 17H30M34 31H30M14 31H18"
              stroke="#333"
              stroke-width="4"
              stroke-linecap="round"
              stroke-linejoin="round"
            />
            <path
              d="M24 7V11"
              stroke="#333"
              stroke-width="4"
              stroke-linecap="round"
            />
            <path
              d="M24 17V21"
              stroke="#333"
              stroke-width="4"
              stroke-linecap="round"
            />
            <path
              d="M24 27V31"
              stroke="#333"
              stroke-width="4"
              stroke-linecap="round"
            />
            <path
              d="M24 37V41"
              stroke="#333"
              stroke-width="4"
              stroke-linecap="round"
            />
          </svg>
        </a>
        <a
          href="https://open.996day.com/format.html"
          target="_blank"
          class="fab-item"
          title="éŸ³è§†é¢‘è½¬æ¢"
        >
          <svg
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              d="M16 12L20 8M20 8L16 4M20 8H9M8 12L4 16M4 16L8 20M4 16H15"
              stroke="currentColor"
              stroke-width="2"
            />
          </svg>
        </a>
        <a
          href="https://open.996day.com/merge.html"
          target="_blank"
          class="fab-item"
          title="éŸ³è§†é¢‘åˆå¹¶"
        >
          <svg
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              d="M8 12H12M16 12H12M12 12V8M12 12V16M3 9V15C3 16.6569 4.34315 18 6 18H18C19.6569 18 21 16.6569 21 15V9C21 7.34315 19.6569 6 18 6H6C4.34315 6 3 7.34315 3 9Z"
              stroke="currentColor"
              stroke-width="2"
            />
          </svg>
        </a>
      </div>
    </div>
    <div class="header">
      <h1>å±å¹•å½•åˆ¶å·¥å…·(ç§»åŠ¨ç«¯å—æƒé™é™åˆ¶,æ— æ³•æ”¯æŒ,è¯·è°…è§£)</h1>
      <button id="themeToggle" class="theme-toggle">æ·±è‰²æ¨¡å¼</button>
    </div>

    <div class="row">
      <div class="col">
        <div class="card preview-container">
          <div class="card-title"><i>ğŸ”´</i> é¢„è§ˆä¸å½•åˆ¶</div>
          <div class="recording-indicator">å½•åˆ¶ä¸­...</div>
          <video id="videoPreview" controls autoplay playsinline muted></video>

          <div class="controls">
            <button id="startBtn" class="btn">
              <span class="icon record-icon"></span>å¼€å§‹å½•åˆ¶
            </button>
            <button id="stopBtn" class="btn" disabled>
              <span class="icon stop-icon"></span>åœæ­¢å½•åˆ¶
            </button>
          </div>

          <div id="status" class="status">å‡†å¤‡å½•åˆ¶å±å¹•å†…å®¹...</div>
        </div>
      </div>

      <div class="col">
        <div class="card recorded-video-container" id="recordedContainer">
          <div class="card-title"><i>ğŸ¬</i> å·²å½•åˆ¶çš„è§†é¢‘</div>
          <video id="recordedVideo" controls></video>

          <div class="controls">
            <button id="playBtn" class="btn">
              <span class="icon play-icon"></span>æ’­æ”¾è§†é¢‘
            </button>
            <button id="downloadWebmBtn" class="btn">
              <span class="icon download-icon"></span>ä¸‹è½½WebM
            </button>
            <!-- æ·»åŠ ä¸‹è½½ä¸ºMP4çš„æŒ‰é’® -->
            <button id="downloadMp4Btn" class="btn download-mp4-btn">
              <span class="icon download-icon"></span>ä¸‹è½½MP4
            </button>
          </div>

          <div id="infoText" class="status" style="margin-top: 15px">
            å½•åˆ¶å·²å®Œæˆï¼Œå¯ä»¥æ’­æ”¾æˆ–ä¸‹è½½è§†é¢‘æ–‡ä»¶
          </div>
        </div>
      </div>
    </div>

    <!-- æ·»åŠ å½•åˆ¶è®°å½•é¢æ¿ -->
    <div class="recordings-panel" id="recordingsPanel">
      <div class="recordings-header">
        <div class="card-title">
          <i>ğŸ“¼</i>
          å½•åˆ¶è®°å½•(ç¬¬ä¸€æ¬¡MP4ä¸‹è½½éœ€è¦åŠ è½½ä¾èµ–åŒ…,è¯·ä¼˜å…ˆä¸‹è½½webmåˆ°æœ¬åœ°,é˜²æ­¢ä¸¢å¤±)
        </div>
        <button id="clearBtn" class="clear-btn">æ¸…é™¤æ‰€æœ‰è®°å½•</button>
      </div>

      <div class="recordings-list" id="recordingsList">
        <div class="no-recordings">æš‚æ— å½•åˆ¶è®°å½•</div>
      </div>
    </div>

    <!-- è§†é¢‘æ’­æ”¾å¼¹æ¡† -->
    <div class="video-modal" id="videoModal">
      <div class="video-modal-content">
        <div class="modal-header">
          <h3 class="modal-title" id="modalVideoTitle">æ’­æ”¾å½•åˆ¶è§†é¢‘</h3>
          <button class="close-modal" id="closeModal">&times;</button>
        </div>
        <div class="modal-video-container">
          <video class="modal-video" id="modalVideo" controls></video>
        </div>
        <div class="modal-info" id="modalVideoInfo"></div>
      </div>
    </div>

    <!-- åŠ è½½è¦†ç›–å±‚ -->
    <div class="loading-overlay" id="loadingOverlay">
      <div class="spinner"></div>
      <div id="loadingText">å¤„ç†ä¸­ï¼Œè¯·ç¨å€™...</div>
    </div>

    <!-- æˆæƒå¼¹æ¡† -->
    <div id="authModal" class="auth-modal">
      <div class="auth-modal-content">
        <!-- æ­¥éª¤æŒ‡ç¤ºå™¨ -->
        <div class="auth-step-indicator">
          <div class="step-dot active" id="step1Dot"></div>
          <div class="step-dot" id="step2Dot"></div>
        </div>

        <!-- æˆæƒå†…å®¹ -->
        <div id="authContent">
          <!-- éº¦å…‹é£æˆæƒæ­¥éª¤ -->
          <div id="micAuthStep">
            <div class="auth-icon">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 24 24"
                fill="currentColor"
              >
                <path
                  d="M12 2a3 3 0 0 1 3 3v6a3 3 0 0 1-6 0V5a3 3 0 0 1 3-3z"
                />
                <path
                  d="M19 10v1a7 7 0 0 1-14 0v-1"
                  stroke="currentColor"
                  stroke-width="2"
                  fill="none"
                />
                <path d="M12 18v4" stroke="currentColor" stroke-width="2" />
                <path d="M8 22h8" stroke="currentColor" stroke-width="2" />
              </svg>
            </div>
            <h3 class="auth-title">éº¦å…‹é£æƒé™</h3>
            <p class="auth-description">
              ä¸ºäº†å½•åˆ¶éŸ³é¢‘ï¼Œæˆ‘ä»¬éœ€è¦è®¿é—®æ‚¨çš„éº¦å…‹é£ã€‚è¯·åœ¨æµè§ˆå™¨å¼¹å‡ºçš„æƒé™è¯·æ±‚ä¸­ç‚¹å‡»"å…è®¸"ã€‚
            </p>
            
            <!-- macOSæƒé™è¯´æ˜ -->
            <div class="macos-permission-notice" id="macosNotice" style="display: none;">
              <div class="notice-header">
                <span class="apple-icon">ğŸ</span>
                <strong>macOSç”¨æˆ·æ³¨æ„</strong>
              </div>
              <div class="notice-content">
                <p>å¦‚æœæµè§ˆå™¨æƒé™è¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç³»ç»Ÿè®¾ç½®ï¼š</p>
                <ol>
                  <li>æ‰“å¼€ <strong>ç³»ç»Ÿåå¥½è®¾ç½®</strong> â†’ <strong>å®‰å…¨æ€§ä¸éšç§</strong></li>
                  <li>ç‚¹å‡» <strong>éšç§</strong> æ ‡ç­¾é¡µ</li>
                  <li>åœ¨å·¦ä¾§åˆ—è¡¨ä¸­é€‰æ‹© <strong>éº¦å…‹é£</strong></li>
                  <li>ç¡®ä¿æ‚¨çš„æµè§ˆå™¨ï¼ˆSafari/Chrome/Firefoxç­‰ï¼‰å·²å‹¾é€‰</li>
                  <li>å¦‚æœæ²¡æœ‰å‹¾é€‰ï¼Œè¯·ç‚¹å‡»å·¦ä¸‹è§’é”å›¾æ ‡è§£é”åå‹¾é€‰</li>
                </ol>
                <p class="notice-tip">ğŸ’¡ è®¾ç½®å®Œæˆåï¼Œè¯·åˆ·æ–°é¡µé¢é‡æ–°å°è¯•æˆæƒ</p>
              </div>
            </div>
            <div class="auth-buttons">
              <button class="auth-btn auth-btn-secondary" id="cancelAuth">
                å–æ¶ˆ
              </button>
              <button class="auth-btn auth-btn-secondary" id="skipMicAuth">
                è·³è¿‡
              </button>
              <button class="auth-btn auth-btn-primary" id="requestMicAuth">
                æˆæƒéº¦å…‹é£
              </button>
            </div>
          </div>

          <!-- å±å¹•æˆæƒæ­¥éª¤ -->
          <div id="screenAuthStep" style="display: none">
            <div class="auth-icon">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 24 24"
                fill="currentColor"
              >
                <rect x="2" y="3" width="20" height="14" rx="2" ry="2" />
                <line
                  x1="8"
                  y1="21"
                  x2="16"
                  y2="21"
                  stroke="currentColor"
                  stroke-width="2"
                />
                <line
                  x1="12"
                  y1="17"
                  x2="12"
                  y2="21"
                  stroke="currentColor"
                  stroke-width="2"
                />
              </svg>
            </div>
            <h3 class="auth-title">å±å¹•å…±äº«æƒé™</h3>
            <p class="auth-description">
              ç°åœ¨éœ€è¦é€‰æ‹©è¦å½•åˆ¶çš„å±å¹•æˆ–çª—å£ã€‚è¯·åœ¨æ¥ä¸‹æ¥çš„å¯¹è¯æ¡†ä¸­é€‰æ‹©æ‚¨è¦å½•åˆ¶çš„å†…å®¹ã€‚
            </p>
            <div class="auth-buttons">
              <button class="auth-btn auth-btn-secondary" id="backToMic">
                è¿”å›
              </button>
              <button class="auth-btn auth-btn-primary" id="requestScreenAuth">
                é€‰æ‹©å±å¹•
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // é¡µé¢å…ƒç´ 
      const videoPreview = document.getElementById('videoPreview')
      const recordedVideo = document.getElementById('recordedVideo')
      const startBtn = document.getElementById('startBtn')
      const stopBtn = document.getElementById('stopBtn')
      const playBtn = document.getElementById('playBtn')
      const downloadWebmBtn = document.getElementById('downloadWebmBtn')
      const downloadMp4Btn = document.getElementById('downloadMp4Btn')
      const themeToggle = document.getElementById('themeToggle')
      const statusDisplay = document.getElementById('status')
      const recordingIndicator = document.querySelector('.recording-indicator')
      const recordedContainer = document.getElementById('recordedContainer')
      const infoText = document.getElementById('infoText')
      const recordingsPanel = document.getElementById('recordingsPanel')
      const recordingsList = document.getElementById('recordingsList')
      const clearBtn = document.getElementById('clearBtn')
      const videoModal = document.getElementById('videoModal')
      const modalVideo = document.getElementById('modalVideo')
      const modalVideoTitle = document.getElementById('modalVideoTitle')
      const modalVideoInfo = document.getElementById('modalVideoInfo')
      const closeModal = document.getElementById('closeModal')
      const loadingOverlay = document.getElementById('loadingOverlay')
      const loadingText = document.getElementById('loadingText')

      // æˆæƒå¼¹æ¡†å…ƒç´ 
      const authModal = document.getElementById('authModal')
      const micAuthStep = document.getElementById('micAuthStep')
      const screenAuthStep = document.getElementById('screenAuthStep')
      const step1Dot = document.getElementById('step1Dot')
      const step2Dot = document.getElementById('step2Dot')
      const requestMicAuth = document.getElementById('requestMicAuth')
      const requestScreenAuth = document.getElementById('requestScreenAuth')
      const cancelAuth = document.getElementById('cancelAuth')
      const backToMic = document.getElementById('backToMic')
      const skipMicAuth = document.getElementById('skipMicAuth')

      // çŠ¶æ€å˜é‡
      let recorder
      let recordedBlob
      let screenStream = null
      let micStream = null
      let audioCtx = null
      let combinedStream = null
      let currentRecordedUrl
      let isDarkMode = false
      let recordings = JSON.parse(
        localStorage.getItem('screenRecordings') || '[]'
      )
      let ffmpeg = null // æ·»åŠ ffmpegå®ä¾‹
      const { createFFmpeg, fetchFile } = FFmpeg

      // æˆæƒçŠ¶æ€
      const authState = {
        micAuthorized: false,
        screenAuthorized: false,
      }

      // æ£€æµ‹æ“ä½œç³»ç»Ÿ
      const isMacOS = /Mac|iPhone|iPod|iPad/i.test(navigator.userAgent)
      const macosNotice = document.getElementById('macosNotice')

      async function toBlobURL(url, mimeType) {
        const res = await fetch(url)
        const blob = await res.blob()
        return URL.createObjectURL(blob)
      }
      // åˆå§‹åŒ–FFmpeg
      async function initFFmpeg() {
        if (!ffmpeg) {
          loadingText.textContent = 'æ­£åœ¨åŠ è½½FFmpegï¼Œè¯·ç¨å€™...'
          try {
            showLoading(true)

            ffmpeg = createFFmpeg({
              log: true,
              wasmURL: await toBlobURL(
                './ffmpeg-core.wasm',
                'application/wasm'
              ),
            })
            await ffmpeg.load()

            return ffmpeg
          } catch (error) {
            console.error('FFmpegåŠ è½½å¤±è´¥:', error)
            statusDisplay.textContent = 'FFmpegåŠ è½½å¤±è´¥: ' + error.message
          } finally {
            showLoading(false)
          }
        }
      }

      // æ˜¾ç¤º/éšè—åŠ è½½å±‚
      function showLoading(show) {
        loadingOverlay.style.display = show ? 'flex' : 'none'
      }

      // æˆæƒå¼¹æ¡†æ§åˆ¶å‡½æ•°
      function showAuthModal() {
        authModal.style.display = 'flex'
        showMicAuthStep()
      }

      function hideAuthModal() {
        authModal.style.display = 'none'
      }

      function showMicAuthStep() {
        micAuthStep.style.display = 'block'
        screenAuthStep.style.display = 'none'
        step1Dot.classList.add('active')
        step2Dot.classList.remove('active')
        
        // å¦‚æœæ˜¯macOSç³»ç»Ÿï¼Œæ˜¾ç¤ºæƒé™è¯´æ˜
        if (isMacOS && macosNotice) {
          macosNotice.style.display = 'block'
        }
      }

      function showScreenAuthStep() {
        micAuthStep.style.display = 'none'
        screenAuthStep.style.display = 'block'
        step1Dot.classList.remove('active')
        step2Dot.classList.add('active')
      }

      // æ›´æ–°æŒ‰é’®çŠ¶æ€
      function updateButtonStates() {
        const canStart = authState.screenAuthorized

        if (canStart) {
          const audioStatus = authState.micAuthorized ? '(å«éº¦å…‹é£)' : '(ä»…å±å¹•)'
          statusDisplay.textContent = `å‡†å¤‡å°±ç»ªï¼Œå¯ä»¥å¼€å§‹å½•åˆ¶${audioStatus}`
        } else {
          statusDisplay.textContent = 'éœ€è¦æˆæƒ: å±å¹•å…±äº«'
        }
      }

      // åˆå§‹åŒ–è®°å½•æ˜¾ç¤º
      updateRecordingsList()

      // ä¸»é¢˜åˆ‡æ¢åŠŸèƒ½
      themeToggle.addEventListener('click', () => {
        isDarkMode = !isDarkMode
        document.body.classList.toggle('dark-theme', isDarkMode)
        themeToggle.textContent = isDarkMode ? 'æµ…è‰²æ¨¡å¼' : 'æ·±è‰²æ¨¡å¼'
      })

      // æ¸…é™¤æ‰€æœ‰è®°å½•
      clearBtn.addEventListener('click', () => {
        if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰å½•åˆ¶è®°å½•å—ï¼Ÿè¯¥æ“ä½œä¸å¯æ’¤é”€ï¼')) {
          // é‡Šæ”¾æ‰€æœ‰Blob URL
          recordings.forEach((recording) => {
            URL.revokeObjectURL(recording.url)
          })

          recordings = []
          localStorage.removeItem('screenRecordings')
          updateRecordingsList()
          showPanel(false)
        }
      })

      // å…³é—­å¼¹æ¡†
      closeModal.addEventListener('click', () => {
        closeVideoModal()
      })

      // ç‚¹å‡»å¼¹æ¡†å¤–éƒ¨åŒºåŸŸå…³é—­
      videoModal.addEventListener('click', (e) => {
        if (e.target === videoModal) {
          closeVideoModal()
        }
      })

      // æˆæƒå¼¹æ¡†äº‹ä»¶ç›‘å¬å™¨
      cancelAuth.addEventListener('click', () => {
        hideAuthModal()
      })

      backToMic.addEventListener('click', () => {
        showMicAuthStep()
      })

      requestMicAuth.addEventListener('click', async () => {
        try {
          statusDisplay.textContent = 'æ­£åœ¨è¯·æ±‚éº¦å…‹é£æƒé™...'
          micStream = await navigator.mediaDevices.getUserMedia({
            audio: {
              echoCancellation: true,
              noiseSuppression: true,
            },
          })
          authState.micAuthorized = true
          showScreenAuthStep()
          statusDisplay.textContent = 'éº¦å…‹é£æˆæƒæˆåŠŸï¼Œè¯·ç»§ç»­æˆæƒå±å¹•å…±äº«'
        } catch (error) {
          console.error('éº¦å…‹é£æˆæƒå¤±è´¥:', error)
          statusDisplay.textContent = 'éº¦å…‹é£æˆæƒå¤±è´¥: ' + error.message
          
          // å¦‚æœæ˜¯macOSç³»ç»Ÿä¸”æˆæƒå¤±è´¥ï¼Œæ˜¾ç¤ºæƒé™è¯´æ˜
          if (isMacOS && macosNotice) {
            macosNotice.style.display = 'block'
          }
        }
      })

      skipMicAuth.addEventListener('click', () => {
        authState.micAuthorized = false
        micStream = null
        showScreenAuthStep()
        statusDisplay.textContent = 'å·²è·³è¿‡éº¦å…‹é£æˆæƒï¼Œè¯·ç»§ç»­æˆæƒå±å¹•å…±äº«'
      })

      requestScreenAuth.addEventListener('click', async () => {
        try {
          statusDisplay.textContent = 'æ­£åœ¨è¯·æ±‚å±å¹•å…±äº«æƒé™...'
          screenStream = await navigator.mediaDevices.getDisplayMedia({
            video: {
              cursor: 'always',
              frameRate: { ideal: 60, max: 120 },
              width: { ideal: 3840, max: 7680 },
              height: { ideal: 2160, max: 4320 },
              aspectRatio: { ideal: 16 / 9 },
            },
            audio: {
              sampleRate: 48000,
              channelCount: 2,
              echoCancellation: false,
              noiseSuppression: false,
              autoGainControl: false,
            },
          })
          authState.screenAuthorized = true
          hideAuthModal()
          startRecord()
          updateButtonStates()
          statusDisplay.textContent = 'æ‰€æœ‰æƒé™æˆæƒå®Œæˆï¼Œå¯ä»¥å¼€å§‹å½•åˆ¶'
        } catch (error) {
          console.error('å±å¹•å…±äº«æˆæƒå¤±è´¥:', error)
          statusDisplay.textContent = 'å±å¹•å…±äº«æˆæƒå¤±è´¥: ' + error.message
        }
      })

      // ç‚¹å‡»æˆæƒå¼¹æ¡†å¤–éƒ¨åŒºåŸŸå…³é—­
      authModal.addEventListener('click', (e) => {
        if (e.target === authModal) {
          hideAuthModal()
        }
      })

      const startRecord = async () => {
        // æ£€æŸ¥æˆæƒçŠ¶æ€ - åªè¦æ±‚å±å¹•æˆæƒï¼Œéº¦å…‹é£æˆæƒå¯é€‰
        if (!authState.screenAuthorized) {
          showAuthModal()
          return
        }

        try {
          statusDisplay.textContent = 'æ­£åœ¨å‡†å¤‡å½•åˆ¶...'

          // æ£€æµ‹ç³»ç»ŸéŸ³é¢‘æ˜¯å¦å¯ç”¨
          let hasSystemAudio = false
          screenStream.getAudioTracks().forEach((track) => {
            if (track.kind === 'audio' && track.readyState === 'live') {
              hasSystemAudio = true
            }
          })

          // åˆ›å»ºéŸ³é¢‘å¤„ç†ä¸Šä¸‹æ–‡
          audioCtx = new (window.AudioContext || window.webkitAudioContext)()
          const audioDestination = audioCtx.createMediaStreamDestination()

          // æ™ºèƒ½æ··åˆç³»ç»ŸéŸ³é¢‘å’Œéº¦å…‹é£
          if (hasSystemAudio) {
            // ç³»ç»Ÿä¼´å¥å¢å¼ºå¤„ç†
            const systemSource = audioCtx.createMediaStreamSource(
              new MediaStream(screenStream.getAudioTracks())
            )
            const systemGain = audioCtx.createGain()
            systemGain.gain.value = micStream ? 1.5 : 1.0
            systemSource.connect(systemGain).connect(audioDestination)

            // å¤„ç†éº¦å…‹é£ï¼ˆå¦‚æœå·²æˆæƒï¼‰
            if (micStream && authState.micAuthorized) {
              const micSource = audioCtx.createMediaStreamSource(micStream)
              const micGain = audioCtx.createGain()
              micGain.gain.value = 1.2
              micSource.connect(micGain).connect(audioDestination)
            }
          } else {
            if (micStream && authState.micAuthorized) {
              const micSource = audioCtx.createMediaStreamSource(micStream)
              micSource.connect(audioDestination)
              statusDisplay.textContent = 'æ£€æµ‹åˆ°ç³»ç»ŸéŸ³é¢‘ä¸å¯ç”¨ï¼Œä»…å½•åˆ¶éº¦å…‹é£éŸ³é¢‘'
            } else {
              statusDisplay.textContent = 'è­¦å‘Šï¼šæ— ä»»ä½•éŸ³é¢‘æ¥æºï¼Œå°†å½•åˆ¶æ— å£°è§†é¢‘'
            }
          }

          // åˆ›å»ºæœ€ç»ˆåª’ä½“æµ
          combinedStream = new MediaStream([
            ...screenStream.getVideoTracks(),
            ...audioDestination.stream.getAudioTracks(),
          ])

          // é¢„è§ˆå’Œå½•åˆ¶
          videoPreview.style.display = 'block'
          videoPreview.srcObject = combinedStream
          recordingIndicator.style.display = 'block'
          recordedContainer.style.display = 'none'

          recorder = RecordRTC(combinedStream, {
            type: 'video',
            mimeType: 'video/webm;codecs=h264,opus',
            videoBitsPerSecond: 2_500_000,
            audioBitsPerSecond: 192_000, // æé«˜éŸ³é¢‘æ¯”ç‰¹ç‡
            disableLogs: true,
          })
          recorder.startRecording()
          startBtn.disabled = true
          stopBtn.disabled = false
          
          // æ ¹æ®å®é™…éŸ³é¢‘çŠ¶æ€æ˜¾ç¤ºå½•åˆ¶ä¿¡æ¯
          let recordingStatus = 'æ­£åœ¨å½•åˆ¶ï¼š'
          if (hasSystemAudio && micStream && authState.micAuthorized) {
            recordingStatus += 'ç³»ç»ŸéŸ³é¢‘+éº¦å…‹é£'
          } else if (hasSystemAudio) {
            recordingStatus += 'ç³»ç»ŸéŸ³é¢‘ï¼ˆæ— éº¦å…‹é£ï¼‰'
          } else if (micStream && authState.micAuthorized) {
            recordingStatus += 'éº¦å…‹é£ï¼ˆæ— ç³»ç»ŸéŸ³é¢‘ï¼‰'
          } else {
            recordingStatus += 'æ— å£°è§†é¢‘'
          }
          statusDisplay.textContent = recordingStatus

          // 8. è‡ªåŠ¨æ£€æµ‹ç³»ç»ŸéŸ³é¢‘ä¸¢å¤±
          combinedStream.getTracks().forEach(
            (t) =>
              (t.onended = () => {
                statusDisplay.textContent = 'âš ï¸ åª’ä½“è½¨é“å·²æ–­å¼€!'
                setTimeout(stopRecording, 500)
              })
          )
        } catch (err) {
          console.error('å½•åˆ¶åˆå§‹åŒ–å¤±è´¥:', err)
          statusDisplay.textContent = `é”™è¯¯: ${err.name || 'æœªçŸ¥é”™è¯¯'}`
          resetControls()
        }
      }

      startBtn.addEventListener('click', startRecord)

      // åœæ­¢å½•åˆ¶
      stopBtn.addEventListener('click', stopRecording)

      function stopRecording() {
        if (!recorder) return

        recorder.stopRecording(async () => {
          // éšè—å½•åˆ¶æŒ‡ç¤ºå™¨
          recordingIndicator.style.display = 'none'

          // è·å–å½•åˆ¶çš„Blob
          recordedBlob = recorder.getBlob()

          // åˆ›å»ºè§†é¢‘URLå¹¶è®¾ç½®ç»™æ’­æ”¾å…ƒç´ 
          currentRecordedUrl = URL.createObjectURL(recordedBlob)
          recordedVideo.src = currentRecordedUrl

          // æ›´æ–°UIçŠ¶æ€
          recordedContainer.style.display = 'block'
          infoText.textContent = `å½•åˆ¶å·²å®Œæˆï¼Œè§†é¢‘å¤§å°: ${formatFileSize(
            recordedBlob.size
          )}`
          statusDisplay.textContent = 'å½•åˆ¶å®Œæˆ!'

          // æ·»åŠ å½•åˆ¶è®°å½•
          addRecording({
            blob: recordedBlob,
            size: recordedBlob.size,
            timestamp: new Date(),
          })

          // 1. åœæ­¢combinedStream
          if (combinedStream) {
            combinedStream.getTracks().forEach((t) => t.stop())
            combinedStream = null
          }

          // 2. åœæ­¢å±å¹•æµå¹¶é‡ç½®å±å¹•æˆæƒçŠ¶æ€
          if (screenStream) {
            screenStream.getTracks().forEach((t) => t.stop())
            screenStream = null
          }
          authState.screenAuthorized = false

          // 3. åœæ­¢éº¦å…‹é£å¹¶é‡ç½®éº¦å…‹é£æˆæƒçŠ¶æ€
          if (micStream) {
            micStream.getTracks().forEach((t) => t.stop())
            micStream = null
          }
          authState.micAuthorized = false
          // 4. å…³é—­éŸ³é¢‘ä¸Šä¸‹æ–‡
          if (audioCtx) {
            await audioCtx.close()
            audioCtx = null
          }

          videoPreview.srcObject = null
          videoPreview.style.display = 'none'

          // é‡ç½®æ§åˆ¶æŒ‰é’®çŠ¶æ€
          resetControls()

          // æ›´æ–°æŒ‰é’®çŠ¶æ€
          updateButtonStates()

          // æ˜¾ç¤ºå½•åˆ¶å†å²é¢æ¿
          showPanel(true)
        })
      }

      // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
      function formatFileSize(bytes) {
        if (bytes < 1024) return bytes + ' B'
        else if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB'
        else return (bytes / 1048576).toFixed(1) + ' MB'
      }

      // æ·»åŠ å½•åˆ¶è®°å½•
      function addRecording(recordingData) {
        // ç”Ÿæˆå”¯ä¸€IDç”¨äºç®¡ç†è®°å½•
        const id = Date.now()

        // åˆ›å»ºBlob URL
        recordingData.url = URL.createObjectURL(recordingData.blob)
        recordingData.id = id
        recordingData.title = `å½•åˆ¶_${new Date(id)
          .toLocaleString()
          .replace(/[:]/g, '-')}`

        // æ·»åŠ åˆ°è®°å½•æ•°ç»„
        recordings.unshift(recordingData)

        // ä¿å­˜åˆ°localStorageï¼ˆæœ€å¤§ä¿å­˜10ä¸ªï¼‰
        if (recordings.length > 10) {
          // é‡Šæ”¾æœ€æ—§è®°å½•çš„Blob URL
          URL.revokeObjectURL(recordings[recordings.length - 1].url)
          recordings.pop() // åˆ é™¤æœ€æ—§çš„è®°å½•
        }
        localStorage.setItem('screenRecordings', JSON.stringify(recordings))

        // æ›´æ–°UI
        updateRecordingsList()
      }

      // æ›´æ–°è®°å½•åˆ—è¡¨
      function updateRecordingsList() {
        if (recordings.length === 0) {
          recordingsList.innerHTML = `<div class="no-recordings">æš‚æ— å½•åˆ¶è®°å½•</div>`
          return
        }

        recordingsList.innerHTML = ''

        recordings.forEach((recording) => {
          const formattedDate = new Date(recording.id).toLocaleString()
          const formattedSize = formatFileSize(recording.size)

          const recordingEl = document.createElement('div')
          recordingEl.className = 'recording-item'
          recordingEl.dataset.id = recording.id

          recordingEl.innerHTML = `
            <div class="recording-info">
              <div class="recording-title">${recording.title}</div>
              <div class="recording-meta">
                <span>${formattedSize}</span>
                <span>${formattedDate}</span>
              </div>
            </div>
            <div class="recording-controls">
              <button class="recording-btn play-btn">
                <i class="play-icon"></i>æ’­æ”¾
              </button>
              <button class="recording-btn download-btn">
                <i class="download-icon"></i>WebM
              </button>
              <button class="recording-btn download-mp4-btn">
                <i class="download-icon"></i>MP4
              </button>
              <button class="recording-btn delete-btn">
                <i class="delete-icon">Ã—</i>åˆ é™¤
              </button>
            </div>
          `

          // æ·»åŠ æ’­æ”¾äº‹ä»¶ - åœ¨å¼¹æ¡†ä¸­æ’­æ”¾
          recordingEl
            .querySelector('.play-btn')
            .addEventListener('click', () => {
              playRecordingInModal(recording.id)
            })

          // æ·»åŠ webmä¸‹è½½äº‹ä»¶
          recordingEl
            .querySelector('.download-btn')
            .addEventListener('click', () => {
              downloadWebm(recording.id)
            })

          // æ·»åŠ mp4ä¸‹è½½äº‹ä»¶
          recordingEl
            .querySelector('.download-mp4-btn')
            .addEventListener('click', async () => {
              await downloadRecordingAsMp4(recording.id)
            })

          // æ·»åŠ åˆ é™¤äº‹ä»¶
          recordingEl
            .querySelector('.delete-btn')
            .addEventListener('click', () => {
              deleteRecording(recording.id)
            })

          recordingsList.appendChild(recordingEl)
        })
      }

      // åœ¨å¼¹æ¡†ä¸­æ’­æ”¾è®°å½•
      function playRecordingInModal(id) {
        const recording = recordings.find((r) => r.id == id)
        if (!recording) return

        // è®¾ç½®å¼¹æ¡†å†…å®¹
        modalVideoTitle.textContent = recording.title
        modalVideoInfo.textContent = `æ–‡ä»¶å¤§å°: ${formatFileSize(
          recording.size
        )} | å½•åˆ¶æ—¶é—´: ${new Date(recording.id).toLocaleString()}`
        modalVideo.src = recording.url

        // æ‰“å¼€å¼¹æ¡†
        openVideoModal()
      }

      // æ‰“å¼€è§†é¢‘å¼¹æ¡†
      function openVideoModal() {
        videoModal.style.display = 'flex'
        // å¼€å§‹æ’­æ”¾
        setTimeout(() => {
          modalVideo.play().catch((e) => console.error('æ’­æ”¾å¤±è´¥:', e))
        }, 300)
      }

      // å…³é—­è§†é¢‘å¼¹æ¡†
      function closeVideoModal() {
        modalVideo.pause()
        videoModal.style.display = 'none'
        modalVideo.src = ''
      }

      // ä¸‹è½½æŒ‡å®šè®°å½•ä¸ºwebm
      function downloadWebm(id) {
        const recording = recordings.find((r) => r.id == id)

        if (!recording) return

        const a = document.createElement('a')
        a.href = recording.url
        a.download = `${recording.title}.webm`
        document.body.appendChild(a)
        a.click()
        document.body.removeChild(a)
      }

      // ä¸‹è½½æŒ‡å®šè®°å½•ä¸ºmp4
      async function downloadRecordingAsMp4(id) {
        const recording = recordings.find((r) => r.id == id)
        if (!recording) return

        try {
          loadingText.textContent = 'æ­£åœ¨è½¬æ¢æ ¼å¼ï¼Œè¯·ç¨å€™...'
          showLoading(true)

          await initFFmpeg()

          const { createFFmpeg, fetchFile } = FFmpeg
          // å°†Blobå†™å…¥FFmpegçš„æ–‡ä»¶ç³»ç»Ÿ
          ffmpeg.FS('writeFile', 'input.webm', await fetchFile(recording.blob))

          // è¿è¡ŒFFmpegè½¬æ¢å‘½ä»¤
          await ffmpeg.run(
            '-i',
            'input.webm',
            '-c:v',
            'copy',
            '-c:a',
            'aac',
            'output.mp4'
          )

          // è¯»å–è½¬æ¢ç»“æœ
          const data = ffmpeg.FS('readFile', 'output.mp4')
          const mp4Blob = new Blob([data.buffer], { type: 'video/mp4' })
          const mp4Url = URL.createObjectURL(mp4Blob)

          // åˆ›å»ºä¸‹è½½é“¾æ¥
          const a = document.createElement('a')
          a.href = mp4Url
          a.download = `${recording.title}.mp4`
          document.body.appendChild(a)
          a.click()
          document.body.removeChild(a)

          // æ¸…ç†èµ„æº
          setTimeout(() => {
            URL.revokeObjectURL(mp4Url)
            // æ¸…ç†FFmpegæ–‡ä»¶ç³»ç»Ÿ
            ffmpeg.FS('unlink', 'input.webm')
            ffmpeg.FS('unlink', 'output.mp4')
          }, 3000)

          statusDisplay.textContent = 'MP4æ ¼å¼è½¬æ¢å®Œæˆï¼Œæ–‡ä»¶å¼€å§‹ä¸‹è½½'
        } catch (error) {
          console.error('è½¬æ¢å¤±è´¥:', error)
          statusDisplay.textContent = `è½¬æ¢å¤±è´¥: ${error.message}`
        } finally {
          showLoading(false)
        }
      }

      // ä¸‹è½½æœ€æ–°å½•åˆ¶ä¸ºMP4
      downloadMp4Btn.addEventListener('click', async () => {
        if (!recordedBlob) return

        try {
          loadingText.textContent = 'æ­£åœ¨è½¬æ¢æ ¼å¼ï¼Œè¯·ç¨å€™...'
          showLoading(true)
          const { createFFmpeg, fetchFile } = FFmpeg

          await initFFmpeg()

          // å°†Blobå†™å…¥FFmpegçš„æ–‡ä»¶ç³»ç»Ÿ
          ffmpeg.FS('writeFile', 'input.webm', await fetchFile(recordedBlob))

          // è¿è¡ŒFFmpegè½¬æ¢å‘½ä»¤
          await ffmpeg.run(
            '-i',
            'input.webm',
            '-c:v',
            'copy',
            '-c:a',
            'aac',
            'output.mp4'
          )

          // è¯»å–è½¬æ¢ç»“æœ
          const data = ffmpeg.FS('readFile', 'output.mp4')
          const mp4Blob = new Blob([data.buffer], { type: 'video/mp4' })
          const mp4Url = URL.createObjectURL(mp4Blob)
          const fileName = `å½•åˆ¶_${new Date()
            .toISOString()
            .replace(/[:.]/g, '-')}.mp4`

          // åˆ›å»ºä¸‹è½½é“¾æ¥
          const a = document.createElement('a')
          a.href = mp4Url
          a.download = fileName
          document.body.appendChild(a)
          a.click()
          document.body.removeChild(a)

          infoText.textContent = 'MP4æ ¼å¼è½¬æ¢å®Œæˆï¼Œæ–‡ä»¶å¼€å§‹ä¸‹è½½...'

          // æ¸…ç†èµ„æº
          setTimeout(() => {
            URL.revokeObjectURL(mp4Url)
            // æ¸…ç†FFmpegæ–‡ä»¶ç³»ç»Ÿ
            ffmpeg.FS('unlink', 'input.webm')
            ffmpeg.FS('unlink', 'output.mp4')
            infoText.textContent = `ä¸‹è½½å®Œæˆ! MP4æ–‡ä»¶å¤§å°: ${formatFileSize(
              mp4Blob.size
            )}`
          }, 3000)
        } catch (error) {
          console.error('è½¬æ¢å¤±è´¥:', error)
          statusDisplay.textContent = `è½¬æ¢å¤±è´¥: ${error.message}`
        } finally {
          showLoading(false)
        }
      })

      // ä¸‹è½½æœ€æ–°å½•åˆ¶ä¸ºWebM
      downloadWebmBtn.addEventListener('click', () => {
        if (!recordedBlob) return

        const fileName = `å½•åˆ¶_${new Date()
          .toISOString()
          .replace(/[:.]/g, '-')}.webm`
        const url = URL.createObjectURL(recordedBlob)
        const a = document.createElement('a')
        a.href = url
        a.download = fileName
        document.body.appendChild(a)
        a.click()
        document.body.removeChild(a)
        infoText.textContent = 'æ–‡ä»¶å¼€å§‹ä¸‹è½½ï¼Œæ­£åœ¨æ¸…ç†èµ„æº...'

        // æ¸…ç†èµ„æº
        setTimeout(() => {
          URL.revokeObjectURL(url)
          infoText.textContent = `ä¸‹è½½å®Œæˆ! WebMæ–‡ä»¶å¤§å°: ${formatFileSize(
            recordedBlob.size
          )}`
        }, 3000)
      })

      // åˆ é™¤å•æ¡è®°å½•
      function deleteRecording(id) {
        // æŸ¥æ‰¾è®°å½•
        const recordingIndex = recordings.findIndex((r) => r.id == id)
        if (recordingIndex === -1) return

        // é‡Šæ”¾èµ„æº
        URL.revokeObjectURL(recordings[recordingIndex].url)

        // å¦‚æœåˆ é™¤çš„è®°å½•æ­£åœ¨æ’­æ”¾ï¼Œå…³é—­å¼¹æ¡†
        if (modalVideo.src.includes(id)) {
          closeVideoModal()
        }

        // ä»æ•°ç»„ä¸­ç§»é™¤
        recordings.splice(recordingIndex, 1)

        // æ›´æ–°å­˜å‚¨
        localStorage.setItem('screenRecordings', JSON.stringify(recordings))

        // æ›´æ–°UI
        updateRecordingsList()

        // å¦‚æœæ²¡æœ‰è®°å½•äº†åˆ™éšè—é¢æ¿
        if (recordings.length === 0) {
          showPanel(false)
        }
      }

      // æ˜¾ç¤º/éšè—å½•åˆ¶é¢æ¿
      function showPanel(show) {
        recordingsPanel.style.display = show ? 'block' : 'none'
      }

      // æ’­æ”¾æœ€æ–°å½•åˆ¶åœ¨å¼¹æ¡†ä¸­
      playBtn.addEventListener('click', () => {
        if (!recordedBlob) return

        // è®¾ç½®å¼¹æ¡†å†…å®¹
        const title = `æœ€è¿‘å½•åˆ¶_${new Date()
          .toLocaleString()
          .replace(/[:]/g, '-')}`
        modalVideoTitle.textContent = title
        modalVideoInfo.textContent = `æ–‡ä»¶å¤§å°: ${formatFileSize(
          recordedBlob.size
        )}`
        modalVideo.src = currentRecordedUrl

        // æ‰“å¼€å¼¹æ¡†
        openVideoModal()
      })

      // é‡ç½®æ§åˆ¶æŒ‰é’®çŠ¶æ€
      function resetControls() {
        startBtn.disabled = false
        stopBtn.disabled = true
      }

      // å¦‚æœæœ‰è®°å½•ï¼Œæ˜¾ç¤ºé¢æ¿
      if (recordings.length > 0) {
        showPanel(true)
      }

      window.addEventListener('unload', () => {
        // é‡Šæ”¾æ‰€æœ‰Blob URL
        recordings.forEach((recording) => {
          URL.revokeObjectURL(recording.url)
        })

        recordings = []
        localStorage.removeItem('screenRecordings')
        updateRecordingsList()
        showPanel(false)
      })
      // æµ®åŠ¨æŒ‰é’®äº¤äº’
      document.addEventListener('DOMContentLoaded', () => {
        const fabContainer = document.querySelector('.fab-container')
        const fabMain = document.getElementById('fabMain')

        fabMain.addEventListener('click', () => {
          fabContainer.classList.toggle('active')
        })

        // ç‚¹å‡»é¡µé¢å…¶ä»–åœ°æ–¹å…³é—­èœå•
        document.addEventListener('click', (e) => {
          if (!fabContainer.contains(e.target)) {
            fabContainer.classList.remove('active')
          }
        })

        // åˆå§‹åŒ–æŒ‰é’®çŠ¶æ€
        updateButtonStates()
      })
    </script>
    <script src="./title.js"></script>
  </body>
</html>
