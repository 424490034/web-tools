<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>多格式视频播放器</title>
    <!-- 引入DPlayer核心库 -->
    <link rel="stylesheet" href="./player/DPlayer.min.css" />
    <link rel="stylesheet" href="./player/model.css" />
    <!-- 流媒体格式支持库 -->
    <script src="./player/flv.min.js"></script>
    <script src="./player/hls.min.js"></script>
    <script src="./player/dash.all.min.js"></script>
    <script src="./player/shaka-player.compiled.js"></script>
    <script src="./player/webtorrent.min.js"></script>
    <script src="./player/DPlayer.min.js"></script>

    <style>
      :root {
        /* Neumorphism Color Palette */
        --bg-primary: #e0e5ec;
        --bg-secondary: #f0f4f8;
        --bg-dark: #d1d9e6;
        --text-primary: #2c3e50;
        --text-secondary: #5a6c7d;
        --text-muted: #8b9dc3;
        --accent-primary: #667eea;
        --accent-secondary: #764ba2;
        --success: #4ecdc4;
        --warning: #f7b731;
        --danger: #fc5c65;
        --shadow-light: #ffffff;
        --shadow-dark: #a3b1c6;
        --border-radius: 20px;
        --border-radius-small: 12px;
        --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
        font-family: 'Inter', 'Segoe UI', Tahoma, sans-serif;
      }

      body {
        background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
        color: var(--text-primary);
        min-height: 100vh;
        padding: 20px;
        overflow-x: hidden;
        animation: pageLoad 1s ease-out;
      }

      @keyframes pageLoad {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
        display: grid;
        grid-template-columns: 1fr 350px;
        gap: 30px;
        animation: containerFloat 1.2s ease-out 0.3s both;
      }

      @keyframes containerFloat {
        from {
          opacity: 0;
          transform: translateY(30px) scale(0.95);
        }
        to {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }

      header {
        grid-column: 1 / -1;
        text-align: center;
        padding: 30px 20px;
        background: var(--bg-primary);
        border-radius: var(--border-radius);
        box-shadow: 
          8px 8px 16px var(--shadow-dark),
          -8px -8px 16px var(--shadow-light);
        margin-bottom: 30px;
        animation: headerSlide 1s ease-out 0.5s both;
        position: relative;
        overflow: hidden;
      }

      header::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
        animation: headerShine 3s ease-in-out infinite;
      }

      @keyframes headerSlide {
        from {
          opacity: 0;
          transform: translateY(-20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes headerShine {
        0% { left: -100%; }
        50% { left: 100%; }
        100% { left: 100%; }
      }

      h1 {
        font-size: 2.5rem;
        font-weight: 700;
        background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
        -webkit-background-clip: text;
        background-clip: text;
        color: transparent;
        margin-bottom: 12px;
        animation: titleGlow 2s ease-in-out infinite alternate;
        text-shadow: 0 0 20px rgba(102, 126, 234, 0.3);
      }

      @keyframes titleGlow {
        from {
          filter: brightness(1);
        }
        to {
          filter: brightness(1.1);
        }
      }

      .subtitle {
        color: var(--text-secondary);
        font-size: 1.1rem;
        font-weight: 500;
        opacity: 0;
        animation: subtitleFade 1s ease-out 0.8s both;
      }

      @keyframes subtitleFade {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      /* 播放器区域 */
      .player-section {
        background: var(--bg-primary);
        border-radius: var(--border-radius);
        padding: 20px;
        box-shadow: 
          inset 6px 6px 12px var(--shadow-dark),
          inset -6px -6px 12px var(--shadow-light);
        animation: panelSlide 1s ease-out 0.7s both;
        position: relative;
        overflow: hidden;
      }

      .player-section::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, transparent 50%, rgba(0,0,0,0.05) 100%);
        pointer-events: none;
      }

      @keyframes panelSlide {
        from {
          opacity: 0;
          transform: translateX(-30px);
        }
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }

      #dplayer {
        border-radius: var(--border-radius-small);
        overflow: hidden;
        height: 500px;
        background: #000;
        box-shadow: 
          8px 8px 16px var(--shadow-dark),
          -8px -8px 16px var(--shadow-light);
        transition: var(--transition);
      }

      #dplayer:hover {
        transform: translateY(-2px);
        box-shadow: 
          12px 12px 24px var(--shadow-dark),
          -12px -12px 24px var(--shadow-light);
      }

      /* 播放列表区域 */
      .playlist-section {
        background: var(--bg-primary);
        border-radius: var(--border-radius);
        padding: 20px;
        box-shadow: 
          8px 8px 16px var(--shadow-dark),
          -8px -8px 16px var(--shadow-light);
        display: flex;
        flex-direction: column;
        height: fit-content;
        max-height: 580px;
        animation: panelSlide 1s ease-out 0.9s both;
        position: relative;
        overflow: hidden;
      }

      .playlist-section::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, rgba(255,255,255,0.05) 0%, transparent 50%, rgba(0,0,0,0.02) 100%);
        pointer-events: none;
      }
      .playlist-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        position: relative;
        z-index: 1;
      }

      .playlist-header::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 2px;
        background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
        border-radius: 1px;
      }

      .playlist-header h2 {
        color: var(--text-primary);
        font-size: 1.4rem;
        font-weight: 600;
        margin: 0;
      }

      .playlist-controls {
        display: flex;
        gap: 12px;
      }

      .btn {
        background: var(--bg-primary);
        color: var(--text-primary);
        border: none;
        padding: 10px 18px;
        border-radius: var(--border-radius-small);
        cursor: pointer;
        font-weight: 600;
        font-size: 0.9rem;
        transition: var(--transition);
        display: flex;
        align-items: center;
        gap: 6px;
        box-shadow: 
          4px 4px 8px var(--shadow-dark),
          -4px -4px 8px var(--shadow-light);
        position: relative;
        overflow: hidden;
      }

      .btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
        transition: left 0.5s ease;
      }

      .btn:hover::before {
        left: 100%;
      }

      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 
          6px 6px 12px var(--shadow-dark),
          -6px -6px 12px var(--shadow-light);
      }

      .btn:active {
        transform: translateY(0);
        box-shadow: 
          inset 2px 2px 4px var(--shadow-dark),
          inset -2px -2px 4px var(--shadow-light);
      }

      .btn-danger {
        color: var(--danger);
      }

      .btn-danger:hover {
        background: linear-gradient(135deg, rgba(252, 92, 101, 0.1), rgba(252, 92, 101, 0.05));
      }

      .btn-success {
        color: var(--success);
      }

      .btn-success:hover {
        background: linear-gradient(135deg, rgba(78, 205, 196, 0.1), rgba(78, 205, 196, 0.05));
      }

      .btn i {
        font-size: 1.1em;
        transition: var(--transition);
      }

      .btn:hover i {
        transform: scale(1.1);
      }
      #file-input {
        display: none;
      }

      .file-label {
        display: block;
        background: var(--bg-primary);
        color: var(--accent-secondary);
        padding: 12px 20px;
        border-radius: var(--border-radius-small);
        cursor: pointer;
        text-align: center;
        margin-top: 15px;
        transition: var(--transition);
        font-weight: 600;
        box-shadow: 
          4px 4px 8px var(--shadow-dark),
          -4px -4px 8px var(--shadow-light);
        position: relative;
        overflow: hidden;
        z-index: 1;
      }

      .file-label::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(118, 75, 162, 0.1), transparent);
        transition: left 0.5s ease;
        z-index: -1;
      }

      .file-label:hover::before {
        left: 100%;
      }

      .file-label:hover {
        transform: translateY(-2px);
        box-shadow: 
          6px 6px 12px var(--shadow-dark),
          -6px -6px 12px var(--shadow-light);
        background: linear-gradient(135deg, rgba(118, 75, 162, 0.05), rgba(118, 75, 162, 0.02));
      }

      .file-label:active {
        transform: translateY(0);
        box-shadow: 
          inset 2px 2px 4px var(--shadow-dark),
          inset -2px -2px 4px var(--shadow-light);
      }
      /* 播放列表样式 */
      #playlist {
        list-style: none;
        overflow-y: auto;
        max-height: 420px;
        margin-top: 20px;
        padding-right: 8px;
        scrollbar-width: thin;
        scrollbar-color: var(--accent-primary) var(--bg-dark);
        position: relative;
        z-index: 1;
      }

      #playlist::-webkit-scrollbar {
        width: 8px;
      }

      #playlist::-webkit-scrollbar-track {
        background: var(--bg-dark);
        border-radius: 4px;
        box-shadow: inset 2px 2px 4px var(--shadow-dark);
      }

      #playlist::-webkit-scrollbar-thumb {
        background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
        border-radius: 4px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      }

      #playlist::-webkit-scrollbar-thumb:hover {
        background: linear-gradient(135deg, var(--accent-secondary), var(--accent-primary));
      }

      #playlist li {
        background: var(--bg-primary);
        padding: 15px 18px;
        margin-bottom: 12px;
        border-radius: var(--border-radius-small);
        display: flex;
        align-items: center;
        cursor: pointer;
        transition: var(--transition);
        box-shadow: 
          4px 4px 8px var(--shadow-dark),
          -4px -4px 8px var(--shadow-light);
        position: relative;
        overflow: hidden;
        animation: listItemSlide 0.5s ease-out;
        animation-fill-mode: both;
      }

      @keyframes listItemSlide {
        from {
          opacity: 0;
          transform: translateX(-20px);
        }
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }

      #playlist li::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
        transition: left 0.5s ease;
      }

      #playlist li:hover::before {
        left: 100%;
      }

      #playlist li:hover {
        transform: translateX(8px) translateY(-2px);
        box-shadow: 
          6px 6px 12px var(--shadow-dark),
          -6px -6px 12px var(--shadow-light);
      }

      #playlist li.active {
        background: linear-gradient(135deg, rgba(78, 205, 196, 0.1), rgba(78, 205, 196, 0.05));
        box-shadow: 
          inset 2px 2px 4px rgba(78, 205, 196, 0.2),
          4px 4px 8px var(--shadow-dark),
          -4px -4px 8px var(--shadow-light);
        border-left: 4px solid var(--success);
      }

      #playlist li.active::after {
        content: '';
        position: absolute;
        right: 15px;
        top: 50%;
        transform: translateY(-50%);
        width: 8px;
        height: 8px;
        background: var(--success);
        border-radius: 50%;
        animation: activePulse 2s ease-in-out infinite;
      }

      @keyframes activePulse {
        0%, 100% {
          opacity: 1;
          transform: translateY(-50%) scale(1);
        }
        50% {
          opacity: 0.6;
          transform: translateY(-50%) scale(1.2);
        }
      }
      #playlist li .format-tag {
        background: var(--bg-dark);
        color: var(--accent-primary);
        font-size: 0.75rem;
        font-weight: 600;
        padding: 4px 10px;
        border-radius: 12px;
        margin-left: 10px;
        box-shadow: 
          inset 2px 2px 4px var(--shadow-dark),
          inset -2px -2px 4px var(--shadow-light);
        transition: var(--transition);
        position: relative;
        z-index: 1;
      }

      #playlist li .flv-tag {
        color: var(--danger);
        background: linear-gradient(135deg, rgba(252, 92, 101, 0.1), rgba(252, 92, 101, 0.05));
      }

      #playlist li .m3u8-tag {
        color: var(--accent-secondary);
        background: linear-gradient(135deg, rgba(118, 75, 162, 0.1), rgba(118, 75, 162, 0.05));
      }

      #playlist li .dash-tag {
        color: var(--warning);
        background: linear-gradient(135deg, rgba(247, 183, 49, 0.1), rgba(247, 183, 49, 0.05));
      }

      #playlist li .webtorrent-tag {
        color: var(--success);
        background: linear-gradient(135deg, rgba(78, 205, 196, 0.1), rgba(78, 205, 196, 0.05));
      }

      .video-info {
        flex-grow: 1;
        overflow: hidden;
        margin-right: 15px;
        position: relative;
        z-index: 1;
      }

      .video-info .title {
        font-weight: 600;
        font-size: 0.95rem;
        color: var(--text-primary);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        margin-bottom: 6px;
        transition: var(--transition);
      }

      #playlist li:hover .video-info .title {
        color: var(--accent-primary);
      }

      .video-info .url {
        font-size: 0.8rem;
        color: var(--text-muted);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        transition: var(--transition);
      }

      .checkbox {
        margin-right: 15px;
        position: relative;
        z-index: 1;
      }

      .checkbox input[type="checkbox"] {
        appearance: none;
        width: 18px;
        height: 18px;
        border-radius: 4px;
        background: var(--bg-primary);
        box-shadow: 
          inset 2px 2px 4px var(--shadow-dark),
          inset -2px -2px 4px var(--shadow-light);
        cursor: pointer;
        transition: var(--transition);
        position: relative;
      }

      .checkbox input[type="checkbox"]:checked {
        background: linear-gradient(135deg, var(--success), rgba(78, 205, 196, 0.8));
        box-shadow: 
          2px 2px 4px var(--shadow-dark),
          -2px -2px 4px var(--shadow-light);
      }

      .checkbox input[type="checkbox"]:checked::after {
        content: '✓';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: white;
        font-size: 12px;
        font-weight: bold;
      }
      /* 响应式设计 */
      @media (max-width: 900px) {
        .container {
          grid-template-columns: 1fr;
          gap: 20px;
        }
        #dplayer {
          height: 400px;
        }
        .playlist-section {
          max-height: 500px;
        }
      }

      @media (max-width: 500px) {
        body {
          padding: 15px;
        }
        #dplayer {
          height: 300px;
        }
        .btn-text {
          display: none;
        }
        .btn i {
          margin-right: 0;
        }
        .playlist-controls {
          gap: 8px;
        }
        .btn {
          padding: 8px 12px;
        }
      }

      /* 格式支持提示 */
      .format-info {
        background: var(--bg-primary);
        padding: 20px;
        border-radius: var(--border-radius);
        margin-top: 30px;
        grid-column: 1 / -1;
        box-shadow: 
          8px 8px 16px var(--shadow-dark),
          -8px -8px 16px var(--shadow-light);
        animation: panelSlide 1s ease-out 1.1s both;
        position: relative;
        overflow: hidden;
      }

      .format-info::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, rgba(255,255,255,0.05) 0%, transparent 50%, rgba(0,0,0,0.02) 100%);
        pointer-events: none;
      }

      .format-info h3 {
        color: var(--text-primary);
        font-size: 1.3rem;
        font-weight: 600;
        margin-bottom: 15px;
        position: relative;
        z-index: 1;
      }

      .format-list {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        position: relative;
        z-index: 1;
      }

      .format-badge {
        background: var(--bg-primary);
        color: var(--text-primary);
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 500;
        box-shadow: 
          4px 4px 8px var(--shadow-dark),
          -4px -4px 8px var(--shadow-light);
        transition: var(--transition);
        cursor: default;
      }

      .format-badge:hover {
        transform: translateY(-2px);
        box-shadow: 
          6px 6px 12px var(--shadow-dark),
          -6px -6px 12px var(--shadow-light);
      }

      .format-badge.flv {
        color: var(--danger);
        background: linear-gradient(135deg, rgba(252, 92, 101, 0.1), rgba(252, 92, 101, 0.05));
      }

      .format-badge.m3u8 {
        color: var(--accent-secondary);
        background: linear-gradient(135deg, rgba(118, 75, 162, 0.1), rgba(118, 75, 162, 0.05));
      }

      .format-badge.dash {
        color: var(--warning);
        background: linear-gradient(135deg, rgba(247, 183, 49, 0.1), rgba(247, 183, 49, 0.05));
      }

      .format-badge.webtorrent {
        color: var(--success);
        background: linear-gradient(135deg, rgba(78, 205, 196, 0.1), rgba(78, 205, 196, 0.05));
      }
      .footer {
        grid-column: 1 / -1;
        text-align: center;
        padding: 25px 20px;
        color: var(--text-muted);
        font-size: 0.9rem;
        margin-top: 30px;
        background: var(--bg-primary);
        border-radius: var(--border-radius);
        box-shadow: 
          inset 4px 4px 8px var(--shadow-dark),
          inset -4px -4px 8px var(--shadow-light);
        animation: panelSlide 1s ease-out 1.3s both;
        position: relative;
        overflow: hidden;
      }

      .footer::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, rgba(255,255,255,0.02) 0%, transparent 50%, rgba(0,0,0,0.01) 100%);
        pointer-events: none;
      }

      /* 状态提示 */
      .status-indicator {
        display: flex;
        align-items: center;
        margin-top: 15px;
        padding: 10px 15px;
        background: var(--bg-dark);
        border-radius: var(--border-radius-small);
        font-size: 0.9rem;
        font-weight: 500;
        color: var(--text-secondary);
        box-shadow: 
          inset 3px 3px 6px var(--shadow-dark),
          inset -3px -3px 6px var(--shadow-light);
        position: relative;
        z-index: 1;
      }

      .status-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 10px;
        position: relative;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      }

      .status-dot.connecting {
        background: linear-gradient(135deg, var(--warning), rgba(247, 183, 49, 0.8));
        animation: statusPulse 1.5s ease-in-out infinite;
      }

      .status-dot.connecting::after {
        content: '';
        position: absolute;
        top: -2px;
        left: -2px;
        right: -2px;
        bottom: -2px;
        border-radius: 50%;
        background: var(--warning);
        opacity: 0.3;
        animation: statusRipple 1.5s ease-in-out infinite;
      }

      .status-dot.playing {
        background: linear-gradient(135deg, var(--success), rgba(78, 205, 196, 0.8));
        animation: statusGlow 2s ease-in-out infinite alternate;
      }

      .status-dot.error {
        background: linear-gradient(135deg, var(--danger), rgba(252, 92, 101, 0.8));
        animation: statusShake 0.5s ease-in-out;
      }

      @keyframes statusPulse {
        0%, 100% {
          opacity: 1;
          transform: scale(1);
        }
        50% {
          opacity: 0.7;
          transform: scale(1.1);
        }
      }

      @keyframes statusRipple {
        0% {
          transform: scale(1);
          opacity: 0.3;
        }
        100% {
          transform: scale(1.5);
          opacity: 0;
        }
      }

      @keyframes statusGlow {
        from {
          box-shadow: 0 2px 4px rgba(0,0,0,0.2), 0 0 8px rgba(78, 205, 196, 0.3);
        }
        to {
          box-shadow: 0 2px 4px rgba(0,0,0,0.2), 0 0 16px rgba(78, 205, 196, 0.6);
        }
      }

      @keyframes statusShake {
        0%, 100% { transform: translateX(0); }
        25% { transform: translateX(-2px); }
        75% { transform: translateX(2px); }
      }
    </style>
  </head>
  <body>
    <div id="customModal" class="custom-modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">添加视频</h3>
          <span class="close-modal">&times;</span>
        </div>
        <div class="modal-body">
          <div class="input-group">
            <label for="videoUrl">视频URL</label>
            <input type="text" id="videoUrl" placeholder="请输入视频URL" />
          </div>
          <div class="input-group">
            <label for="videoTitle">视频标题</label>
            <input
              type="text"
              id="videoTitle"
              placeholder="请输入视频标题（默认：我的视频）"
            />
          </div>
        </div>
        <div class="modal-footer">
          <button class="modal-btn cancel">取消</button>
          <button class="modal-btn confirm">确认</button>
        </div>
      </div>
    </div>
    <div class="container">
      <header>
        <h1>多功能视频播放器</h1>
        <p class="subtitle">支持多选、M3U8直播、FLV流媒体及主流视频格式</p>
      </header>

      <!-- 播放器区域 -->
      <section class="player-section">
        <div id="dplayer"></div>
        <div class="status-indicator">
          <div class="status-dot" id="status-dot"></div>
          <span id="status-text">就绪</span>
        </div>
      </section>

      <!-- 播放列表区域 -->
      <section class="playlist-section">
        <div class="playlist-header">
          <h2>播放列表</h2>
          <div class="playlist-controls">
            <button class="btn btn-success" id="add-url">
              <i>+</i><span class="btn-text">添加URL</span>
            </button>
            <button class="btn btn-danger" id="remove-selected">
              <i>×</i><span class="btn-text">删除选中</span>
            </button>
          </div>
        </div>

        <input
          type="file"
          id="file-input"
          multiple
          accept=".mp4,.webm,.flv,.mpd,.ts,.m4s,.torrent,video/*"
        />
        <label for="file-input" class="file-label">
          <i>📁</i> 选择本地视频文件
        </label>

        <ul id="playlist"></ul>
      </section>

      <!-- 格式支持信息 -->
      <div class="format-info">
        <h3>支持格式</h3>
        <div class="format-list">
          <span class="format-badge">MP4</span>
          <span class="format-badge">WebM</span>
          <span class="format-badge m3u8">M3U8/HLS</span>
          <span class="format-badge flv">FLV</span>
          <span class="format-badge dash">MPEG-DASH</span>
          <span class="format-badge">OGG</span>
          <span class="format-badge webtorrent">WebTorrent</span>
        </div>
      </div>

      <div class="footer">
        <p>
          基于 DPlayer + flv.js + hls.js + dash.js + WebTorrent 技术构建 |
          支持多格式流媒体播放
        </p>
      </div>
    </div>

    <script>
      // 播放器初始化
      const dp = new DPlayer({
        container: document.getElementById('dplayer'),
        autoplay: true,
        theme: '#3498db',
        loop: false,
        hotkey: true,
        screenshot: true,
        preload: 'auto',
        mutex: true, // 互斥锁，避免同时播放多个
        video: {
          url: '',
          type: 'auto',
        },
        // 添加自定义类型处理[1,9](@ref)
        customType: {
          // HLS格式支持
          hls: function (video, player) {
            const hls = new Hls()
            hls.loadSource(video.src)
            hls.attachMedia(video)
          },
          // FLV格式支持
          flv: function (video, player) {
            const flvPlayer = flvjs.createPlayer({
              type: 'flv',
              url: video.src,
            })
            flvPlayer.attachMediaElement(video)
            flvPlayer.load()
          },
          // MPEG-DASH支持（dash.js）
          dash: function (video, player) {
            const playerInstance = dashjs.MediaPlayer().create()
            playerInstance.initialize(video, video.src, true)
          },
          // MPEG-DASH支持（Shaka）
          shakaDash: function (video, player) {
            const playerInstance = new shaka.Player(video)
            playerInstance.load(video.src)
          },
          // WebTorrent支持
          webtorrent: function (video, player) {
            const client = new WebTorrent()
            client.add(video.src, (torrent) => {
              const file = torrent.files.find((file) =>
                file.name.endsWith('.mp4')
              )
              if (file) {
                file.renderTo(video)
              } else {
                updateStatus('错误：未找到可播放的视频文件', 'error')
              }
            })
          },
        },
      })

      // 播放列表数据
      const playlist = []
      let currentIndex = -1
      let webtorrentClient = null

      // DOM元素
      const fileInput = document.getElementById('file-input')
      const playlistEl = document.getElementById('playlist')
      const addUrlBtn = document.getElementById('add-url')
      const removeSelectedBtn = document.getElementById('remove-selected')
      const statusDot = document.getElementById('status-dot')
      const statusText = document.getElementById('status-text')

      // 更新状态提示
      function updateStatus(message, status = 'playing') {
        statusText.textContent = message
        statusDot.className = 'status-dot'
        statusDot.classList.add(status)
      }

      // 添加本地文件
      fileInput.addEventListener('change', (e) => {
        const files = Array.from(e.target.files)
        files.forEach((file) => {
          const url = URL.createObjectURL(file)
          const type = getFileType(file.name)

          // 特殊处理：WebTorrent种子文件
          if (type === 'torrent') {
            // 直接使用种子文件路径
            addToPlaylist({
              title: file.name,
              url: URL.createObjectURL(file),
              type: 'webtorrent',
            })
          } else {
            addToPlaylist({
              title: file.name,
              url: url,
              type: type,
            })
          }
        })
        fileInput.value = ''
      })

      // 删除选中项
      removeSelectedBtn.addEventListener('click', () => {
        const selectedItems = Array.from(
          playlistEl.querySelectorAll('li input[type="checkbox"]:checked')
        ).map((checkbox) => checkbox.closest('li').dataset.index)

        // 从后往前删除避免索引变化
        selectedItems
          .sort((a, b) => b - a)
          .forEach((index) => {
            const video = playlist[index]
            // 释放Blob URL内存
            if (video.url.startsWith('blob:')) {
              URL.revokeObjectURL(video.url)
            }
            playlist.splice(index, 1)
            // 如果删除的是当前播放项，停止播放
            if (parseInt(index) === currentIndex) {
              dp.pause()
              currentIndex = -1
            }
          })
        renderPlaylist()
        updateStatus('已删除选中项目')
      })

      // 添加视频到播放列表
      function addToPlaylist(video) {
        playlist.push(video)
        renderPlaylist()

        // 如果是第一个视频自动播放
        if (playlist.length === 1) {
          playVideo(0)
        }
      }

      // 渲染播放列表
      function renderPlaylist() {
        playlistEl.innerHTML = ''
        playlist.forEach((video, index) => {
          const li = document.createElement('li')
          li.dataset.index = index
          if (index === currentIndex) li.classList.add('active')

          li.innerHTML = `
                    <div class="checkbox">
                        <input type="checkbox" id="item-${index}">
                    </div>
                    <div class="video-info">
                        <div class="title">${video.title}</div>
                        <div class="url">${
                          video.url.length > 50
                            ? video.url.substring(0, 50) + '...'
                            : video.url
                        }</div>
                    </div>
                    <span class="format-tag ${getFormatTagClass(video.type)}">
                        ${formatTypeName(video.type)}
                    </span>
                `

          li.addEventListener('click', (e) => {
            // 避免点击checkbox时触发播放
            if (e.target.tagName !== 'INPUT') {
              playVideo(index)
            }
          })

          playlistEl.appendChild(li)
        })
      }

      // 获取格式标签的类名
      function getFormatTagClass(type) {
        const map = {
          flv: 'flv-tag',
          m3u8: 'm3u8-tag',
          hls: 'm3u8-tag',
          dash: 'dash-tag',
          webtorrent: 'webtorrent-tag',
          torrent: 'webtorrent-tag',
        }
        return map[type] || ''
      }

      // 格式化类型名称
      function formatTypeName(type) {
        const map = {
          flv: 'FLV',
          m3u8: 'HLS',
          hls: 'HLS',
          dash: 'DASH',
          webtorrent: 'Torrent',
          torrent: 'Torrent',
          mp4: 'MP4',
          webm: 'WebM',
          ogg: 'OGG',
        }
        return map[type] || type.toUpperCase()
      }

      // 播放指定索引的视频（已修改）
      function playVideo(index) {
        if (index < 0 || index >= playlist.length) return

        const video = playlist[index]
        currentIndex = index
        renderPlaylist()
        updateStatus('正在加载视频...', 'connecting')

        // 销毁之前的WebTorrent实例
        if (webtorrentClient) {
          webtorrentClient.destroy()
          webtorrentClient = null
        }

        try {
          let playerType = video.type
          let finalUrl = video.url // 最终传递给播放器的URL

          // M3U8特殊处理：计算基础路径并重写TS路径
          if (video.type === 'm3u8') {
            playerType = 'hls'

            // 1. 获取M3U8文件所在目录作为基础路径
            const basePath = finalUrl.substring(
              0,
              finalUrl.lastIndexOf('/') + 1
            )

            // 2. 覆盖HLS自定义处理逻辑
            dp.customType['hls'] = function (videoElement) {
              const hls = new Hls()

              // 监听清单解析事件，重写TS路径
              hls.on(Hls.Events.MANIFEST_PARSED, (event, data) => {
                data.levels.forEach((level) => {
                  // 保留TS文件名 + 拼接基础路径
                  const tsName = level.url.split('/').pop()
                  level.url = basePath + tsName
                })
              })

              hls.loadSource(finalUrl)
              hls.attachMedia(videoElement)
            }
          }
          // 其他格式处理保持不变
          else if (video.type === 'torrent') {
            playerType = 'webtorrent'
          } else if (video.type === 'dash') {
            playerType = 'dash'
          }

          // 切换视频（M3U8使用自定义hls处理）
          dp.switchVideo({
            url: finalUrl,
            type: playerType,
            pic: '',
            thumbnails: '',
          })

          // 事件监听（保持不变）
          dp.on('canplay', () => {
            updateStatus('正在播放: ' + video.title, 'playing')
          })
          dp.on('error', (err) => {
            updateStatus('播放错误: ' + err.message, 'error')
          })
          dp.play()
        } catch (e) {
          console.error('播放失败:', e)
          updateStatus('播放失败: ' + e.message, 'error')
        }
      }

      // 根据文件名或URL获取文件类型
      function getFileType(filename) {
        // 处理磁力链接
        if (filename.startsWith('magnet:')) {
          return 'webtorrent'
        }

        // 处理URL中的文件类型
        const url = filename.toLowerCase()
        if (url.includes('.m3u8') || url.includes('.ts')) return 'm3u8'
        if (url.includes('.flv')) return 'flv'
        if (url.includes('.mpd') || url.includes('.m4s')) return 'dash'
        if (url.includes('.torrent')) return 'torrent'
        if (url.includes('webtorrent')) return 'webtorrent'

        // 处理文件扩展名
        const ext = filename.split('.').pop().toLowerCase()
        switch (ext) {
          case 'm3u8':
          case 'ts':
            return 'm3u8'
          case 'flv':
            return 'flv'
          case 'mpd':
          case 'm4s':
            return 'dash'
          case 'torrent':
            return 'torrent'
          case 'mp4':
          case 'm4v':
            return 'mp4'
          case 'webm':
            return 'webm'
          case 'ogg':
          case 'ogv':
            return 'ogg'
          default:
            return ext
        }
      }

      // 拖放功能支持
      playlistEl.addEventListener('dragover', (e) => {
        e.preventDefault()
        e.dataTransfer.dropEffect = 'copy'
      })

      playlistEl.addEventListener('drop', (e) => {
        e.preventDefault()
        const files = e.dataTransfer.files
        if (files.length) {
          Array.from(files).forEach((file) => {
            if (
              file.type.startsWith('video/') ||
              file.name.endsWith('.torrent')
            ) {
              const url = URL.createObjectURL(file)
              const type = getFileType(file.name)
              addToPlaylist({
                title: file.name,
                url: url,
                type: type,
              })
            }
          })
        }
      })

      // 初始化状态
      updateStatus('就绪')
    </script>
    <script src="./player/model.js"></script>
  </body>
</html>
