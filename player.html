<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>å¤šæ ¼å¼è§†é¢‘æ’­æ”¾å™¨</title>
    <!-- å¼•å…¥DPlayeræ ¸å¿ƒåº“ -->
    <link rel="stylesheet" href="./player/DPlayer.min.css" />
    <!-- æµåª’ä½“æ ¼å¼æ”¯æŒåº“ -->
    <script src="./player/flv.min.js"></script>
    <script src="./player/hls.min.js"></script>
    <script src="./player/dash.all.min.js"></script>
    <script src="./player/shaka-player.compiled.js"></script>
    <script src="./player/webtorrent.min.js"></script>
    <script src="./player/DPlayer.min.js"></script>

    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
        font-family: 'Segoe UI', Tahoma, sans-serif;
      }
      body {
        background: linear-gradient(135deg, #1a2a6c, #2c3e50);
        color: #ecf0f1;
        min-height: 100vh;
        padding: 20px;
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
        display: grid;
        grid-template-columns: 1fr 350px;
        gap: 20px;
      }
      header {
        grid-column: 1 / -1;
        text-align: center;
        padding: 20px 0;
        border-bottom: 1px solid #3498db;
        margin-bottom: 20px;
      }
      h1 {
        font-size: 2.2rem;
        background: linear-gradient(90deg, #3498db, #2ecc71);
        -webkit-background-clip: text;
        background-clip: text;
        color: transparent;
        margin-bottom: 10px;
      }
      .subtitle {
        color: #bdc3c7;
        font-size: 1.1rem;
      }
      /* æ’­æ”¾å™¨åŒºåŸŸ */
      .player-section {
        background: rgba(30, 40, 60, 0.7);
        border-radius: 12px;
        padding: 15px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        backdrop-filter: blur(10px);
      }
      #dplayer {
        border-radius: 8px;
        overflow: hidden;
        height: 500px;
        background: #000;
      }
      /* æ’­æ”¾åˆ—è¡¨åŒºåŸŸ */
      .playlist-section {
        background: rgba(25, 35, 55, 0.8);
        border-radius: 12px;
        padding: 15px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        display: flex;
        flex-direction: column;
        height: fit-content;
        max-height: 560px;
      }
      .playlist-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid #3498db;
      }
      .playlist-controls {
        display: flex;
        gap: 10px;
      }
      .btn {
        background: linear-gradient(90deg, #3498db, #2980b9);
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 5px;
      }
      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(52, 152, 219, 0.4);
      }
      .btn-danger {
        background: linear-gradient(90deg, #e74c3c, #c0392b);
      }
      .btn-success {
        background: linear-gradient(90deg, #2ecc71, #27ae60);
      }
      .btn i {
        font-size: 1.2em;
      }
      #file-input {
        display: none;
      }
      .file-label {
        display: block;
        background: linear-gradient(90deg, #9b59b6, #8e44ad);
        padding: 10px 15px;
        border-radius: 6px;
        cursor: pointer;
        text-align: center;
        margin-top: 10px;
        transition: all 0.3s ease;
      }
      .file-label:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(155, 89, 182, 0.4);
      }
      /* æ’­æ”¾åˆ—è¡¨æ ·å¼ */
      #playlist {
        list-style: none;
        overflow-y: auto;
        max-height: 400px;
        margin-top: 15px;
        scrollbar-width: thin;
        scrollbar-color: #3498db #2c3e50;
      }
      #playlist::-webkit-scrollbar {
        width: 8px;
      }
      #playlist::-webkit-scrollbar-track {
        background: #2c3e50;
        border-radius: 4px;
      }
      #playlist::-webkit-scrollbar-thumb {
        background: #3498db;
        border-radius: 4px;
      }
      #playlist li {
        background: rgba(40, 55, 80, 0.6);
        padding: 12px 15px;
        margin-bottom: 10px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        cursor: pointer;
        transition: all 0.2s ease;
        border: 1px solid transparent;
      }
      #playlist li:hover {
        background: rgba(52, 73, 94, 0.8);
        transform: translateX(5px);
      }
      #playlist li.active {
        border-color: #2ecc71;
        background: rgba(46, 204, 113, 0.15);
      }
      #playlist li .format-tag {
        background: #3498db;
        color: white;
        font-size: 0.75rem;
        padding: 2px 8px;
        border-radius: 10px;
        margin-right: 10px;
      }
      #playlist li .flv-tag {
        background: #e74c3c;
      }
      #playlist li .m3u8-tag {
        background: #9b59b6;
      }
      #playlist li .dash-tag {
        background: #f39c12;
      }
      #playlist li .webtorrent-tag {
        background: #1abc9c;
      }
      .video-info {
        flex-grow: 1;
        overflow: hidden;
      }
      .video-info .title {
        font-weight: 600;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        margin-bottom: 4px;
      }
      .video-info .url {
        font-size: 0.8rem;
        color: #bdc3c7;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .checkbox {
        margin-right: 12px;
      }
      /* å“åº”å¼è®¾è®¡ */
      @media (max-width: 900px) {
        .container {
          grid-template-columns: 1fr;
        }
        #dplayer {
          height: 400px;
        }
      }
      @media (max-width: 500px) {
        #dplayer {
          height: 300px;
        }
        .btn-text {
          display: none;
        }
        .btn i {
          margin-right: 0;
        }
      }
      /* æ ¼å¼æ”¯æŒæç¤º */
      .format-info {
        background: rgba(44, 62, 80, 0.7);
        padding: 15px;
        border-radius: 8px;
        margin-top: 20px;
        grid-column: 1 / -1;
      }
      .format-info h3 {
        color: #2ecc71;
        margin-bottom: 10px;
      }
      .format-list {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
      }
      .format-badge {
        background: rgba(52, 152, 219, 0.2);
        border: 1px solid #3498db;
        padding: 5px 15px;
        border-radius: 20px;
        font-size: 0.9rem;
      }
      .format-badge.flv {
        background: rgba(231, 76, 60, 0.2);
        border-color: #e74c3c;
      }
      .format-badge.m3u8 {
        background: rgba(155, 89, 182, 0.2);
        border-color: #9b59b6;
      }
      .format-badge.dash {
        background: rgba(243, 156, 18, 0.2);
        border-color: #f39c12;
      }
      .format-badge.webtorrent {
        background: rgba(26, 188, 156, 0.2);
        border-color: #1abc9c;
      }
      .footer {
        grid-column: 1 / -1;
        text-align: center;
        padding: 20px 0;
        color: #7f8c8d;
        font-size: 0.9rem;
        margin-top: 20px;
        border-top: 1px solid #34495e;
      }
      /* çŠ¶æ€æç¤º */
      .status-indicator {
        display: flex;
        align-items: center;
        margin-top: 10px;
        padding: 8px 12px;
        background: rgba(0, 0, 0, 0.3);
        border-radius: 4px;
        font-size: 0.9rem;
      }
      .status-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        margin-right: 8px;
      }
      .status-dot.connecting {
        background-color: #f39c12;
        animation: pulse 1.5s infinite;
      }
      .status-dot.playing {
        background-color: #2ecc71;
      }
      .status-dot.error {
        background-color: #e74c3c;
      }
      @keyframes pulse {
        0% {
          opacity: 0.5;
        }
        50% {
          opacity: 1;
        }
        100% {
          opacity: 0.5;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>å¤šåŠŸèƒ½è§†é¢‘æ’­æ”¾å™¨</h1>
        <p class="subtitle">æ”¯æŒå¤šé€‰ã€M3U8ç›´æ’­ã€FLVæµåª’ä½“åŠä¸»æµè§†é¢‘æ ¼å¼</p>
      </header>

      <!-- æ’­æ”¾å™¨åŒºåŸŸ -->
      <section class="player-section">
        <div id="dplayer"></div>
        <div class="status-indicator">
          <div class="status-dot" id="status-dot"></div>
          <span id="status-text">å°±ç»ª</span>
        </div>
      </section>

      <!-- æ’­æ”¾åˆ—è¡¨åŒºåŸŸ -->
      <section class="playlist-section">
        <div class="playlist-header">
          <h2>æ’­æ”¾åˆ—è¡¨</h2>
          <div class="playlist-controls">
            <button class="btn btn-success" id="add-url">
              <i>+</i><span class="btn-text">æ·»åŠ URL</span>
            </button>
            <button class="btn btn-danger" id="remove-selected">
              <i>Ã—</i><span class="btn-text">åˆ é™¤é€‰ä¸­</span>
            </button>
          </div>
        </div>

        <input
          type="file"
          id="file-input"
          multiple
          accept=".mp4,.webm,.flv,.mpd,.ts,.m4s,.torrent,video/*"
        />
        <label for="file-input" class="file-label">
          <i>ğŸ“</i> é€‰æ‹©æœ¬åœ°è§†é¢‘æ–‡ä»¶
        </label>

        <ul id="playlist"></ul>
      </section>

      <!-- æ ¼å¼æ”¯æŒä¿¡æ¯ -->
      <div class="format-info">
        <h3>æ”¯æŒæ ¼å¼</h3>
        <div class="format-list">
          <span class="format-badge">MP4</span>
          <span class="format-badge">WebM</span>
          <span class="format-badge m3u8">M3U8/HLS</span>
          <span class="format-badge flv">FLV</span>
          <span class="format-badge dash">MPEG-DASH</span>
          <span class="format-badge">OGG</span>
          <span class="format-badge webtorrent">WebTorrent</span>
        </div>
      </div>

      <div class="footer">
        <p>
          åŸºäº DPlayer + flv.js + hls.js + dash.js + WebTorrent æŠ€æœ¯æ„å»º |
          æ”¯æŒå¤šæ ¼å¼æµåª’ä½“æ’­æ”¾
        </p>
      </div>
    </div>

    <script>
      // æ’­æ”¾å™¨åˆå§‹åŒ–
      const dp = new DPlayer({
        container: document.getElementById('dplayer'),
        autoplay: true,
        theme: '#3498db',
        loop: false,
        hotkey: true,
        screenshot: true,
        preload: 'auto',
        mutex: true, // äº’æ–¥é”ï¼Œé¿å…åŒæ—¶æ’­æ”¾å¤šä¸ª
        video: {
          url: '',
          type: 'auto',
        },
        // æ·»åŠ è‡ªå®šä¹‰ç±»å‹å¤„ç†[1,9](@ref)
        customType: {
          // HLSæ ¼å¼æ”¯æŒ
          hls: function (video, player) {
            const hls = new Hls()
            hls.loadSource(video.src)
            hls.attachMedia(video)
          },
          // FLVæ ¼å¼æ”¯æŒ
          flv: function (video, player) {
            const flvPlayer = flvjs.createPlayer({
              type: 'flv',
              url: video.src,
            })
            flvPlayer.attachMediaElement(video)
            flvPlayer.load()
          },
          // MPEG-DASHæ”¯æŒï¼ˆdash.jsï¼‰
          dash: function (video, player) {
            const playerInstance = dashjs.MediaPlayer().create()
            playerInstance.initialize(video, video.src, true)
          },
          // MPEG-DASHæ”¯æŒï¼ˆShakaï¼‰
          shakaDash: function (video, player) {
            const playerInstance = new shaka.Player(video)
            playerInstance.load(video.src)
          },
          // WebTorrentæ”¯æŒ
          webtorrent: function (video, player) {
            const client = new WebTorrent()
            client.add(video.src, (torrent) => {
              const file = torrent.files.find((file) =>
                file.name.endsWith('.mp4')
              )
              if (file) {
                file.renderTo(video)
              } else {
                updateStatus('é”™è¯¯ï¼šæœªæ‰¾åˆ°å¯æ’­æ”¾çš„è§†é¢‘æ–‡ä»¶', 'error')
              }
            })
          },
        },
      })

      // æ’­æ”¾åˆ—è¡¨æ•°æ®
      const playlist = []
      let currentIndex = -1
      let webtorrentClient = null

      // DOMå…ƒç´ 
      const fileInput = document.getElementById('file-input')
      const playlistEl = document.getElementById('playlist')
      const addUrlBtn = document.getElementById('add-url')
      const removeSelectedBtn = document.getElementById('remove-selected')
      const statusDot = document.getElementById('status-dot')
      const statusText = document.getElementById('status-text')

      // æ›´æ–°çŠ¶æ€æç¤º
      function updateStatus(message, status = 'playing') {
        statusText.textContent = message
        statusDot.className = 'status-dot'
        statusDot.classList.add(status)
      }

      // æ·»åŠ æœ¬åœ°æ–‡ä»¶
      fileInput.addEventListener('change', (e) => {
        const files = Array.from(e.target.files)
        files.forEach((file) => {
          const url = URL.createObjectURL(file)
          const type = getFileType(file.name)

          // ç‰¹æ®Šå¤„ç†ï¼šWebTorrentç§å­æ–‡ä»¶
          if (type === 'torrent') {
            // ç›´æ¥ä½¿ç”¨ç§å­æ–‡ä»¶è·¯å¾„
            addToPlaylist({
              title: file.name,
              url: URL.createObjectURL(file),
              type: 'webtorrent',
            })
          } else {
            addToPlaylist({
              title: file.name,
              url: url,
              type: type,
            })
          }
        })
        fileInput.value = ''
      })

      // æ·»åŠ URLæŒ‰é’®
      addUrlBtn.addEventListener('click', () => {
        const url = prompt('è¯·è¾“å…¥è§†é¢‘URL:', '')
        if (url) {
          const title = prompt('è¯·è¾“å…¥è§†é¢‘æ ‡é¢˜:', 'æˆ‘çš„è§†é¢‘')
          const type = getFileType(url)
          addToPlaylist({
            title: title || 'æ–°è§†é¢‘',
            url: url,
            type: type,
          })
        }
      })

      // åˆ é™¤é€‰ä¸­é¡¹
      removeSelectedBtn.addEventListener('click', () => {
        const selectedItems = Array.from(
          playlistEl.querySelectorAll('li input[type="checkbox"]:checked')
        ).map((checkbox) => checkbox.closest('li').dataset.index)

        // ä»åå¾€å‰åˆ é™¤é¿å…ç´¢å¼•å˜åŒ–
        selectedItems
          .sort((a, b) => b - a)
          .forEach((index) => {
            const video = playlist[index]
            // é‡Šæ”¾Blob URLå†…å­˜
            if (video.url.startsWith('blob:')) {
              URL.revokeObjectURL(video.url)
            }
            playlist.splice(index, 1)
            // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰æ’­æ”¾é¡¹ï¼Œåœæ­¢æ’­æ”¾
            if (parseInt(index) === currentIndex) {
              dp.pause()
              currentIndex = -1
            }
          })
        renderPlaylist()
        updateStatus('å·²åˆ é™¤é€‰ä¸­é¡¹ç›®')
      })

      // æ·»åŠ è§†é¢‘åˆ°æ’­æ”¾åˆ—è¡¨
      function addToPlaylist(video) {
        playlist.push(video)
        renderPlaylist()

        // å¦‚æœæ˜¯ç¬¬ä¸€ä¸ªè§†é¢‘è‡ªåŠ¨æ’­æ”¾
        if (playlist.length === 1) {
          playVideo(0)
        }
      }

      // æ¸²æŸ“æ’­æ”¾åˆ—è¡¨
      function renderPlaylist() {
        playlistEl.innerHTML = ''
        playlist.forEach((video, index) => {
          const li = document.createElement('li')
          li.dataset.index = index
          if (index === currentIndex) li.classList.add('active')

          li.innerHTML = `
                    <div class="checkbox">
                        <input type="checkbox" id="item-${index}">
                    </div>
                    <div class="video-info">
                        <div class="title">${video.title}</div>
                        <div class="url">${
                          video.url.length > 50
                            ? video.url.substring(0, 50) + '...'
                            : video.url
                        }</div>
                    </div>
                    <span class="format-tag ${getFormatTagClass(video.type)}">
                        ${formatTypeName(video.type)}
                    </span>
                `

          li.addEventListener('click', (e) => {
            // é¿å…ç‚¹å‡»checkboxæ—¶è§¦å‘æ’­æ”¾
            if (e.target.tagName !== 'INPUT') {
              playVideo(index)
            }
          })

          playlistEl.appendChild(li)
        })
      }

      // è·å–æ ¼å¼æ ‡ç­¾çš„ç±»å
      function getFormatTagClass(type) {
        const map = {
          flv: 'flv-tag',
          m3u8: 'm3u8-tag',
          hls: 'm3u8-tag',
          dash: 'dash-tag',
          webtorrent: 'webtorrent-tag',
          torrent: 'webtorrent-tag',
        }
        return map[type] || ''
      }

      // æ ¼å¼åŒ–ç±»å‹åç§°
      function formatTypeName(type) {
        const map = {
          flv: 'FLV',
          m3u8: 'HLS',
          hls: 'HLS',
          dash: 'DASH',
          webtorrent: 'Torrent',
          torrent: 'Torrent',
          mp4: 'MP4',
          webm: 'WebM',
          ogg: 'OGG',
        }
        return map[type] || type.toUpperCase()
      }

      // æ’­æ”¾æŒ‡å®šç´¢å¼•çš„è§†é¢‘ï¼ˆå·²ä¿®æ”¹ï¼‰
      function playVideo(index) {
        if (index < 0 || index >= playlist.length) return

        const video = playlist[index]
        currentIndex = index
        renderPlaylist()
        updateStatus('æ­£åœ¨åŠ è½½è§†é¢‘...', 'connecting')

        // é”€æ¯ä¹‹å‰çš„WebTorrentå®ä¾‹
        if (webtorrentClient) {
          webtorrentClient.destroy()
          webtorrentClient = null
        }

        try {
          let playerType = video.type
          let finalUrl = video.url // æœ€ç»ˆä¼ é€’ç»™æ’­æ”¾å™¨çš„URL

          // M3U8ç‰¹æ®Šå¤„ç†ï¼šè®¡ç®—åŸºç¡€è·¯å¾„å¹¶é‡å†™TSè·¯å¾„
          if (video.type === 'm3u8') {
            playerType = 'hls'

            // 1. è·å–M3U8æ–‡ä»¶æ‰€åœ¨ç›®å½•ä½œä¸ºåŸºç¡€è·¯å¾„
            const basePath = finalUrl.substring(
              0,
              finalUrl.lastIndexOf('/') + 1
            )

            // 2. è¦†ç›–HLSè‡ªå®šä¹‰å¤„ç†é€»è¾‘
            dp.customType['hls'] = function (videoElement) {
              const hls = new Hls()

              // ç›‘å¬æ¸…å•è§£æäº‹ä»¶ï¼Œé‡å†™TSè·¯å¾„
              hls.on(Hls.Events.MANIFEST_PARSED, (event, data) => {
                data.levels.forEach((level) => {
                  // ä¿ç•™TSæ–‡ä»¶å + æ‹¼æ¥åŸºç¡€è·¯å¾„
                  const tsName = level.url.split('/').pop()
                  level.url = basePath + tsName
                })
              })

              hls.loadSource(finalUrl)
              hls.attachMedia(videoElement)
            }
          }
          // å…¶ä»–æ ¼å¼å¤„ç†ä¿æŒä¸å˜
          else if (video.type === 'torrent') {
            playerType = 'webtorrent'
          } else if (video.type === 'dash') {
            playerType = 'dash'
          }

          // åˆ‡æ¢è§†é¢‘ï¼ˆM3U8ä½¿ç”¨è‡ªå®šä¹‰hlså¤„ç†ï¼‰
          dp.switchVideo({
            url: finalUrl,
            type: playerType,
            pic: '',
            thumbnails: '',
          })

          // äº‹ä»¶ç›‘å¬ï¼ˆä¿æŒä¸å˜ï¼‰
          dp.on('canplay', () => {
            updateStatus('æ­£åœ¨æ’­æ”¾: ' + video.title, 'playing')
          })
          dp.on('error', (err) => {
            updateStatus('æ’­æ”¾é”™è¯¯: ' + err.message, 'error')
          })
          dp.play()
        } catch (e) {
          console.error('æ’­æ”¾å¤±è´¥:', e)
          updateStatus('æ’­æ”¾å¤±è´¥: ' + e.message, 'error')
        }
      }

      // æ ¹æ®æ–‡ä»¶åæˆ–URLè·å–æ–‡ä»¶ç±»å‹
      function getFileType(filename) {
        // å¤„ç†ç£åŠ›é“¾æ¥
        if (filename.startsWith('magnet:')) {
          return 'webtorrent'
        }

        // å¤„ç†URLä¸­çš„æ–‡ä»¶ç±»å‹
        const url = filename.toLowerCase()
        if (url.includes('.m3u8') || url.includes('.ts')) return 'm3u8'
        if (url.includes('.flv')) return 'flv'
        if (url.includes('.mpd') || url.includes('.m4s')) return 'dash'
        if (url.includes('.torrent')) return 'torrent'
        if (url.includes('webtorrent')) return 'webtorrent'

        // å¤„ç†æ–‡ä»¶æ‰©å±•å
        const ext = filename.split('.').pop().toLowerCase()
        switch (ext) {
          case 'm3u8':
          case 'ts':
            return 'm3u8'
          case 'flv':
            return 'flv'
          case 'mpd':
          case 'm4s':
            return 'dash'
          case 'torrent':
            return 'torrent'
          case 'mp4':
          case 'm4v':
            return 'mp4'
          case 'webm':
            return 'webm'
          case 'ogg':
          case 'ogv':
            return 'ogg'
          default:
            return ext
        }
      }

      // æ‹–æ”¾åŠŸèƒ½æ”¯æŒ
      playlistEl.addEventListener('dragover', (e) => {
        e.preventDefault()
        e.dataTransfer.dropEffect = 'copy'
      })

      playlistEl.addEventListener('drop', (e) => {
        e.preventDefault()
        const files = e.dataTransfer.files
        if (files.length) {
          Array.from(files).forEach((file) => {
            if (
              file.type.startsWith('video/') ||
              file.name.endsWith('.torrent')
            ) {
              const url = URL.createObjectURL(file)
              const type = getFileType(file.name)
              addToPlaylist({
                title: file.name,
                url: url,
                type: type,
              })
            }
          })
        }
      })

      // åˆå§‹åŒ–çŠ¶æ€
      updateStatus('å°±ç»ª')
    </script>
  </body>
</html>
