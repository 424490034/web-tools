<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>è§†é¢‘æˆªå›¾å·¥å…· - åŸºäºFFmpeg.wasm</title>
    <script src="./ffmpeg.min.js"></script>
    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      }

      body {
        background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
        color: #fff;
        min-height: 100vh;
        padding: 20px;
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      .container {
        width: 100%;
        max-width: 1200px;
        background: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        padding: 30px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        margin-top: 20px;
      }

      header {
        text-align: center;
        margin-bottom: 30px;
      }

      h1 {
        font-size: 2.8rem;
        margin-bottom: 10px;
        background: linear-gradient(to right, #ff9966, #ff5e62);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      }

      .subtitle {
        font-size: 1.2rem;
        color: #ddd;
        margin-bottom: 30px;
      }

      .panels {
        display: flex;
        gap: 25px;
        margin-bottom: 30px;
        flex-wrap: wrap;
      }

      .panel {
        flex: 1;
        min-width: 300px;
        background: rgba(30, 30, 40, 0.85);
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      }

      .panel-title {
        font-size: 1.5rem;
        margin-bottom: 20px;
        color: #4facfe;
        display: flex;
        align-items: center;
      }

      .panel-title i {
        margin-right: 10px;
        font-size: 1.8rem;
      }

      .file-upload {
        position: relative; /* å…³é”®ï¼šå»ºç«‹ç›¸å¯¹å®šä½å®¹å™¨ */
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        cursor: pointer;
        border: 2px dashed #5d9cec;
        border-radius: 10px;
        padding: 30px;
        text-align: center;
        transition: all 0.3s ease;
        margin-bottom: 20px;
        overflow: hidden; /* é˜²æ­¢å­å…ƒç´ æº¢å‡º */
        height: 150px; /* å»ºè®®å›ºå®šé«˜åº¦ï¼Œç¡®ä¿è¦†ç›–åŒºåŸŸç»Ÿä¸€ */
      }

      /* éšè—åŸç”Ÿinputå¹¶ç”¨ç»å¯¹å®šä½è¦†ç›–æ•´ä¸ªå®¹å™¨ */
      .file-upload input[type='file'] {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        opacity: 0; /* é€æ˜ä½†å¯ç‚¹å‡» */
        cursor: pointer;
      }

      .file-upload:hover {
        background: rgba(93, 156, 236, 0.1);
        transform: translateY(-3px);
      }

      .file-upload p {
        margin: 15px 0;
        font-size: 1.1rem;
      }

      .video-container {
        width: 100%;
        background: #000;
        border-radius: 10px;
        overflow: hidden;
        margin-top: 15px;
        position: relative;
      }

      video {
        width: 100%;
        max-height: 400px;
        display: block;
      }

      .controls {
        display: flex;
        justify-content: center;
        gap: 15px;
        margin-top: 15px;
        flex-wrap: wrap;
      }

      button {
        background: linear-gradient(to right, #4facfe, #00f2fe);
        color: white;
        border: none;
        padding: 12px 25px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
        transition: all 0.3s ease;
        font-size: 1rem;
        flex-shrink: 0;
      }

      button:hover {
        transform: translateY(-3px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      }

      button:disabled {
        background: #666;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .btn-primary {
        background: linear-gradient(to right, #ff9966, #ff5e62);
        padding: 14px 30px;
        font-size: 1.1rem;
      }

      .result-container {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        margin-top: 20px;
      }

      .screenshot-item {
        flex: 1;
        min-width: 250px;
        background: rgba(20, 20, 30, 0.6);
        border-radius: 10px;
        padding: 15px;
        text-align: center;
      }

      .screenshot-item img {
        width: 100%;
        border-radius: 8px;
        margin-bottom: 10px;
        max-height: 300px;
        object-fit: contain;
      }

      .screenshot-info {
        display: flex;
        justify-content: space-between;
        font-size: 0.9rem;
        color: #aaa;
      }

      .progress-container {
        margin: 25px 0;
      }

      .progress-bar {
        height: 12px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 6px;
        overflow: hidden;
        margin-bottom: 10px;
      }

      .progress-fill {
        height: 100%;
        background: linear-gradient(to right, #4facfe, #00f2fe);
        width: 0%;
        transition: width 0.3s ease;
      }

      .status-area {
        min-height: 50px;
        margin: 15px 0;
        padding: 10px;
        border-radius: 8px;
        background: rgba(255, 255, 255, 0.05);
      }

      .status-message {
        color: #4facfe;
        font-weight: bold;
      }

      .error-message {
        color: #ff5e62;
      }

      .instructions {
        background: rgba(30, 30, 40, 0.85);
        border-radius: 15px;
        padding: 20px;
        margin-top: 30px;
      }

      .instructions h3 {
        color: #00f2fe;
        margin-bottom: 15px;
      }

      .instructions ol {
        padding-left: 20px;
        margin-bottom: 15px;
      }

      .instructions li {
        margin-bottom: 10px;
        line-height: 1.6;
      }

      footer {
        margin-top: 30px;
        text-align: center;
        color: #aaa;
        font-size: 0.9rem;
      }

      @media (max-width: 768px) {
        .panels {
          flex-direction: column;
        }

        .controls {
          flex-direction: column;
          align-items: center;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <h1>è§†é¢‘æˆªå›¾å·¥å…·</h1>
      <p class="subtitle">åŸºäº FFmpeg.wasm æŠ€æœ¯ - åœ¨æµè§ˆå™¨ä¸­ç²¾å‡†æˆªå–è§†é¢‘å¸§</p>
    </header>

    <div class="container">
      <div class="panels">
        <div class="panel">
          <h2 class="panel-title">ğŸ“ 1. ä¸Šä¼ è§†é¢‘æ–‡ä»¶</h2>
          <div class="file-upload" id="fileDropArea">
            <p>æ‹–æ”¾è§†é¢‘æ–‡ä»¶åˆ°æ­¤å¤„</p>
            <input type="file" id="videoInput" accept="video/*" />
          </div>

          <div id="videoContainer" class="video-container">
            <video id="videoPlayer" controls>æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾</video>
          </div>

          <div class="controls">
            <button id="captureBtn" class="btn-primary" disabled>
              æˆªå–å½“å‰å¸§
            </button>
            <button id="resetBtn">é‡ç½®æ‰€æœ‰</button>
          </div>

          <div class="progress-container">
            <div class="progress-bar">
              <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-text" id="progressText">å‡†å¤‡å°±ç»ª</div>
          </div>

          <div class="status-area">
            <div class="status-message" id="statusMessage"></div>
            <div class="error-message" id="errorMessage"></div>
          </div>
        </div>

        <div class="panel">
          <h2 class="panel-title">ğŸ–¼ï¸ 2. æˆªå›¾ç»“æœ</h2>
          <div id="resultContainer" class="result-container">
            <p style="text-align: center; width: 100; padding: 40px 0">
              æˆªå›¾å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ
            </p>
          </div>

          <div class="controls">
            <button id="downloadAllBtn" disabled>ä¸‹è½½æ‰€æœ‰æˆªå›¾</button>
          </div>
        </div>
      </div>

      <div class="instructions">
        <h3>ä½¿ç”¨è¯´æ˜ï¼š</h3>
        <ol>
          <li>ä¸Šä¼ è§†é¢‘æ–‡ä»¶ï¼ˆæ”¯æŒMP4ã€MOVã€AVIç­‰æ ¼å¼ï¼‰</li>
          <li>ä½¿ç”¨è§†é¢‘æ’­æ”¾å™¨æ§åˆ¶æ’­æ”¾è¿›åº¦ï¼Œæ‰¾åˆ°æƒ³è¦æˆªå–çš„ç”»é¢</li>
          <li>ç‚¹å‡»"æˆªå–å½“å‰å¸§"æŒ‰é’®ç”Ÿæˆé«˜æ¸…æˆªå›¾</li>
          <li>æˆªå›¾ä¼šæ˜¾ç¤ºåœ¨å³ä¾§åŒºåŸŸï¼Œå¯ä¸‹è½½å•å¼ æˆ–æ‰€æœ‰æˆªå›¾</li>
          <li>ä½¿ç”¨"é‡ç½®æ‰€æœ‰"æŒ‰é’®å¯ä»¥æ¸…é™¤å½“å‰è§†é¢‘å’Œæˆªå›¾</li>
        </ol>
        <p>
          æŠ€æœ¯è¯´æ˜ï¼šä½¿ç”¨FFmpegçš„<code>-ss</code>å‚æ•°æŒ‡å®šæ—¶é—´ç‚¹ï¼Œ<code
            >-vframes 1</code
          >å‚æ•°æˆªå–å•å¸§[6,7](@ref)
        </p>
        <p>
          æ³¨æ„ï¼šæœ¬å·¥å…·å®Œå…¨åœ¨æµè§ˆå™¨ä¸­è¿è¡Œï¼Œä¸ä¼šä¸Šä¼ æ‚¨çš„è§†é¢‘æ–‡ä»¶ï¼Œç¡®ä¿éšç§å®‰å…¨ã€‚
        </p>
      </div>
    </div>

    <footer>
      <p>åŸºäº FFmpeg.wasm æŠ€æœ¯å®ç° | å®Œå…¨åœ¨æµè§ˆå™¨ä¸­è¿è¡Œ | æ— éœ€ä¸Šä¼ åˆ°æœåŠ¡å™¨</p>
      <p>Â© 2025 ç½‘é¡µç‰ˆè§†é¢‘æˆªå›¾å·¥å…·</p>
    </footer>

    <script>
      // FFmpegå®ä¾‹
      let ffmpeg = null
      let inputFile = null
      let videoUrl = null
      let screenshots = []
      let screenshotCount = 0

      // DOMå…ƒç´ 
      const videoInput = document.getElementById('videoInput')
      const videoPlayer = document.getElementById('videoPlayer')
      const captureBtn = document.getElementById('captureBtn')
      const resetBtn = document.getElementById('resetBtn')
      const downloadAllBtn = document.getElementById('downloadAllBtn')
      const statusMessage = document.getElementById('statusMessage')
      const errorMessage = document.getElementById('errorMessage')
      const progressFill = document.getElementById('progressFill')
      const progressText = document.getElementById('progressText')
      const resultContainer = document.getElementById('resultContainer')
      const fileDropArea = document.getElementById('fileDropArea')

      // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬
      function initEvents() {
        // æ–‡ä»¶ä¸Šä¼ å¤„ç†
        videoInput.addEventListener('change', handleFileUpload)

        // æˆªå›¾æŒ‰é’®
        captureBtn.addEventListener('click', captureFrame)

        // é‡ç½®æŒ‰é’®
        resetBtn.addEventListener('click', resetAll)

        // ä¸‹è½½æ‰€æœ‰æˆªå›¾æŒ‰é’®
        downloadAllBtn.addEventListener('click', downloadAllScreenshots)

        // æ‹–æ”¾åŠŸèƒ½
        fileDropArea.addEventListener('dragover', (e) => {
          e.preventDefault()
          fileDropArea.style.borderColor = '#4facfe'
          fileDropArea.style.backgroundColor = 'rgba(93, 156, 236, 0.2)'
        })

        fileDropArea.addEventListener('dragleave', () => {
          fileDropArea.style.borderColor = '#5d9cec'
          fileDropArea.style.backgroundColor = 'transparent'
        })

        fileDropArea.addEventListener('drop', (e) => {
          e.preventDefault()
          fileDropArea.style.borderColor = '#5d9cec'
          fileDropArea.style.backgroundColor = 'transparent'

          if (e.dataTransfer.files.length) {
            videoInput.files = e.dataTransfer.files
            handleFileUpload({ target: { files: e.dataTransfer.files } })
          }
        })
      }

      // å¤„ç†æ–‡ä»¶ä¸Šä¼ 
      function handleFileUpload(event) {
        const file = event.target.files[0]
        if (!file) return

        // æ£€æŸ¥æ–‡ä»¶ç±»å‹
        if (!file.type.match('video.*')) {
          showError('è¯·ä¸Šä¼ è§†é¢‘æ–‡ä»¶', errorMessage)
          return
        }

        inputFile = file
        videoUrl = URL.createObjectURL(file)

        // è®¾ç½®è§†é¢‘æº
        videoPlayer.src = videoUrl

        // å¯ç”¨æˆªå›¾æŒ‰é’®
        captureBtn.disabled = false
        downloadAllBtn.disabled = true

        // é‡ç½®æˆªå›¾
        screenshots = []
        screenshotCount = 0
        updateResultContainer()

        statusMessage.textContent = `å·²åŠ è½½è§†é¢‘: ${file.name} (${formatFileSize(
          file.size
        )})`
        errorMessage.textContent = ''
      }

      // æˆªå–å½“å‰å¸§
      async function captureFrame() {
        if (!inputFile || !videoPlayer.src) {
          showError('è¯·å…ˆä¸Šä¼ è§†é¢‘æ–‡ä»¶', errorMessage)
          return
        }

        let currentTime = videoPlayer.currentTime
        if (currentTime <= 0) {
          currentTime = 0
        }

        // æ˜¾ç¤ºè¿›åº¦
        progressFill.style.width = '0%'
        progressText.textContent = 'åˆå§‹åŒ–ä¸­...'
        captureBtn.disabled = true

        try {
          // åˆå§‹åŒ–FFmpeg
          if (!ffmpeg) {
            statusMessage.textContent = 'æ­£åœ¨åŠ è½½FFmpegå¼•æ“...'

            const { createFFmpeg, fetchFile } = FFmpeg
            ffmpeg = createFFmpeg({
              log: true,
              progress: ({ ratio }) => {
                const percent = Math.floor(ratio * 100)
                progressFill.style.width = `${percent}%`
                progressText.textContent = `å¤„ç†ä¸­: ${percent}%`
              },
            })

            await ffmpeg.load()
          }

          statusMessage.textContent = `æ­£åœ¨æˆªå– ${formatTime(
            currentTime
          )} çš„ç”»é¢...`

          // å†™å…¥è§†é¢‘æ–‡ä»¶åˆ°è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿ
          const inputName = 'input.' + inputFile.name.split('.').pop()
          ffmpeg.FS('writeFile', inputName, await FFmpeg.fetchFile(inputFile))

          // æ„å»ºè¾“å‡ºæ–‡ä»¶å
          const timestamp = Math.floor(currentTime)
          screenshotCount++
          const outputName = `screenshot_${screenshotCount}_${timestamp}s.jpg`

          // æ‰§è¡ŒFFmpegæˆªå›¾å‘½ä»¤
          // ä½¿ç”¨-sså‚æ•°æŒ‡å®šæ—¶é—´ç‚¹ï¼Œ-vframes 1æŒ‡å®šåªå–ä¸€å¸§[6,7](@ref)
          await ffmpeg.run(
            '-ss',
            String(currentTime), // æŒ‡å®šæˆªå›¾æ—¶é—´ç‚¹
            '-i',
            inputName, // è¾“å…¥æ–‡ä»¶
            '-vframes',
            '1', // åªå–ä¸€å¸§
            '-q:v',
            '2', // è¾“å‡ºè´¨é‡
            outputName // è¾“å‡ºæ–‡ä»¶å
          )

          // è¯»å–è¾“å‡ºæ–‡ä»¶
          const data = ffmpeg.FS('readFile', outputName)
          const blob = new Blob([data.buffer], { type: 'image/jpeg' })
          const url = URL.createObjectURL(blob)

          // ä¿å­˜æˆªå›¾ä¿¡æ¯
          screenshots.push({
            id: screenshotCount,
            time: currentTime,
            url: url,
            blob: blob,
            filename: outputName,
          })

          // æ›´æ–°ç»“æœå±•ç¤º
          updateResultContainer()

          progressText.textContent = 'æˆªå›¾å®Œæˆ!'
          statusMessage.textContent = `æˆåŠŸæˆªå– ${formatTime(
            currentTime
          )} çš„ç”»é¢`
          downloadAllBtn.disabled = false
        } catch (error) {
          console.error('æˆªå›¾å¤±è´¥:', error)
          showError(`æˆªå›¾å¤±è´¥: ${error.message}`, errorMessage)
        } finally {
          captureBtn.disabled = false
        }
      }

      // æ›´æ–°ç»“æœå±•ç¤ºåŒºåŸŸ
      function updateResultContainer() {
        if (screenshots.length === 0) {
          resultContainer.innerHTML =
            '<p style="text-align: center; width: 100%; padding: 40px 0;">æˆªå›¾å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ</p>'
          return
        }

        resultContainer.innerHTML = ''
        screenshots.forEach((screenshot) => {
          const item = document.createElement('div')
          item.className = 'screenshot-item'
          item.innerHTML = `
                    <img src="${screenshot.url}" alt="è§†é¢‘æˆªå›¾">
                    <div class="screenshot-info">
                        <span>#${screenshot.id}</span>
                        <span>${formatTime(screenshot.time)}</span>
                    </div>
                    <button class="download-btn" data-id="${
                      screenshot.id
                    }">ä¸‹è½½</button>
                `
          resultContainer.appendChild(item)
        })

        // æ·»åŠ ä¸‹è½½æŒ‰é’®äº‹ä»¶
        document.querySelectorAll('.download-btn').forEach((btn) => {
          btn.addEventListener('click', (e) => {
            const id = parseInt(e.target.getAttribute('data-id'))
            const screenshot = screenshots.find((s) => s.id === id)
            if (screenshot) {
              downloadScreenshot(screenshot)
            }
          })
        })
      }

      // ä¸‹è½½å•å¼ æˆªå›¾
      function downloadScreenshot(screenshot) {
        const a = document.createElement('a')
        a.href = screenshot.url
        a.download = screenshot.filename
        a.click()
      }

      // ä¸‹è½½æ‰€æœ‰æˆªå›¾
      function downloadAllScreenshots() {
        screenshots.forEach((screenshot) => {
          const a = document.createElement('a')
          a.href = screenshot.url
          a.download = screenshot.filename
          document.body.appendChild(a)
          a.click()
          document.body.removeChild(a)
        })
      }

      // é‡ç½®æ‰€æœ‰
      function resetAll() {
        screenshots = []
        screenshotCount = 0

        if (videoUrl) {
          URL.revokeObjectURL(videoUrl)
          videoUrl = null
        }

        // é‡Šæ”¾æˆªå›¾URL
        screenshots.forEach((screenshot) => {
          URL.revokeObjectURL(screenshot.url)
        })

        videoInput.value = ''
        videoPlayer.src = ''
        captureBtn.disabled = true
        downloadAllBtn.disabled = true
        progressFill.style.width = '0%'
        progressText.textContent = 'å‡†å¤‡å°±ç»ª'
        statusMessage.textContent = ''
        errorMessage.textContent = ''
        updateResultContainer()
      }

      // è¾…åŠ©å‡½æ•°
      function showError(message, element) {
        element.textContent = message
        setTimeout(() => {
          element.textContent = ''
        }, 5000)
      }

      function formatFileSize(bytes) {
        if (bytes < 1024) return bytes + ' bytes'
        else if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB'
        else return (bytes / 1048576).toFixed(1) + ' MB'
      }

      function formatTime(seconds) {
        const mins = Math.floor(seconds / 60)
        const secs = Math.floor(seconds % 60)
        return `${mins.toString().padStart(2, '0')}:${secs
          .toString()
          .padStart(2, '0')}`
      }

      // åˆå§‹åŒ–
      window.onload = initEvents
    </script>
  </body>
</html>
