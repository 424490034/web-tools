<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>è§†é¢‘æ°´å°æ·»åŠ å·¥å…·</title>
    <!-- Cropper.js CSS -->
    <link href="./videoFormat/cropper.min.css" rel="stylesheet" />
    <script src="./ffmpeg.min.js"></script>
    <script src="./ffmpeg-core.js"></script>
    <!-- Cropper.js JavaScript -->
    <script src="./videoFormat/cropper.min.js"></script>
    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
        font-family: 'SF Pro Display', 'PingFang SC', 'Helvetica Neue', Arial,
          sans-serif;
      }

      :root {
        --primary-bg: #e6e7ee;
        --secondary-bg: #ffffff;
        --shadow-light: #ffffff;
        --shadow-dark: #d1d9e6;
        --accent-color: #667eea;
        --accent-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        --success-color: #4ecdc4;
        --danger-color: #ff6b6b;
        --warning-color: #feca57;
        --text-primary: #2d3748;
        --text-secondary: #718096;
        --glass-bg: rgba(255, 255, 255, 0.25);
        --glass-border: rgba(255, 255, 255, 0.18);
        --border-radius: 20px;
        --shadow-large: 15px 15px 30px var(--shadow-dark),
          -15px -15px 30px var(--shadow-light);
      }

      body {
        background: var(--primary-bg);
        color: var(--text-primary);
        min-height: 100vh;
        padding: 20px;
        display: flex;
        flex-direction: column;
        align-items: center;
        transition: all 0.3s ease;
        animation: pageLoad 0.8s ease;
      }

      @keyframes pageLoad {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .container {
        width: 100%;
        max-width: 1200px;
        background: var(--primary-bg);
        border-radius: 30px;
        padding: 40px;
        box-shadow: 20px 20px 60px var(--shadow-dark),
          -20px -20px 60px var(--shadow-light);
        margin-top: 20px;
        transition: all 0.3s ease;
        animation: containerFloat 1s ease 0.2s both;
      }

      @keyframes containerFloat {
        from {
          opacity: 0;
          transform: translateY(30px) scale(0.95);
        }
        to {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }

      .container:hover {
        box-shadow: 25px 25px 70px var(--shadow-dark),
          -25px -25px 70px var(--shadow-light);
      }

      header {
        text-align: center;
        margin-bottom: 40px;
        padding: 30px;
        background: var(--primary-bg);
        border-radius: 25px;
        box-shadow: 10px 10px 20px var(--shadow-dark),
          -10px -10px 20px var(--shadow-light);
        animation: headerSlide 0.8s ease 0.4s both;
      }

      @keyframes headerSlide {
        from {
          opacity: 0;
          transform: translateY(-30px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      h1 {
        font-size: 3.2rem;
        margin-bottom: 15px;
        background: var(--accent-gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        font-weight: 700;
        animation: titleGlow 3s ease-in-out infinite alternate;
      }

      @keyframes titleGlow {
        from {
          filter: brightness(1);
        }
        to {
          filter: brightness(1.2);
        }
      }

      .subtitle {
        font-size: 1.3rem;
        color: var(--text-secondary);
        margin-bottom: 30px;
        font-weight: 500;
      }

      .main-content {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 30px;
        margin-bottom: 40px;
        animation: panelsSlide 0.8s ease 0.6s both;
        align-items: start;
      }

      @media (max-width: 1024px) {
        .main-content {
          grid-template-columns: 1fr;
          gap: 25px;
        }

        .control-panel {
          order: 2;
        }

        .video-panel {
          order: 1;
        }
      }

      @media (max-width: 768px) {
        .main-content {
          gap: 20px;
        }

        .video-panel,
        .control-panel {
          padding: 20px;
        }

        .time-controls,
        .watermark-settings,
        .output-settings {
          padding: 20px;
        }

        .action-buttons {
          flex-direction: column;
          gap: 10px;
        }
      }

      @keyframes panelsSlide {
        from {
          opacity: 0;
          transform: translateX(-20px);
        }
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }

      .video-panel {
        background: var(--primary-bg);
        border-radius: 25px;
        padding: 30px;
        box-shadow: 12px 12px 24px var(--shadow-dark),
          -12px -12px 24px var(--shadow-light);
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        gap: 25px;
      }

      .video-panel::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.1),
          transparent
        );
        transition: left 0.8s;
      }

      .video-panel:hover::before {
        left: 100%;
      }

      .video-panel:hover {
        transform: translateY(-5px);
        box-shadow: 16px 16px 32px var(--shadow-dark),
          -16px -16px 32px var(--shadow-light);
      }

      .control-panel {
        background: var(--primary-bg);
        border-radius: 25px;
        padding: 30px;
        box-shadow: 12px 12px 24px var(--shadow-dark),
          -12px -12px 24px var(--shadow-light);
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        gap: 25px;
      }

      .time-controls,
      .watermark-settings,
      .output-settings {
        background: rgba(255, 255, 255, 0.02);
        border-radius: 20px;
        padding: 25px;
        border: 1px solid rgba(255, 255, 255, 0.05);
        box-shadow: inset 6px 6px 12px var(--shadow-dark),
          inset -6px -6px 12px var(--shadow-light);
        transition: all 0.3s ease;
        margin-top: 0;
      }

      .video-panel .time-controls,
      .video-panel .watermark-settings {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
      }

      .time-controls:hover,
      .watermark-settings:hover,
      .output-settings:hover {
        transform: translateY(-2px);
        box-shadow: inset 8px 8px 16px var(--shadow-dark),
          inset -8px -8px 16px var(--shadow-light),
          0 8px 20px rgba(0, 0, 0, 0.1);
      }

      .action-buttons {
        display: flex;
        gap: 15px;
        justify-content: center;
        flex-wrap: wrap;
        margin-top: 10px;
      }

      .control-panel::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.1),
          transparent
        );
        transition: left 0.8s;
      }

      .control-panel:hover::before {
        left: 100%;
      }

      .control-panel:hover {
        transform: translateY(-5px);
        box-shadow: 16px 16px 32px var(--shadow-dark),
          -16px -16px 32px var(--shadow-light);
      }

      .panel-title {
        font-size: 1.6rem;
        margin-bottom: 25px;
        color: var(--accent-color);
        display: flex;
        align-items: center;
        font-weight: 600;
      }

      .panel-title::before {
        content: attr(data-icon);
        margin-right: 12px;
        font-size: 1.8rem;
        animation: iconBounce 2s ease-in-out infinite;
      }

      @keyframes iconBounce {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.1);
        }
      }

      .file-upload {
        border: 3px dashed var(--accent-color);
        border-radius: 25px;
        padding: 50px 40px;
        text-align: center;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        margin-bottom: 25px;
        cursor: pointer;
        background: var(--primary-bg);
        box-shadow: inset 8px 8px 16px var(--shadow-dark),
          inset -8px -8px 16px var(--shadow-light);
        position: relative;
        overflow: hidden;
      }

      .file-upload:hover {
        border-color: var(--success-color);
        transform: translateY(-5px) scale(1.02);
        box-shadow: inset 10px 10px 20px var(--shadow-dark),
          inset -10px -10px 20px var(--shadow-light),
          0 15px 40px rgba(102, 126, 234, 0.25), 0 5px 15px rgba(0, 0, 0, 0.1);
      }

      .file-upload.dragover {
        border-color: var(--success-color);
        background: rgba(78, 205, 196, 0.05);
        transform: scale(1.05);
        box-shadow: inset 12px 12px 24px var(--shadow-dark),
          inset -12px -12px 24px var(--shadow-light),
          0 20px 50px rgba(78, 205, 196, 0.3);
        animation: dragPulse 1s ease-in-out infinite;
      }

      @keyframes dragPulse {
        0%,
        100% {
          border-color: var(--success-color);
        }
        50% {
          border-color: var(--accent-color);
        }
      }

      .file-upload-content {
        position: relative;
        z-index: 1;
      }

      .file-upload-icon {
        font-size: 3.5rem;
        margin-bottom: 20px;
        display: block;
        animation: iconFloat 3s ease-in-out infinite;
        filter: drop-shadow(0 4px 8px rgba(102, 126, 234, 0.2));
      }

      @keyframes iconFloat {
        0%,
        100% {
          transform: translateY(0);
        }
        50% {
          transform: translateY(-10px);
        }
      }

      .file-upload-text {
        font-size: 1.4rem;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 10px;
        background: var(--accent-gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .file-upload-subtext {
        font-size: 1.1rem;
        color: var(--text-secondary);
        margin-bottom: 20px;
        font-weight: 500;
      }

      .file-upload-formats {
        font-size: 0.9rem;
        color: var(--accent-color);
        font-weight: 500;
        padding: 8px 16px;
        background: rgba(102, 126, 234, 0.1);
        border-radius: 20px;
        display: inline-block;
        margin-bottom: 20px;
      }

      .file-upload input[type='file'] {
        position: absolute;
        width: 100%;
        height: 100%;
        top: 0;
        left: 0;
        opacity: 0;
        cursor: pointer;
        z-index: 2;
      }

      .video-container {
        position: relative;
        width: 100%;
        background: var(--primary-bg);
        border-radius: 20px;
        overflow: hidden;
        margin-top: 20px;
        box-shadow: inset 10px 10px 20px var(--shadow-dark),
          inset -10px -10px 20px var(--shadow-light);
        transition: all 0.3s ease;
      }

      .video-container:hover {
        box-shadow: inset 12px 12px 24px var(--shadow-dark),
          inset -12px -12px 24px var(--shadow-light);
      }

      video {
        width: 100%;
        height: auto;
        display: block;
        border-radius: 15px;
      }

      .watermark-region {
        position: absolute;
        border: 3px solid var(--accent-color);
        background: rgba(102, 126, 234, 0.15);
        cursor: move;
        pointer-events: all;
        min-width: 50px;
        min-height: 50px;
        box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.3),
          0 0 20px rgba(102, 126, 234, 0.4);
        transition: all 0.3s ease;
        touch-action: none;
        border-radius: 8px;
        user-select: none;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
        font-size: 14px;
        text-align: center;
        overflow: hidden;
      }

      .watermark-region:hover {
        border-color: var(--warning-color);
        background: rgba(254, 202, 87, 0.15);
        box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.4),
          0 0 30px rgba(254, 202, 87, 0.5);
      }

      .watermark-region.selected {
        border-color: var(--success-color);
        background: rgba(78, 205, 196, 0.15);
        box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.4),
          0 0 30px rgba(78, 205, 196, 0.5);
      }

      .watermark-region img {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
      }

      .region-handle {
        position: absolute;
        width: 16px;
        height: 16px;
        background: var(--accent-color);
        border: 3px solid white;
        border-radius: 50%;
        cursor: pointer;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        transition: all 0.3s ease;
        z-index: 20;
        touch-action: none;
      }

      .region-handle:hover {
        transform: scale(1.2);
        box-shadow: 0 4px 16px rgba(102, 126, 234, 0.4);
      }

      .region-handle.nw {
        top: -8px;
        left: -8px;
        cursor: nw-resize;
      }
      .region-handle.ne {
        top: -8px;
        right: -8px;
        cursor: ne-resize;
      }
      .region-handle.sw {
        bottom: -8px;
        left: -8px;
        cursor: sw-resize;
      }
      .region-handle.se {
        bottom: -8px;
        right: -8px;
        cursor: se-resize;
      }
      .region-handle.n {
        top: -8px;
        left: 50%;
        transform: translateX(-50%);
        cursor: n-resize;
      }
      .region-handle.s {
        bottom: -8px;
        left: 50%;
        transform: translateX(-50%);
        cursor: s-resize;
      }
      .region-handle.w {
        top: 50%;
        left: -8px;
        transform: translateY(-50%);
        cursor: w-resize;
      }
      .region-handle.e {
        top: 50%;
        right: -8px;
        transform: translateY(-50%);
        cursor: e-resize;
      }

      .region-label {
        position: absolute;
        top: -30px;
        left: 0;
        background: var(--accent-color);
        color: white;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: 600;
        white-space: nowrap;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      }

      .region-delete {
        position: absolute;
        top: -12px;
        right: -12px;
        width: 24px;
        height: 24px;
        background: var(--danger-color);
        color: white;
        border: none;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.8rem;
        font-weight: bold;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        transition: all 0.3s ease;
        z-index: 21;
      }

      .region-delete:hover {
        transform: scale(1.1);
        box-shadow: 0 4px 16px rgba(255, 107, 107, 0.4);
      }

      .form-group {
        margin-bottom: 25px;
      }

      label {
        display: block;
        margin-bottom: 10px;
        color: var(--text-secondary);
        font-weight: 500;
        font-size: 0.95rem;
      }

      input,
      select,
      textarea {
        width: 100%;
        padding: 14px 18px;
        background: var(--primary-bg);
        border: none;
        border-radius: 15px;
        color: var(--text-primary);
        font-size: 1rem;
        font-weight: 500;
        box-shadow: inset 6px 6px 12px var(--shadow-dark),
          inset -6px -6px 12px var(--shadow-light);
        transition: all 0.3s ease;
      }

      input:focus,
      select:focus,
      textarea:focus {
        outline: none;
        box-shadow: inset 8px 8px 16px var(--shadow-dark),
          inset -8px -8px 16px var(--shadow-light),
          0 0 0 3px rgba(102, 126, 234, 0.2);
      }

      textarea {
        resize: vertical;
        min-height: 80px;
      }

      button {
        background: var(--primary-bg);
        color: var(--text-primary);
        border: none;
        padding: 14px 28px;
        border-radius: 15px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
        font-size: 1rem;
        flex-shrink: 0;
        box-shadow: 8px 8px 16px var(--shadow-dark),
          -8px -8px 16px var(--shadow-light);
        position: relative;
        overflow: hidden;
        min-width: 140px;
      }

      .form-group button,
      .watermark-settings button {
        width: 100%;
        margin-bottom: 15px;
      }

      .action-buttons button {
        flex: 1;
        min-width: 180px;
        margin-bottom: 0;
      }

      button::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.2),
          transparent
        );
        transition: left 0.5s;
      }

      button:hover::before {
        left: 100%;
      }

      button:hover {
        transform: translateY(-3px);
        box-shadow: 12px 12px 24px var(--shadow-dark),
          -12px -12px 24px var(--shadow-light);
      }

      button:active {
        transform: translateY(0);
        box-shadow: inset 6px 6px 12px var(--shadow-dark),
          inset -6px -6px 12px var(--shadow-light);
      }

      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
        box-shadow: 4px 4px 8px var(--shadow-dark),
          -4px -4px 8px var(--shadow-light);
      }

      .btn-primary {
        background: var(--accent-gradient);
        color: white;
        padding: 16px 32px;
        font-size: 1.1rem;
        box-shadow: 8px 8px 16px var(--shadow-dark),
          -8px -8px 16px var(--shadow-light),
          inset 0 1px 0 rgba(255, 255, 255, 0.2);
      }

      .btn-primary:hover {
        box-shadow: 12px 12px 24px var(--shadow-dark),
          -12px -12px 24px var(--shadow-light),
          inset 0 1px 0 rgba(255, 255, 255, 0.2),
          0 0 30px rgba(102, 126, 234, 0.3);
      }

      .btn-success {
        background: linear-gradient(
          135deg,
          var(--success-color) 0%,
          #44a08d 100%
        );
        color: white;
        box-shadow: 8px 8px 16px var(--shadow-dark),
          -8px -8px 16px var(--shadow-light),
          inset 0 1px 0 rgba(255, 255, 255, 0.2);
      }

      .btn-warning {
        background: linear-gradient(
          135deg,
          var(--warning-color) 0%,
          #f39c12 100%
        );
        color: white;
        box-shadow: 8px 8px 16px var(--shadow-dark),
          -8px -8px 16px var(--shadow-light),
          inset 0 1px 0 rgba(255, 255, 255, 0.2);
      }

      .btn-danger {
        background: linear-gradient(
          135deg,
          var(--danger-color) 0%,
          #c0392b 100%
        );
        color: white;
        box-shadow: 8px 8px 16px var(--shadow-dark),
          -8px -8px 16px var(--shadow-light),
          inset 0 1px 0 rgba(255, 255, 255, 0.2);
      }

      .time-controls {
        background: var(--primary-bg);
        border-radius: var(--border-radius);
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: inset 5px 5px 10px var(--shadow-dark),
          inset -5px -5px 10px var(--shadow-light);
      }

      .time-input-group {
        display: flex;
        gap: 15px;
        align-items: center;
        margin-bottom: 15px;
      }

      .time-input {
        flex: 1;
        padding: 10px 15px;
        border: none;
        border-radius: 10px;
        background: var(--secondary-bg);
        box-shadow: inset 3px 3px 6px var(--shadow-dark),
          inset -3px -3px 6px var(--shadow-light);
        transition: all 0.3s ease;
      }

      .time-slider {
        width: 100%;
        height: 8px;
        border-radius: 5px;
        background: var(--primary-bg);
        outline: none;
        box-shadow: inset 3px 3px 6px var(--shadow-dark),
          inset -3px -3px 6px var(--shadow-light);
        -webkit-appearance: none;
        appearance: none;
      }

      .time-slider::-webkit-slider-thumb {
        appearance: none;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: var(--accent-gradient);
        cursor: pointer;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        transition: all 0.3s ease;
      }

      .time-slider::-webkit-slider-thumb:hover {
        transform: scale(1.2);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
      }

      .progress-container {
        margin-top: 30px;
        padding: 25px;
        background: var(--primary-bg);
        border-radius: 20px;
        box-shadow: inset 8px 8px 16px var(--shadow-dark),
          inset -8px -8px 16px var(--shadow-light);
        animation: progressSlide 0.5s ease;
      }

      @keyframes progressSlide {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .progress-bar {
        width: 100%;
        height: 12px;
        background: var(--primary-bg);
        border-radius: 6px;
        overflow: hidden;
        box-shadow: inset 4px 4px 8px var(--shadow-dark),
          inset -4px -4px 8px var(--shadow-light);
        margin-bottom: 15px;
      }

      .progress-fill {
        height: 100%;
        background: var(--accent-gradient);
        border-radius: 6px;
        transition: width 0.3s ease;
        box-shadow: 0 0 10px rgba(102, 126, 234, 0.3);
      }

      .progress-text {
        text-align: center;
        color: var(--text-primary);
        font-weight: 600;
        font-size: 1.1rem;
      }

      .status-message {
        padding: 15px 20px;
        margin: 20px 0;
        border-radius: 15px;
        background: rgba(78, 205, 196, 0.1);
        border-left: 4px solid var(--success-color);
        color: var(--success-color);
        font-weight: 600;
        animation: statusSlide 0.3s ease;
      }

      .error-message {
        padding: 15px 20px;
        margin: 20px 0;
        border-radius: 15px;
        background: rgba(255, 107, 107, 0.1);
        border-left: 4px solid var(--danger-color);
        color: var(--danger-color);
        font-weight: 600;
        animation: errorShake 0.5s ease;
      }

      @keyframes statusSlide {
        from {
          opacity: 0;
          transform: translateX(-20px);
        }
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }

      @keyframes errorShake {
        0%,
        100% {
          transform: translateX(0);
        }
        25% {
          transform: translateX(-5px);
        }
        75% {
          transform: translateX(5px);
        }
      }

      /* æ¨¡æ€å¼¹çª—æ ·å¼ */
      .modal {
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100vw;
        height: 100vh;
        background-color: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(5px);
        display: flex;
        justify-content: center;
        align-items: center;
        animation: modalFadeIn 0.3s ease;
      }

      @keyframes modalFadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      .modal-content {
        background: var(--primary-bg);
        border-radius: 25px;
        box-shadow: 20px 20px 60px var(--shadow-dark),
          -20px -20px 60px var(--shadow-light);
        width: 90%;
        max-width: 1000px;
        max-height: 90vh;
        overflow: hidden;
        animation: modalSlideIn 0.3s ease;
        display: flex;
        flex-direction: column;
      }

      @keyframes modalSlideIn {
        from {
          transform: translateY(-50px) scale(0.9);
          opacity: 0;
        }
        to {
          transform: translateY(0) scale(1);
          opacity: 1;
        }
      }

      .modal-header {
        padding: 25px 30px;
        border-bottom: 1px solid var(--shadow-dark);
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: var(--primary-bg);
      }

      .modal-header h3 {
        margin: 0;
        color: var(--accent-color);
        font-size: 1.5rem;
        font-weight: 600;
      }

      .modal-close {
        font-size: 2rem;
        color: var(--text-secondary);
        cursor: pointer;
        transition: all 0.3s ease;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        background: var(--primary-bg);
        box-shadow: 5px 5px 10px var(--shadow-dark),
          -5px -5px 10px var(--shadow-light);
      }

      .modal-close:hover {
        color: var(--danger-color);
        transform: scale(1.1);
        box-shadow: 8px 8px 16px var(--shadow-dark),
          -8px -8px 16px var(--shadow-light);
      }

      .modal-body {
        padding: 30px;
        flex: 1;
        overflow-y: auto;
        min-height: 0;
      }

      .video-info {
        display: flex;
        justify-content: space-between;
        margin-bottom: 20px;
        padding: 15px;
        background: var(--primary-bg);
        border-radius: 15px;
        box-shadow: inset 5px 5px 10px var(--shadow-dark),
          inset -5px -5px 10px var(--shadow-light);
      }

      .video-info span {
        font-weight: 500;
        color: var(--text-primary);
      }

      .cropper-container {
        margin-top: 20px;
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 8px 8px 16px var(--shadow-dark),
          -8px -8px 16px var(--shadow-light);
      }

      .modal-footer {
        padding: 20px 30px;
        border-top: 1px solid var(--shadow-dark);
        display: flex;
        gap: 15px;
        justify-content: center;
        background: var(--primary-bg);
        flex-shrink: 0;
      }

      .modal-footer button {
        width: auto;
        margin: 0;
        padding: 12px 30px;
      }

      .watermark-list {
        max-height: 300px;
        overflow-y: auto;
      }

      .watermark-item {
        background: var(--primary-bg);
        border-radius: 15px;
        padding: 15px;
        margin-bottom: 10px;
        box-shadow: 6px 6px 12px var(--shadow-dark),
          -6px -6px 12px var(--shadow-light);
        transition: all 0.3s ease;
      }

      .watermark-item:hover {
        transform: translateY(-2px);
        box-shadow: 8px 8px 16px var(--shadow-dark),
          -8px -8px 16px var(--shadow-light);
      }

      .watermark-item-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
      }

      .watermark-item-title {
        font-weight: 600;
        color: var(--text-primary);
      }

      .watermark-item-info {
        font-size: 0.9rem;
        color: var(--text-secondary);
        margin-bottom: 10px;
      }

      .watermark-item-actions {
        display: flex;
        gap: 10px;
      }

      .watermark-item-actions button {
        flex: 1;
        margin: 0;
        padding: 8px 16px;
        font-size: 0.9rem;
        min-width: auto;
      }

      .instructions {
        background: var(--primary-bg);
        border-radius: 25px;
        padding: 30px;
        margin-top: 40px;
        box-shadow: 10px 10px 20px var(--shadow-dark),
          -10px -10px 20px var(--shadow-light);
        animation: instructionsSlide 0.8s ease 1.4s both;
      }

      @keyframes instructionsSlide {
        from {
          opacity: 0;
          transform: translateY(30px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .instructions h3 {
        color: var(--accent-color);
        margin-bottom: 20px;
        font-size: 1.4rem;
        font-weight: 600;
      }

      .instructions ol {
        padding-left: 25px;
        margin-bottom: 20px;
      }

      .instructions li {
        margin-bottom: 12px;
        line-height: 1.7;
        color: var(--text-secondary);
        font-weight: 500;
      }

      .instructions p {
        color: var(--text-secondary);
        font-style: italic;
        font-weight: 500;
        padding: 15px;
        background: rgba(102, 126, 234, 0.1);
        border-radius: 15px;
        border-left: 4px solid var(--accent-color);
      }

      @media (max-width: 1200px) {
        .main-content {
          grid-template-columns: 1fr;
          gap: 20px;
        }

        .control-panel {
          order: -1;
        }
      }

      @media (max-width: 768px) {
        .container {
          padding: 20px;
          margin: 10px;
        }

        h1 {
          font-size: 2.5rem;
        }

        .subtitle {
          font-size: 1.1rem;
        }

        .time-input-group {
          flex-direction: column;
          gap: 10px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>ğŸ¬ è§†é¢‘æ°´å°æ·»åŠ å·¥å…·</h1>
        <p class="subtitle">ä¸ºè§†é¢‘æ·»åŠ è‡ªå®šä¹‰æ°´å°ï¼Œæ”¯æŒæ–‡å­—å’Œå›¾ç‰‡æ°´å°</p>
      </header>

      <div class="main-content">
        <!-- è§†é¢‘é¢„è§ˆåŒºåŸŸ -->
        <div class="video-panel">
          <div class="panel-title" data-icon="ğŸ¥">è§†é¢‘é¢„è§ˆ</div>

          <div class="file-upload" id="fileUpload">
            <div class="file-upload-content">
              <span class="file-upload-icon">ğŸ“</span>
              <div class="file-upload-text">ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ è§†é¢‘æ–‡ä»¶</div>
              <div class="file-upload-subtext">æ”¯æŒå¤šç§è§†é¢‘æ ¼å¼</div>
              <div class="file-upload-formats">MP4, AVI, MOV, MKV, WebM</div>
            </div>
          </div>
          <input
            type="file"
            id="videoInput"
            accept="video/*"
            style="display: none"
          />

          <div
            class="video-container"
            id="videoContainer"
            style="display: none"
          >
            <video id="videoPreview" controls></video>
          </div>

          <!-- æ—¶é—´æ§åˆ¶åŒºåŸŸ -->
          <div class="time-controls" id="videoControls" style="display: none">
            <div class="panel-title" data-icon="â±ï¸">æ—¶é—´èŒƒå›´è®¾ç½®</div>
            <div class="time-input-group">
              <div>
                <label>å¼€å§‹æ—¶é—´ (ç§’)</label>
                <input
                  type="number"
                  id="startTime"
                  class="time-input"
                  value="0"
                  min="0"
                  step="0.1"
                />
              </div>
              <div>
                <label>ç»“æŸæ—¶é—´ (ç§’)</label>
                <input
                  type="number"
                  id="endTime"
                  class="time-input"
                  value="10"
                  min="0"
                  step="0.1"
                />
              </div>
            </div>
            <input
              type="range"
              id="timeSlider"
              class="time-slider"
              min="0"
              max="100"
              value="0"
              step="0.1"
              style="padding-left: 0"
            />
            <div
              style="
                display: flex;
                gap: 10px;
                justify-content: center;
                margin-top: 10px;
              "
            >
              <button
                class="btn-small"
                onclick="watermarkAdder.setCurrentTimeAsStart()"
              >
                è®¾ä¸ºå¼€å§‹æ—¶é—´
              </button>
              <button
                class="btn-small"
                onclick="watermarkAdder.setCurrentTimeAsEnd()"
              >
                è®¾ä¸ºç»“æŸæ—¶é—´
              </button>
            </div>
          </div>

          <!-- æ°´å°è®¾ç½®åŒºåŸŸ -->
          <div class="watermark-settings">
            <div class="panel-title" data-icon="âš™ï¸">æ°´å°è®¾ç½®</div>

            <div class="form-group">
              <button id="addWatermarkBtn" class="btn-primary">
                â• æ·»åŠ æ°´å°åŒºåŸŸ
              </button>
            </div>

            <div class="watermark-list" id="watermarkList">
              <div
                style="
                  text-align: center;
                  color: var(--text-secondary);
                  padding: 20px;
                "
              >
                æš‚æ— æ°´å°åŒºåŸŸ<br />
                <small>ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æ·»åŠ æ°´å°åŒºåŸŸ</small>
              </div>
            </div>
          </div>
        </div>

        <!-- æ§åˆ¶é¢æ¿åŒºåŸŸ -->
        <div class="control-panel">
          <!-- è¾“å‡ºè®¾ç½®åŒºåŸŸ -->
          <div class="output-settings">
            <div class="panel-title" data-icon="ğŸ¬">è¾“å‡ºè®¾ç½®</div>

            <div class="form-group">
              <label for="outputFormat">è¾“å‡ºæ ¼å¼</label>
              <select id="outputFormat">
                <option value="mp4">MP4 (æ¨è)</option>
                <option value="avi">AVI</option>
                <option value="mov">MOV</option>
                <option value="mkv">MKV</option>
              </select>
            </div>

            <div class="form-group">
              <label for="quality">è§†é¢‘è´¨é‡</label>
              <select id="quality">
                <option value="high">é«˜è´¨é‡ (è¾ƒæ…¢)</option>
                <option value="medium" selected>ä¸­ç­‰è´¨é‡ (æ¨è)</option>
                <option value="low">ä½è´¨é‡ (è¾ƒå¿«)</option>
              </select>
            </div>
          </div>

          <!-- æ“ä½œæŒ‰é’®åŒºåŸŸ -->
          <div class="action-buttons">
            <button id="processBtn" class="btn-success" disabled>
              ğŸš€ å¼€å§‹æ·»åŠ æ°´å°
            </button>
            <button id="clearAllBtn" class="btn-danger">ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰åŒºåŸŸ</button>
          </div>
        </div>
      </div>

      <div
        class="progress-container"
        id="progressContainer"
        style="display: none"
      >
        <div class="progress-bar">
          <div class="progress-fill" id="progressFill"></div>
        </div>
        <div class="progress-text" id="progressText">å‡†å¤‡å¤„ç†...</div>
      </div>

      <!-- çŠ¶æ€æ¶ˆæ¯ -->
      <div
        id="statusMessage"
        class="status-message"
        style="display: none"
      ></div>
      <div id="errorMessage" class="error-message" style="display: none"></div>

      <!-- ä½¿ç”¨è¯´æ˜ -->
      <div class="instructions">
        <h3>ğŸ“– ä½¿ç”¨è¯´æ˜</h3>
        <ol>
          <li>ä¸Šä¼ éœ€è¦æ·»åŠ æ°´å°çš„è§†é¢‘æ–‡ä»¶</li>
          <li>è®¾ç½®æ°´å°æ˜¾ç¤ºçš„æ—¶é—´èŒƒå›´ï¼ˆå¼€å§‹æ—¶é—´å’Œç»“æŸæ—¶é—´ï¼‰</li>
          <li>ç‚¹å‡»"æ·»åŠ æ°´å°åŒºåŸŸ"æŒ‰é’®ï¼Œåœ¨å¼¹å‡ºçš„çª—å£ä¸­é€‰æ‹©æ°´å°ä½ç½®</li>
          <li>é€‰æ‹©æ°´å°ç±»å‹ï¼ˆæ–‡å­—æˆ–å›¾ç‰‡ï¼‰å¹¶è®¾ç½®ç›¸å…³å‚æ•°</li>
          <li>å¯ä»¥æ·»åŠ å¤šä¸ªæ°´å°åŒºåŸŸï¼Œæ¯ä¸ªåŒºåŸŸå¯ä»¥æœ‰ä¸åŒçš„å†…å®¹å’Œæ ·å¼</li>
          <li>é€‰æ‹©è¾“å‡ºæ ¼å¼å’Œè´¨é‡ï¼Œç‚¹å‡»"å¼€å§‹æ·»åŠ æ°´å°"è¿›è¡Œå¤„ç†</li>
        </ol>
        <p>
          ğŸ’¡
          æç¤ºï¼šæ”¯æŒæ–‡å­—æ°´å°å’Œå›¾ç‰‡æ°´å°ï¼Œå¯ä»¥è°ƒæ•´é€æ˜åº¦ã€é¢œè‰²ã€å¤§å°ç­‰å±æ€§ã€‚å¤„ç†å®Œæˆåå¯ä»¥é¢„è§ˆå’Œä¸‹è½½ç»“æœã€‚
        </p>
      </div>
    </div>
    <!-- æ°´å°åŒºåŸŸé€‰æ‹©æ¨¡æ€å¼¹çª— -->
    <div class="modal" id="watermarkModal" style="display: none">
      <div class="modal-content">
        <div class="modal-header">
          <h3>ğŸ¯ é€‰æ‹©æ°´å°ä½ç½®</h3>
          <span class="modal-close" id="modalClose">&times;</span>
        </div>
        <div class="modal-body">
          <div class="video-info">
            <span id="videoResolution">è§†é¢‘å°ºå¯¸: åŠ è½½ä¸­...</span>
            <span id="selectionInfo">é€‰æ‹©åŒºåŸŸ: æœªé€‰æ‹©</span>
          </div>
          <div class="cropper-container">
            <img id="cropperImage" style="max-width: 100%" />
          </div>

          <!-- æ°´å°å†…å®¹è®¾ç½® -->
          <div style="margin-top: 20px">
            <div class="form-group">
              <label>æ°´å°ç±»å‹</label>
              <select id="watermarkType">
                <option value="text">æ–‡å­—æ°´å°</option>
                <option value="image">å›¾ç‰‡æ°´å°</option>
              </select>
            </div>

            <!-- æ–‡å­—æ°´å°è®¾ç½® -->
            <div id="textWatermarkSettings">
              <div class="form-group">
                <label>æ°´å°æ–‡å­—</label>
                <input
                  type="text"
                  id="watermarkText"
                  placeholder="è¯·è¾“å…¥æ°´å°æ–‡å­—"
                  value="æ°´å°æ–‡å­—"
                />
              </div>
              <div class="form-group">
                <label>å­—ä½“å¤§å°</label>
                <input
                  type="number"
                  id="fontSize"
                  value="24"
                  min="12"
                  max="100"
                />
              </div>
              <div class="form-group">
                <label>å­—ä½“é¢œè‰²</label>
                <input type="color" id="fontColor" value="#ffffff" />
              </div>
              <div class="form-group">
                <label>é€æ˜åº¦</label>
                <input
                  type="range"
                  id="opacity"
                  min="0"
                  max="1"
                  step="0.1"
                  value="0.8"
                />
                <span id="opacityValue">0.8</span>
              </div>
            </div>

            <!-- å›¾ç‰‡æ°´å°è®¾ç½® -->
            <div id="imageWatermarkSettings" style="display: none">
              <div class="form-group">
                <label>é€‰æ‹©æ°´å°å›¾ç‰‡</label>
                <input type="file" id="watermarkImage" accept="image/*" />
              </div>
              <div class="form-group">
                <label>å›¾ç‰‡é€æ˜åº¦</label>
                <input
                  type="range"
                  id="imageOpacity"
                  min="0"
                  max="1"
                  step="0.1"
                  value="0.8"
                />
                <span id="imageOpacityValue">0.8</span>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button id="confirmCropBtn" class="btn-success">âœ… ç¡®è®¤æ·»åŠ </button>
          <button id="cancelCropBtn" class="btn-danger">âŒ å–æ¶ˆ</button>
        </div>
      </div>
    </div>

    <script>
      class WatermarkAdder {
        constructor() {
          this.ffmpeg = null
          this.videoFile = null
          this.watermarkRegions = []
          this.regionCounter = 0
          this.cropper = null
          this.canvas = null
          this.watermarkImageFile = null

          this.initializeElements()
          this.setupEventListeners()
          this.loadFFmpeg()
        }

        initializeElements() {
          // åŸºç¡€å…ƒç´ 
          this.fileUpload = document.getElementById('fileUpload')
          this.videoInput = document.getElementById('videoInput')
          this.videoPreview = document.getElementById('videoPreview')
          this.videoContainer = document.getElementById('videoContainer')
          this.addWatermarkBtn = document.getElementById('addWatermarkBtn')
          this.watermarkList = document.getElementById('watermarkList')
          this.processBtn = document.getElementById('processBtn')
          this.clearAllBtn = document.getElementById('clearAllBtn')
          this.progressContainer = document.getElementById('progressContainer')
          this.progressFill = document.getElementById('progressFill')
          this.progressText = document.getElementById('progressText')
          this.statusMessage = document.getElementById('statusMessage')
          this.errorMessage = document.getElementById('errorMessage')
          this.outputFormat = document.getElementById('outputFormat')
          this.quality = document.getElementById('quality')

          // Cropperç›¸å…³å…ƒç´ 
          this.cropperImage = document.getElementById('cropperImage')
          this.confirmCropBtn = document.getElementById('confirmCropBtn')
          this.cancelCropBtn = document.getElementById('cancelCropBtn')

          // æ°´å°è®¾ç½®å…ƒç´ 
          this.watermarkType = document.getElementById('watermarkType')
          this.watermarkText = document.getElementById('watermarkText')
          this.fontSize = document.getElementById('fontSize')
          this.fontColor = document.getElementById('fontColor')
          this.opacity = document.getElementById('opacity')
          this.opacityValue = document.getElementById('opacityValue')
          this.watermarkImage = document.getElementById('watermarkImage')
          this.imageOpacity = document.getElementById('imageOpacity')
          this.imageOpacityValue = document.getElementById('imageOpacityValue')
          this.textWatermarkSettings = document.getElementById(
            'textWatermarkSettings'
          )
          this.imageWatermarkSettings = document.getElementById(
            'imageWatermarkSettings'
          )
        }

        setupEventListeners() {
          // æ–‡ä»¶ä¸Šä¼ 
          this.fileUpload.addEventListener('click', () =>
            this.videoInput.click()
          )
          this.videoInput.addEventListener('change', (e) =>
            this.handleFileSelect(e)
          )

          // æ‹–æ‹½ä¸Šä¼ 
          this.fileUpload.addEventListener('dragover', (e) => {
            e.preventDefault()
            this.fileUpload.classList.add('dragover')
          })

          this.fileUpload.addEventListener('dragleave', () => {
            this.fileUpload.classList.remove('dragover')
          })

          this.fileUpload.addEventListener('drop', (e) => {
            e.preventDefault()
            this.fileUpload.classList.remove('dragover')
            const files = e.dataTransfer.files
            if (files.length > 0) {
              this.handleFile(files[0])
            }
          })

          // æŒ‰é’®äº‹ä»¶
          this.addWatermarkBtn.addEventListener('click', () =>
            this.showCropper()
          )
          this.processBtn.addEventListener('click', () => this.processVideo())
          this.clearAllBtn.addEventListener('click', () =>
            this.clearAllRegions()
          )

          // CropperæŒ‰é’®äº‹ä»¶
          this.confirmCropBtn.addEventListener('click', () =>
            this.confirmCrop()
          )
          this.cancelCropBtn.addEventListener('click', () => this.cancelCrop())

          // æ°´å°ç±»å‹åˆ‡æ¢
          this.watermarkType.addEventListener('change', () => {
            this.toggleWatermarkSettings()
          })

          // é€æ˜åº¦æ»‘å—
          this.opacity.addEventListener('input', (e) => {
            this.opacityValue.textContent = e.target.value
          })

          this.imageOpacity.addEventListener('input', (e) => {
            this.imageOpacityValue.textContent = e.target.value
          })

          // æ°´å°å›¾ç‰‡é€‰æ‹©
          this.watermarkImage.addEventListener('change', (e) => {
            const file = e.target.files[0]
            if (file) {
              this.watermarkImageFile = file
            }
          })

          // æ¨¡æ€å¼¹çª—äº‹ä»¶
          const modal = document.getElementById('watermarkModal')
          const modalClose = document.getElementById('modalClose')

          // å…³é—­æŒ‰é’®
          modalClose.addEventListener('click', () => this.cancelCrop())

          // ç‚¹å‡»èƒŒæ™¯å…³é—­
          modal.addEventListener('click', (e) => {
            if (e.target === modal) {
              this.cancelCrop()
            }
          })

          // ESCé”®å…³é—­
          document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && modal.style.display === 'flex') {
              this.cancelCrop()
            }
          })

          // è§†é¢‘åŠ è½½å®Œæˆ
          this.videoPreview.addEventListener('loadedmetadata', () => {
            this.initializeTimeControls()
          })

          // æ—¶é—´æ§åˆ¶
          const timeSlider = document.getElementById('timeSlider')
          const startTime = document.getElementById('startTime')
          const endTime = document.getElementById('endTime')

          if (timeSlider) {
            timeSlider.addEventListener('input', (e) => {
              if (this.videoPreview) {
                this.videoPreview.currentTime = parseFloat(e.target.value)
              }
            })
          }

          if (startTime) {
            startTime.addEventListener('change', () => this.validateTimeRange())
          }

          if (endTime) {
            endTime.addEventListener('change', () => this.validateTimeRange())
          }
        }

        async loadFFmpeg() {
          try {
            this.showStatus('æ­£åœ¨åŠ è½½ FFmpeg...')
            this.ffmpeg = FFmpeg.createFFmpeg({
              log: true,
            })
            await this.ffmpeg.load()
            this.showStatus('FFmpeg åŠ è½½å®Œæˆ')
          } catch (error) {
            console.error('FFmpeg åŠ è½½å¤±è´¥:', error)
            this.showError('FFmpeg åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•')
          }
        }

        handleFileSelect(event) {
          const file = event.target.files[0]
          if (file) {
            this.handleFile(file)
          }
        }

        handleFile(file) {
          if (!file.type.startsWith('video/')) {
            this.showError('è¯·é€‰æ‹©æœ‰æ•ˆçš„è§†é¢‘æ–‡ä»¶')
            return
          }

          this.videoFile = file
          const url = URL.createObjectURL(file)
          this.videoPreview.src = url
          this.videoContainer.style.display = 'block'
          this.showStatus(`å·²åŠ è½½è§†é¢‘: ${file.name}`)
        }

        initializeTimeControls() {
          const duration = this.videoPreview.duration
          const timeSlider = document.getElementById('timeSlider')
          const endTime = document.getElementById('endTime')

          if (timeSlider) {
            timeSlider.max = duration
          }

          if (endTime) {
            endTime.value = duration.toFixed(1)
            endTime.max = duration
          }

          document.getElementById('videoControls').style.display = 'block'
          this.updateProcessButton()
        }

        setCurrentTimeAsStart() {
          const startTime = document.getElementById('startTime')
          if (startTime && this.videoPreview) {
            startTime.value = this.videoPreview.currentTime.toFixed(1)
            this.validateTimeRange()
          }
        }

        setCurrentTimeAsEnd() {
          const endTime = document.getElementById('endTime')
          if (endTime && this.videoPreview) {
            endTime.value = this.videoPreview.currentTime.toFixed(1)
            this.validateTimeRange()
          }
        }

        validateTimeRange() {
          const startTime = parseFloat(
            document.getElementById('startTime').value
          )
          const endTime = parseFloat(document.getElementById('endTime').value)
          const duration = this.videoPreview.duration

          if (startTime >= endTime) {
            this.showError('å¼€å§‹æ—¶é—´å¿…é¡»å°äºç»“æŸæ—¶é—´')
            return false
          }

          if (endTime > duration) {
            this.showError('ç»“æŸæ—¶é—´ä¸èƒ½è¶…è¿‡è§†é¢‘æ€»æ—¶é•¿')
            return false
          }

          this.hideError()
          return true
        }

        async showCropper() {
          if (!this.videoFile) {
            this.showError('è¯·å…ˆä¸Šä¼ è§†é¢‘æ–‡ä»¶')
            return
          }

          try {
            // æ•è·å½“å‰è§†é¢‘å¸§
            const frameDataUrl = await this.captureVideoFrame()
            this.cropperImage.src = frameDataUrl

            // æ˜¾ç¤ºæ¨¡æ€å¼¹çª—
            const modal = document.getElementById('watermarkModal')
            modal.style.display = 'flex'

            // æ›´æ–°è§†é¢‘ä¿¡æ¯
            document.getElementById(
              'videoResolution'
            ).textContent = `è§†é¢‘å°ºå¯¸: ${this.videoPreview.videoWidth} x ${this.videoPreview.videoHeight}`

            // åˆå§‹åŒ– Cropper
            setTimeout(() => {
              this.initializeCropper()
            }, 100)
          } catch (error) {
            console.error('æ˜¾ç¤ºè£å‰ªå™¨å¤±è´¥:', error)
            this.showError('æ— æ³•æ‰“å¼€æ°´å°é€‰æ‹©å™¨')
          }
        }

        async captureVideoFrame() {
          return new Promise((resolve) => {
            if (!this.canvas) {
              this.canvas = document.createElement('canvas')
            }

            const video = this.videoPreview
            this.canvas.width = video.videoWidth
            this.canvas.height = video.videoHeight

            const ctx = this.canvas.getContext('2d')
            ctx.drawImage(video, 0, 0, this.canvas.width, this.canvas.height)

            resolve(this.canvas.toDataURL('image/jpeg', 0.8))
          })
        }

        initializeCropper() {
          if (this.cropper) {
            this.cropper.destroy()
          }

          this.cropper = new Cropper(this.cropperImage, {
            aspectRatio: NaN,
            viewMode: 1,
            dragMode: 'crop',
            autoCropArea: 0.3,
            restore: false,
            guides: true,
            center: true,
            highlight: true,
            cropBoxMovable: true,
            cropBoxResizable: true,
            toggleDragModeOnDblclick: false,
            crop: (event) => {
              const { x, y, width, height } = event.detail
              document.getElementById(
                'selectionInfo'
              ).textContent = `é€‰æ‹©åŒºåŸŸ: ${Math.round(width)} x ${Math.round(
                height
              )} (${Math.round(x)}, ${Math.round(y)})`
            },
          })
        }

        toggleWatermarkSettings() {
          const type = this.watermarkType.value
          if (type === 'text') {
            this.textWatermarkSettings.style.display = 'block'
            this.imageWatermarkSettings.style.display = 'none'
          } else {
            this.textWatermarkSettings.style.display = 'none'
            this.imageWatermarkSettings.style.display = 'block'
          }
        }

        confirmCrop() {
          if (!this.cropper) {
            this.showError('è¯·å…ˆé€‰æ‹©æ°´å°åŒºåŸŸ')
            return
          }

          const cropData = this.cropper.getData()
          const watermarkType = this.watermarkType.value

          // éªŒè¯æ°´å°è®¾ç½®
          if (watermarkType === 'text') {
            const text = this.watermarkText.value.trim()
            if (!text) {
              this.showError('è¯·è¾“å…¥æ°´å°æ–‡å­—')
              return
            }
          } else if (watermarkType === 'image') {
            if (!this.watermarkImageFile) {
              this.showError('è¯·é€‰æ‹©æ°´å°å›¾ç‰‡')
              return
            }
          }

          // åˆ›å»ºæ°´å°åŒºåŸŸ
          this.addWatermarkRegion(cropData, watermarkType)
          this.cancelCrop()
        }

        addWatermarkRegion(cropData, type) {
          this.regionCounter++
          const regionId = `region_${this.regionCounter}`

          // è®¡ç®—ç›¸å¯¹ä½ç½®ï¼ˆç›¸å¯¹äºè§†é¢‘å°ºå¯¸çš„ç™¾åˆ†æ¯”ï¼‰
          const videoWidth = this.videoPreview.videoWidth
          const videoHeight = this.videoPreview.videoHeight
          const imageWidth = this.cropperImage.naturalWidth
          const imageHeight = this.cropperImage.naturalHeight

          const region = {
            id: regionId,
            type: type,
            x: (cropData.x / imageWidth) * 100,
            y: (cropData.y / imageHeight) * 100,
            width: (cropData.width / imageWidth) * 100,
            height: (cropData.height / imageHeight) * 100,
          }

          // æ·»åŠ æ°´å°ç‰¹å®šå±æ€§
          if (type === 'text') {
            region.text = this.watermarkText.value
            region.fontSize = parseInt(this.fontSize.value)
            region.fontColor = this.fontColor.value
            region.opacity = parseFloat(this.opacity.value)
          } else if (type === 'image') {
            region.imageFile = this.watermarkImageFile
            region.opacity = parseFloat(this.imageOpacity.value)
          }

          this.watermarkRegions.push(region)
          this.updateWatermarkList()
          this.updateProcessButton()

          this.showStatus(`å·²æ·»åŠ ${type === 'text' ? 'æ–‡å­—' : 'å›¾ç‰‡'}æ°´å°åŒºåŸŸ`)
        }

        removeWatermarkRegion(regionId) {
          // ä»æ•°ç»„ä¸­ç§»é™¤
          this.watermarkRegions = this.watermarkRegions.filter(
            (r) => r.id !== regionId
          )

          // ä»DOMä¸­ç§»é™¤
          const regionElement = document.getElementById(regionId)
          if (regionElement) {
            regionElement.remove()
          }

          this.updateWatermarkList()
          this.updateProcessButton()
          this.showStatus('å·²åˆ é™¤æ°´å°åŒºåŸŸ')
        }

        updateWatermarkList() {
          const listContainer = this.watermarkList

          if (this.watermarkRegions.length === 0) {
            listContainer.innerHTML = `
               <div style="text-align: center; color: var(--text-secondary); padding: 20px;">
                 æš‚æ— æ°´å°åŒºåŸŸ<br>
                 <small>ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æ·»åŠ æ°´å°åŒºåŸŸ</small>
               </div>
             `
            return
          }

          listContainer.innerHTML = ''
          this.watermarkRegions.forEach((region, index) => {
            const item = document.createElement('div')
            item.className = 'watermark-item'
            item.innerHTML = `
               <div class="watermark-item-header">
                 <span class="watermark-item-title">
                   ${region.type === 'text' ? 'ğŸ“' : 'ğŸ–¼ï¸'} 
                   ${region.type === 'text' ? region.text : 'å›¾ç‰‡æ°´å°'} #${
              index + 1
            }
                 </span>
               </div>
               <div class="watermark-item-info">
                 ä½ç½®: ${region.x.toFixed(1)}%, ${region.y.toFixed(1)}%<br>
                 å¤§å°: ${region.width.toFixed(1)}% Ã— ${region.height.toFixed(
              1
            )}%<br>
                 é€æ˜åº¦: ${region.opacity}
               </div>
               <div class="watermark-item-actions">
                 <button class="btn-danger" onclick="watermarkAdder.removeWatermarkRegion('${
                   region.id
                 }')">
                   åˆ é™¤
                 </button>
               </div>
             `
            listContainer.appendChild(item)
          })
        }

        clearAllRegions() {
          if (this.watermarkRegions.length === 0) {
            this.showError('æ²¡æœ‰æ°´å°åŒºåŸŸéœ€è¦æ¸…é™¤')
            return
          }

          if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰æ°´å°åŒºåŸŸå—ï¼Ÿ')) {
            this.watermarkRegions = []
            this.updateWatermarkList()
            this.updateProcessButton()
            this.showStatus('å·²æ¸…é™¤æ‰€æœ‰æ°´å°åŒºåŸŸ')
          }
        }

        updateProcessButton() {
          const hasVideo = !!this.videoFile
          const hasRegions = this.watermarkRegions.length > 0
          this.processBtn.disabled = !(hasVideo && hasRegions)
        }

        cancelCrop() {
          const modal = document.getElementById('watermarkModal')
          modal.style.display = 'none'

          if (this.cropper) {
            this.cropper.destroy()
            this.cropper = null
          }

          // é‡ç½®æ°´å°è®¾ç½®
          this.watermarkType.value = 'text'
          this.watermarkText.value = 'æ°´å°æ–‡å­—'
          this.fontSize.value = '24'
          this.fontColor.value = '#ffffff'
          this.opacity.value = '0.8'
          this.opacityValue.textContent = '0.8'
          this.imageOpacity.value = '0.8'
          this.imageOpacityValue.textContent = '0.8'
          this.watermarkImage.value = ''
          this.watermarkImageFile = null
          this.toggleWatermarkSettings()
        }

        async processVideo() {
          if (
            !this.ffmpeg ||
            !this.videoFile ||
            this.watermarkRegions.length === 0
          ) {
            this.showError('è¯·ç¡®ä¿å·²åŠ è½½è§†é¢‘æ–‡ä»¶å¹¶æ·»åŠ äº†æ°´å°åŒºåŸŸ')
            return
          }

          if (!this.validateTimeRange()) {
            return
          }

          try {
            this.showProgress(0, 'å‡†å¤‡å¤„ç†è§†é¢‘...')
            this.processBtn.disabled = true

            // å†™å…¥è§†é¢‘æ–‡ä»¶åˆ° FFmpeg
            const videoData = new Uint8Array(await this.videoFile.arrayBuffer())
            await this.ffmpeg.FS('writeFile', 'input.mp4', videoData)

            // åŠ è½½å­—ä½“æ–‡ä»¶
            const fontResponse = await fetch('./SourceHanSansCN-Regular.ttf')
            const fontData = new Uint8Array(await fontResponse.arrayBuffer())
            await this.ffmpeg.FS('writeFile', 'SourceHanSansCN-Regular.ttf', fontData)

            // å¤„ç†å›¾ç‰‡æ°´å°æ–‡ä»¶
            for (let i = 0; i < this.watermarkRegions.length; i++) {
              const region = this.watermarkRegions[i]
              if (region.type === 'image' && region.imageFile) {
                const imageData = new Uint8Array(
                  await region.imageFile.arrayBuffer()
                )
                await this.ffmpeg.FS(
                  'writeFile',
                  `watermark_${i}.png`,
                  imageData
                )
              }
            }

            this.showProgress(20, 'æ„å»º FFmpeg å‘½ä»¤...')

            // æ„å»º FFmpeg å‘½ä»¤
            const command = await this.buildFFmpegCommand()
            console.log('FFmpeg å‘½ä»¤:', command)

            this.showProgress(30, 'å¼€å§‹å¤„ç†è§†é¢‘...')

            // æ‰§è¡Œ FFmpeg å‘½ä»¤
            await this.ffmpeg.run(...command)

            this.showProgress(90, 'å‡†å¤‡ä¸‹è½½...')

            // è¯»å–è¾“å‡ºæ–‡ä»¶
            const outputFormat = this.outputFormat.value
            const outputData = this.ffmpeg.FS(
              'readFile',
              `output.${outputFormat}`
            )

            // åˆ›å»ºä¸‹è½½é“¾æ¥
            const blob = new Blob([outputData.buffer], {
              type: `video/${outputFormat}`,
            })
            const url = URL.createObjectURL(blob)
            const a = document.createElement('a')
            a.href = url
            a.download = `watermarked_video.${outputFormat}`
            a.click()

            this.showProgress(100, 'å¤„ç†å®Œæˆï¼')
            this.showStatus('è§†é¢‘å¤„ç†å®Œæˆï¼Œå·²å¼€å§‹ä¸‹è½½')

            // æ¸…ç†æ–‡ä»¶
            setTimeout(() => {
              URL.revokeObjectURL(url)
              this.hideProgress()
            }, 2000)
          } catch (error) {
            console.error('è§†é¢‘å¤„ç†å¤±è´¥:', error)
            this.showError(`è§†é¢‘å¤„ç†å¤±è´¥: ${error.message}`)
          } finally {
            this.processBtn.disabled = false
          }
        }

        async buildFFmpegCommand() {
          const startTime = document.getElementById('startTime').value
          const endTime = document.getElementById('endTime').value
          const outputFormat = this.outputFormat.value
          const quality = this.quality.value

          let command = ['-i', 'input.mp4']

          // æ·»åŠ æ—¶é—´èŒƒå›´
          if (parseFloat(startTime) > 0) {
            command.push('-ss', startTime)
          }
          if (parseFloat(endTime) < this.videoPreview.duration) {
            command.push(
              '-t',
              (parseFloat(endTime) - parseFloat(startTime)).toString()
            )
          }

          // æ„å»ºå¤æ‚æ»¤é•œ
          let filterComplex = '[0:v]'
          let overlayInputs = 1

          for (let i = 0; i < this.watermarkRegions.length; i++) {
            const region = this.watermarkRegions[i]
            const videoWidth = this.videoPreview.videoWidth
            const videoHeight = this.videoPreview.videoHeight

            // è®¡ç®—å®é™…åƒç´ ä½ç½®
            const x = Math.round((region.x / 100) * videoWidth)
            const y = Math.round((region.y / 100) * videoHeight)
            const w = Math.round((region.width / 100) * videoWidth)
            const h = Math.round((region.height / 100) * videoHeight)

            if (region.type === 'text') {
              // æ–‡å­—æ°´å°
              const fontSize = Math.round(region.fontSize * (videoWidth / 1000))
              const fontColor = region.fontColor.replace('#', '')
              const alpha = Math.round(region.opacity * 255)
                .toString(16)
                .padStart(2, '0')

              filterComplex += `drawtext=text='${region.text}':fontfile=SourceHanSansCN-Regular.ttf:x=${x}:y=${y}:fontsize=${fontSize}:fontcolor=${fontColor}${alpha}:box=1:boxcolor=black@0.3:boxborderw=2`
            } else if (region.type === 'image') {
              // å›¾ç‰‡æ°´å°
              command.push('-i', `watermark_${i}.png`)
              const alpha = region.opacity

              if (i === 0) {
                filterComplex += `[${overlayInputs}:v]scale=${w}:${h},format=rgba,colorchannelmixer=aa=${alpha}[wm${i}];[0:v][wm${i}]overlay=${x}:${y}`
              } else {
                filterComplex += `[${overlayInputs}:v]scale=${w}:${h},format=rgba,colorchannelmixer=aa=${alpha}[wm${i}];[tmp${
                  i - 1
                }][wm${i}]overlay=${x}:${y}[tmp${i}]`
              }
              overlayInputs++
            }

            if (
              region.type === 'image' &&
              i < this.watermarkRegions.length - 1
            ) {
              filterComplex += `[tmp${i}];`
            }
          }

          // æ·»åŠ æ»¤é•œå¤æ‚å‚æ•°
          if (this.watermarkRegions.some((r) => r.type === 'image')) {
            command.push('-filter_complex', filterComplex)
            command.push(
              '-map',
              `[tmp${
                this.watermarkRegions.filter((r) => r.type === 'image').length -
                1
              }]`
            )
          } else {
            command.push('-vf', filterComplex)
          }

          // æ·»åŠ è´¨é‡è®¾ç½®
          if (quality === 'high') {
            command.push('-crf', '18')
          } else if (quality === 'medium') {
            command.push('-crf', '23')
          } else {
            command.push('-crf', '28')
          }

          // æ·»åŠ ç¼–ç è®¾ç½®
          command.push('-c:v', 'libx264', '-c:a', 'aac', '-preset', 'medium')
          command.push(`output.${outputFormat}`)

          return command
        }

        showProgress(percent, message) {
          this.progressContainer.style.display = 'block'
          this.progressFill.style.width = `${percent}%`
          this.progressText.textContent = message
        }

        hideProgress() {
          this.progressContainer.style.display = 'none'
        }

        showStatus(message) {
          this.hideError()
          this.statusMessage.textContent = message
          this.statusMessage.style.display = 'block'
          setTimeout(() => {
            this.statusMessage.style.display = 'none'
          }, 3000)
        }

        showError(message) {
          this.hideStatus()
          this.errorMessage.textContent = message
          this.errorMessage.style.display = 'block'
        }

        hideStatus() {
          this.statusMessage.style.display = 'none'
        }

        hideError() {
          this.errorMessage.style.display = 'none'
        }
      }

      // åˆå§‹åŒ–åº”ç”¨
      const watermarkAdder = new WatermarkAdder()
    </script>
  </body>
</html>
