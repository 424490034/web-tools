<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>æé€Ÿåœ¨çº¿å›¾ç‰‡æ ¼å¼è½¬æ¢å™¨</title>
    <style>
      @import url('./format/css2.css');

      :root {
        /* æ‹Ÿæ€é£æ ¼é¢œè‰²å˜é‡ */
        --primary: #667eea;
        --primary-rgb: 102, 126, 234;
        --secondary: #764ba2;
        --background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        --card: #f0f0f3;
        --text-primary: #2d3748;
        --text-secondary: #4a5568;
        --text-muted: #718096;
        --border: #e2e8f0;

        /* é˜´å½±å®šä¹‰ */
        --shadow-inset: inset 6px 6px 12px #d1d9e6, inset -6px -6px 12px #ffffff;
        --shadow-outset: 6px 6px 12px #d1d9e6, -6px -6px 12px #ffffff;
        --shadow-medium: 3px 3px 6px #d1d9e6, -3px -3px 6px #ffffff;
        --shadow-small: 2px 2px 4px #d1d9e6, -2px -2px 4px #ffffff;
        --shadow-light: rgba(255, 255, 255, 0.8);

        /* è¾¹æ¡†åœ†è§’ */
        --border-radius: 16px;
        --border-radius-small: 8px;
        --border-radius-large: 24px;

        /* è¿‡æ¸¡æ•ˆæœ */
        --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }

      /* åŠ¨ç”»å…³é”®å¸§ */
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes containerFloat {
        0%,
        100% {
          transform: translateY(0px);
        }
        50% {
          transform: translateY(-5px);
        }
      }

      @keyframes headerShine {
        0% {
          background-position: -200% center;
        }
        100% {
          background-position: 200% center;
        }
      }

      @keyframes titlePulse {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.02);
        }
      }

      @keyframes iconPulse {
        0%,
        100% {
          transform: scale(1);
          opacity: 0.8;
        }
        50% {
          transform: scale(1.1);
          opacity: 1;
        }
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateX(-20px);
        }
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }

      @keyframes shimmer {
        0% {
          background-position: -200% center;
        }
        100% {
          background-position: 200% center;
        }
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI',
          Roboto, sans-serif;
      }

      body {
        color: var(--text-primary);
        min-height: 100vh;
        padding: 20px;
        font-weight: 400;
        line-height: 1.6;
        animation: fadeIn 0.8s ease-out;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: var(--card);
        border-radius: var(--border-radius-large);
        box-shadow: var(--shadow-outset);
        overflow: hidden;
        animation: containerFloat 6s ease-in-out infinite;
        position: relative;
      }

      .container::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(
          90deg,
          var(--primary),
          var(--secondary),
          var(--primary)
        );
        background-size: 200% 100%;
        animation: headerShine 3s ease-in-out infinite;
      }

      header {
        text-align: center;
        padding: 40px 30px;
        background: linear-gradient(
          135deg,
          rgba(255, 255, 255, 0.1),
          rgba(255, 255, 255, 0.05)
        );
        border-bottom: 1px solid var(--border);
        position: relative;
      }

      h1 {
        font-size: 2.8rem;
        font-weight: 700;
        margin-bottom: 16px;
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        animation: titlePulse 4s ease-in-out infinite;
        letter-spacing: -0.02em;
      }

      .subtitle {
        font-size: 1.1rem;
        color: var(--text-secondary);
        max-width: 600px;
        margin: 0 auto;
        line-height: 1.7;
        font-weight: 400;
        opacity: 0.9;
      }

      .main-content {
        display: grid;
        grid-template-columns: 1fr 1fr;
        padding: 30px;
        gap: 30px;
        animation: contentSlideUp 0.8s ease-out 0.2s both;
      }

      .upload-panel,
      .settings-panel {
        background: var(--card);
        border-radius: var(--border-radius);
        padding: 30px;
        box-shadow: var(--shadow-medium);
        transition: var(--transition);
        position: relative;
        overflow: hidden;
      }

      .upload-panel::before,
      .settings-panel::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.1),
          transparent
        );
        transition: var(--transition);
      }

      .upload-panel:hover::before,
      .settings-panel:hover::before {
        left: 100%;
      }

      .upload-panel:hover,
      .settings-panel:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-outset);
      }

      .panel-title {
        font-size: 1.6rem;
        font-weight: 600;
        margin-bottom: 24px;
        color: var(--primary);
        display: flex;
        align-items: center;
        gap: 12px;
        letter-spacing: -0.01em;
      }

      .panel-title .emoji {
        font-size: 1.8rem;
        animation: iconFloat 3s ease-in-out infinite;
      }

      .file-upload-area {
        border: 2px dashed var(--primary);
        border-radius: var(--border-radius);
        padding: 40px 20px;
        text-align: center;
        cursor: pointer;
        transition: var(--transition);
        margin-bottom: 24px;
        position: relative;
        background: linear-gradient(
          135deg,
          rgba(102, 126, 234, 0.05),
          rgba(118, 75, 162, 0.05)
        );
        box-shadow: var(--shadow-inset);
      }

      .file-upload-area::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0;
        height: 0;
        background: radial-gradient(
          circle,
          rgba(102, 126, 234, 0.1),
          transparent
        );
        border-radius: 50%;
        transform: translate(-50%, -50%);
        transition: var(--transition);
      }

      .file-upload-area:hover {
        border-color: var(--secondary);
        transform: translateY(-3px);
        box-shadow: var(--shadow-outset);
      }

      .file-upload-area:hover::before {
        width: 200px;
        height: 200px;
      }

      .file-upload-area p {
        margin: 12px 0;
        font-size: 1rem;
        color: var(--text-secondary);
        font-weight: 500;
        position: relative;
        z-index: 1;
      }

      .file-upload-area p:first-of-type {
        font-weight: 600;
        color: var(--text-primary);
      }

      .upload-icon {
        font-size: 48px;
        color: var(--primary);
        margin-bottom: 16px;
        animation: iconPulse 2s ease-in-out infinite;
        position: relative;
        z-index: 1;
      }

      input[type='file'] {
        position: absolute;
        width: 100%;
        height: 100%;
        top: 0;
        left: 0;
        opacity: 0;
        cursor: pointer;
        z-index: 2;
      }

      .format-options {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
        gap: 16px;
        margin: 24px 0;
      }

      .format-option {
        background: var(--card);
        border-radius: var(--border-radius-small);
        padding: 16px 12px;
        text-align: center;
        cursor: pointer;
        transition: var(--transition);
        border: 2px solid transparent;
        box-shadow: var(--shadow-small);
        font-weight: 600;
        color: var(--text-primary);
        position: relative;
        overflow: hidden;
      }

      .format-option::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(102, 126, 234, 0.1),
          transparent
        );
        transition: var(--transition);
      }

      .format-option:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-medium);
      }

      .format-option:hover::before {
        left: 100%;
      }

      .format-option.active {
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        color: white;
        border-color: var(--primary);
        box-shadow: var(--shadow-outset);
      }

      .format-option.active::before {
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.2),
          transparent
        );
      }

      .section-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--text-primary);
        margin: 24px 0 16px 0;
        letter-spacing: -0.01em;
      }

      .quality-control {
        margin: 24px 0;
      }

      .quality-slider {
        width: 100%;
        margin: 16px 0;
        -webkit-appearance: none;
        height: 8px;
        border-radius: 4px;
        background: var(--card);
        box-shadow: var(--shadow-inset);
        outline: none;
        transition: var(--transition);
      }

      .quality-slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        cursor: pointer;
        box-shadow: var(--shadow-small);
        transition: var(--transition);
      }

      .quality-slider::-webkit-slider-thumb:hover {
        transform: scale(1.1);
        box-shadow: var(--shadow-medium);
      }

      .preview-container {
        background: var(--card);
        border-radius: var(--border-radius);
        overflow: hidden;
        margin-top: 24px;
        aspect-ratio: 16/9;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: var(--shadow-inset);
        border: 1px solid rgba(102, 126, 234, 0.1);
        padding: 16px;
        color: var(--text-secondary);
        font-weight: 500;
      }

      .preview-container img {
        max-width: 100%;
        max-height: 100%;
        display: block;
        border-radius: var(--border-radius-small);
        box-shadow: var(--shadow-small);
        transition: var(--transition);
      }

      .preview-container img:hover {
        transform: scale(1.02);
        box-shadow: var(--shadow-medium);
      }

      .file-list {
        max-height: 300px;
        overflow-y: auto;
        margin-top: 24px;
        background: var(--card);
        border-radius: var(--border-radius);
        padding: 16px;
        box-shadow: var(--shadow-inset);
        border: 1px solid rgba(102, 126, 234, 0.1);
      }

      .file-item {
        display: flex;
        justify-content: space-between;
        padding: 16px;
        background: var(--card);
        border-radius: var(--border-radius-small);
        margin-bottom: 12px;
        align-items: center;
        transition: var(--transition);
        box-shadow: var(--shadow-small);
        border: 1px solid rgba(102, 126, 234, 0.1);
        position: relative;
        overflow: hidden;
      }

      .file-item::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(102, 126, 234, 0.05),
          transparent
        );
        transition: var(--transition);
      }

      .file-item:hover {
        transform: translateX(3px);
        box-shadow: var(--shadow-medium);
        border-color: var(--primary);
      }

      .file-item:hover::before {
        left: 100%;
      }

      .file-info {
        display: flex;
        align-items: center;
        gap: 12px;
        position: relative;
        z-index: 1;
      }

      .file-icon {
        width: 32px;
        height: 32px;
        font-size: 1.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .file-name {
        max-width: 200px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        font-weight: 600;
        color: var(--text-primary);
        font-size: 0.95rem;
      }

      .file-size {
        font-size: 0.85rem;
        color: var(--text-secondary);
        font-weight: 500;
      }

      .file-status {
        font-size: 0.9rem;
        color: var(--primary);
        font-weight: 600;
        position: relative;
        z-index: 1;
      }

      .actions {
        display: flex;
        gap: 16px;
        margin-top: 32px;
        flex-wrap: wrap;
      }

      button {
        flex: 1;
        min-width: 140px;
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        color: white;
        border: none;
        padding: 16px 24px;
        border-radius: var(--border-radius);
        cursor: pointer;
        font-weight: 600;
        font-size: 0.95rem;
        transition: var(--transition);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        position: relative;
        overflow: hidden;
        box-shadow: var(--shadow-medium);
      }

      button::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0;
        height: 0;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 50%;
        transform: translate(-50%, -50%);
        transition: var(--transition);
      }

      button:hover::before {
        width: 300px;
        height: 300px;
      }

      button:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-outset);
      }

      button:active {
        transform: translateY(0);
        box-shadow: var(--shadow-small);
      }

      button:disabled {
        background: var(--card);
        color: var(--text-muted);
        cursor: not-allowed;
        transform: none;
        box-shadow: var(--shadow-inset);
        opacity: 0.5;
      }

      button:disabled::before {
        display: none;
      }

      .btn-reset {
        background: linear-gradient(135deg, #ff6b6b, #ff5252);
      }

      .btn-reset:hover {
        box-shadow: 0 8px 25px rgba(255, 107, 107, 0.4);
      }

      .conversion-info {
        margin-top: 30px;
        padding: 20px;
        background: rgba(0, 30, 60, 0.5);
        border-radius: 15px;
      }

      .info-title {
        font-size: 1.5rem;
        margin-bottom: 15px;
        color: #00f2fe;
      }

      .info-content {
        line-height: 1.8;
        color: #c0e0ff;
      }

      .features {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-top: 20px;
      }

      .feature {
        background: rgba(255, 255, 255, 0.05);
        padding: 20px;
        border-radius: 10px;
        border-left: 3px solid #4facfe;
      }

      .feature h3 {
        color: #4facfe;
        margin-bottom: 10px;
      }

      footer {
        text-align: center;
        padding: 30px;
        color: #a0d2ff;
        font-size: 0.9rem;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
      }

      /* å“åº”å¼è®¾è®¡ */
      @media (max-width: 1024px) {
        .container {
          padding: 20px;
          margin: 20px;
        }

        .main-content {
          gap: 20px;
        }

        .upload-panel,
        .settings-panel {
          padding: 20px;
        }
      }

      @media (max-width: 768px) {
        .container {
          margin: 10px;
          padding: 16px;
          border-radius: 16px;
        }

        .main-content {
          grid-template-columns: 1fr;
          gap: 16px;
        }

        .upload-panel,
        .settings-panel {
          padding: 16px;
        }

        .file-upload-area {
          padding: 24px 16px;
        }

        .upload-icon {
          font-size: 36px;
        }

        .format-options {
          grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
          gap: 12px;
        }

        .format-option {
          padding: 12px 8px;
          font-size: 0.85rem;
        }

        .actions {
          flex-direction: column;
          gap: 12px;
        }

        button {
          min-width: auto;
          padding: 14px 20px;
          font-size: 0.9rem;
        }

        .file-item {
          padding: 12px;
        }

        .preview-container {
          padding: 16px;
        }

        h1 {
          font-size: 2.2rem;
        }
      }

      @media (max-width: 480px) {
        .container {
          margin: 5px;
          padding: 12px;
        }

        h1 {
          font-size: 1.8rem;
        }

        .subtitle {
          font-size: 0.9rem;
        }

        .upload-panel,
        .settings-panel {
          padding: 12px;
        }

        .file-upload-area {
          padding: 20px 12px;
        }

        .upload-icon {
          font-size: 32px;
        }

        .format-options {
          grid-template-columns: repeat(2, 1fr);
        }

        button {
          padding: 12px 16px;
          font-size: 0.85rem;
        }

        .section-title {
          font-size: 1rem;
        }

        .file-name {
          font-size: 0.9rem;
        }

        .file-size {
          font-size: 0.8rem;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>æé€Ÿåœ¨çº¿å›¾ç‰‡æ ¼å¼è½¬æ¢</h1>
        <p class="subtitle">
          æ— éœ€ä¸Šä¼ æœåŠ¡å™¨ Â· 100%æœ¬åœ°æµè§ˆå™¨å¤„ç† Â· æ”¯æŒæ‰¹é‡è½¬æ¢ Â· å®Œç¾ä¿æŠ¤éšç§
        </p>
      </header>

      <div class="main-content">
        <div class="upload-panel">
          <h2 class="panel-title">ğŸ“ å›¾ç‰‡ä¸Šä¼ </h2>

          <div class="file-upload-area" id="dropArea">
            <div class="upload-icon">ğŸ“</div>
            <p>æ‹–æ”¾å›¾ç‰‡åˆ°æ­¤å¤„ æˆ– <u>ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</u></p>
            <p>æ”¯æŒ JPG, PNG, WEBP, BMP, SVG, GIF ç­‰æ ¼å¼</p>
            <input type="file" id="fileInput" accept="image/*" multiple />
          </div>

          <div class="file-list" id="fileList">
            <p style="text-align: center; padding: 20px">æš‚æ— ä¸Šä¼ æ–‡ä»¶</p>
          </div>
        </div>

        <div class="settings-panel">
          <h2 class="panel-title">âš™ï¸ è½¬æ¢è®¾ç½®</h2>

          <h3 class="section-title">ç›®æ ‡æ ¼å¼</h3>
          <div class="format-options">
            <div class="format-option active" data-format="jpg">
              <div>JPG</div>
            </div>
            <div class="format-option" data-format="png">
              <div>PNG</div>
            </div>
            <div class="format-option" data-format="webp">
              <div>WEBP</div>
            </div>
            <div class="format-option" data-format="bmp">
              <div>BMP</div>
            </div>
            <div class="format-option" data-format="svg">
              <div>SVG</div>
            </div>
          </div>

          <div class="quality-control">
            <h3 class="section-title">
              è¾“å‡ºè´¨é‡ <span id="qualityValue">90%</span>
            </h3>
            <input
              type="range"
              min="10"
              max="100"
              value="90"
              class="quality-slider"
              id="qualitySlider"
            />
            <p style="color: #aaa; font-size: 0.9rem">
              æç¤ºï¼šä»…JPG/WEBPæ”¯æŒè´¨é‡è°ƒæ•´ï¼ŒPNG/SVGä¸ºæ— æŸæ ¼å¼
            </p>
          </div>

          <div class="preview-container" id="previewContainer">
            <p>å›¾ç‰‡é¢„è§ˆåŒº</p>
          </div>

          <div class="actions">
            <button id="convertBtn">ğŸ”„ å¼€å§‹è½¬æ¢</button>
            <button id="downloadBtn" disabled>ğŸ’¾ å…¨éƒ¨ä¸‹è½½</button>
            <button id="resetBtn" class="btn-reset">âŒ é‡ç½®</button>
          </div>
        </div>
      </div>

      <div class="conversion-info">
        <h2 class="info-title">âœ¨ åŠŸèƒ½ç‰¹ç‚¹</h2>
        <div class="features">
          <div class="feature">
            <h3>å®Œå…¨æœ¬åœ°å¤„ç†</h3>
            <p>
              æ‰€æœ‰å›¾ç‰‡å¤„ç†å‡åœ¨æµè§ˆå™¨ä¸­å®Œæˆï¼Œæ— éœ€ä¸Šä¼ åˆ°ä»»ä½•æœåŠ¡å™¨ï¼Œ100%ä¿æŠ¤æ‚¨çš„éšç§å®‰å…¨[4,5](@ref)ã€‚
            </p>
          </div>
          <div class="feature">
            <h3>æ‰¹é‡é«˜æ•ˆè½¬æ¢</h3>
            <p>æ”¯æŒåŒæ—¶ä¸Šä¼ å¤šå¼ å›¾ç‰‡æ‰¹é‡è½¬æ¢ï¼Œå¤§å¹…æå‡å·¥ä½œæ•ˆç‡[1,6](@ref)ã€‚</p>
          </div>
          <div class="feature">
            <h3>æ ¼å¼å…¨é¢æ”¯æŒ</h3>
            <p>æ”¯æŒJPGã€PNGã€WEBPã€BMPã€SVGç­‰ä¸»æµå›¾ç‰‡æ ¼å¼äº’è½¬[2,7](@ref)ã€‚</p>
          </div>
          <div class="feature">
            <h3>å¤§æ–‡ä»¶å…¼å®¹</h3>
            <p>å¯å¤„ç†é«˜è¾¾50MBçš„å›¾ç‰‡æ–‡ä»¶ï¼Œæ»¡è¶³ä¸“ä¸šéœ€æ±‚[1,4](@ref)ã€‚</p>
          </div>
        </div>
      </div>

      <footer>
        <p>
          Â© 2025 æé€Ÿå›¾ç‰‡æ ¼å¼è½¬æ¢å™¨ | åŸºäºHTML5 CanvasæŠ€æœ¯å®ç° | æ°¸ä¹…å…è´¹æ— å¹¿å‘Š
        </p>
        <p>
          éšç§å£°æ˜ï¼šæœ¬å·¥å…·ä¸ä¼šæ”¶é›†ä»»ä½•ç”¨æˆ·ä¸Šä¼ çš„å›¾ç‰‡å†…å®¹ï¼Œæ‰€æœ‰å¤„ç†å‡åœ¨æ‚¨çš„æµè§ˆå™¨ä¸­å®Œæˆ
        </p>
      </footer>
    </div>

    <script>
      // å…¨å±€å˜é‡
      let uploadedFiles = []
      let currentFormat = 'jpg'
      let currentQuality = 90

      // DOMå…ƒç´ 
      const fileInput = document.getElementById('fileInput')
      const dropArea = document.getElementById('dropArea')
      const fileList = document.getElementById('fileList')
      const formatOptions = document.querySelectorAll('.format-option')
      const qualitySlider = document.getElementById('qualitySlider')
      const qualityValue = document.getElementById('qualityValue')
      const convertBtn = document.getElementById('convertBtn')
      const downloadBtn = document.getElementById('downloadBtn')
      const resetBtn = document.getElementById('resetBtn')
      const previewContainer = document.getElementById('previewContainer')

      // åˆå§‹åŒ–äº‹ä»¶
      function initEvents() {
        // æ–‡ä»¶é€‰æ‹©å¤„ç†
        fileInput.addEventListener('change', handleFileSelect)

        // æ‹–æ”¾åŠŸèƒ½
        dropArea.addEventListener('dragover', (e) => {
          e.preventDefault()
          dropArea.style.borderColor = '#00f2fe'
          dropArea.style.backgroundColor = 'rgba(0, 242, 254, 0.1)'
        })

        dropArea.addEventListener('dragleave', () => {
          dropArea.style.borderColor = '#5d9cec'
          dropArea.style.backgroundColor = 'rgba(93, 156, 236, 0.05)'
        })

        dropArea.addEventListener('drop', (e) => {
          e.preventDefault()
          dropArea.style.borderColor = '#5d9cec'
          dropArea.style.backgroundColor = 'rgba(93, 156, 236, 0.05)'

          if (e.dataTransfer.files.length) {
            handleFiles(e.dataTransfer.files)
          }
        })

        // æ ¼å¼é€‰æ‹©
        formatOptions.forEach((option) => {
          option.addEventListener('click', () => {
            formatOptions.forEach((opt) => opt.classList.remove('active'))
            option.classList.add('active')
            currentFormat = option.dataset.format
          })
        })

        // è´¨é‡æ»‘å—
        qualitySlider.addEventListener('input', () => {
          currentQuality = qualitySlider.value
          qualityValue.textContent = `${currentQuality}%`
        })

        // è½¬æ¢æŒ‰é’®
        convertBtn.addEventListener('click', convertImages)

        // ä¸‹è½½æŒ‰é’®
        downloadBtn.addEventListener('click', downloadAll)

        // é‡ç½®æŒ‰é’®
        resetBtn.addEventListener('click', resetAll)
      }

      // å¤„ç†é€‰æ‹©çš„æ–‡ä»¶
      function handleFileSelect(e) {
        handleFiles(e.target.files)
      }

      // å¤„ç†æ–‡ä»¶
      function handleFiles(files) {
        for (let i = 0; i < files.length; i++) {
          const file = files[i]

          // æ£€æŸ¥æ–‡ä»¶ç±»å‹
          if (!file.type.match('image.*')) {
            alert(`"${file.name}" ä¸æ˜¯å›¾ç‰‡æ–‡ä»¶ï¼Œå·²è·³è¿‡`)
            continue
          }

          // æ·»åŠ åˆ°æ–‡ä»¶åˆ—è¡¨
          uploadedFiles.push({
            file: file,
            status: 'å¾…è½¬æ¢',
            converted: null,
          })

          // å¦‚æœæ˜¯ç¬¬ä¸€ä¸ªæ–‡ä»¶ï¼Œæ˜¾ç¤ºé¢„è§ˆ
          if (i === 0) {
            showPreview(file)
          }
        }

        updateFileList()
      }

      // æ˜¾ç¤ºé¢„è§ˆ
      function showPreview(file) {
        const reader = new FileReader()
        reader.onload = (e) => {
          previewContainer.innerHTML = `<img src="${e.target.result}" alt="é¢„è§ˆ">`
        }
        reader.readAsDataURL(file)
      }

      // æ›´æ–°æ–‡ä»¶åˆ—è¡¨æ˜¾ç¤º
      function updateFileList() {
        if (uploadedFiles.length === 0) {
          fileList.innerHTML =
            '<p style="text-align: center; padding: 20px;">æš‚æ— ä¸Šä¼ æ–‡ä»¶</p>'
          return
        }

        fileList.innerHTML = ''
        uploadedFiles.forEach((fileInfo, index) => {
          const file = fileInfo.file
          const item = document.createElement('div')
          item.className = 'file-item'

          const extension = file.name.split('.').pop().toUpperCase()
          const size = formatFileSize(file.size)

          item.innerHTML = `
                    <div class="file-info">
                        <div class="file-icon">ğŸ“·</div>
                        <div>
                            <div class="file-name">${file.name}</div>
                            <div class="file-size">${extension} | ${size}</div>
                        </div>
                    </div>
                    <div class="file-status">${fileInfo.status}</div>
                `

          fileList.appendChild(item)
        })

        convertBtn.disabled = false
      }

      // è½¬æ¢å›¾ç‰‡
      async function convertImages() {
        if (uploadedFiles.length === 0) {
          alert('è¯·å…ˆä¸Šä¼ å›¾ç‰‡')
          return
        }

        convertBtn.disabled = true
        convertBtn.textContent = 'è½¬æ¢ä¸­...'

        // è½¬æ¢æ‰€æœ‰å›¾ç‰‡
        for (let i = 0; i < uploadedFiles.length; i++) {
          const fileInfo = uploadedFiles[i]
          fileInfo.status = 'è½¬æ¢ä¸­...'
          updateFileList()

          try {
            const convertedBlob = await convertImage(
              fileInfo.file,
              currentFormat,
              currentQuality
            )
            fileInfo.converted = {
              blob: convertedBlob,
              url: URL.createObjectURL(convertedBlob),
              name:
                fileInfo.file.name.replace(/\.[^/.]+$/, '') +
                '.' +
                currentFormat,
            }
            fileInfo.status = 'âœ“ è½¬æ¢å®Œæˆ'
          } catch (error) {
            console.error(error)
            fileInfo.status = 'âœ— è½¬æ¢å¤±è´¥'
          }

          updateFileList()

          // æ˜¾ç¤ºç¬¬ä¸€å¼ è½¬æ¢å®Œæˆçš„å›¾ç‰‡é¢„è§ˆ
          if (i === 0 && fileInfo.converted) {
            previewContainer.innerHTML = `<img src="${fileInfo.converted.url}" alt="è½¬æ¢é¢„è§ˆ">`
          }
        }

        convertBtn.textContent = 'ğŸ”„ å¼€å§‹è½¬æ¢'
        downloadBtn.disabled = false
      }

      // å›¾ç‰‡è½¬æ¢æ ¸å¿ƒå‡½æ•°
      function convertImage(file, format, quality) {
        return new Promise((resolve, reject) => {
          const img = new Image()
          const reader = new FileReader()

          reader.onload = (e) => {
            img.onload = () => {
              // åˆ›å»ºCanvasè¿›è¡Œè½¬æ¢
              const canvas = document.createElement('canvas')
              canvas.width = img.width
              canvas.height = img.height

              const ctx = canvas.getContext('2d')
              ctx.drawImage(img, 0, 0)

              // æ ¹æ®æ ¼å¼è½¬æ¢
              let mimeType
              switch (format) {
                case 'jpg':
                case 'jpeg':
                  mimeType = 'image/jpeg'
                  break
                case 'png':
                  mimeType = 'image/png'
                  break
                case 'webp':
                  mimeType = 'image/webp'
                  break
                case 'bmp':
                  mimeType = 'image/bmp'
                  break
                case 'svg':
                  // SVGæ ¼å¼éœ€è¦ç‰¹æ®Šå¤„ç†
                  const svgData = createSVGFromCanvas(canvas)
                  const svgBlob = new Blob([svgData], { type: 'image/svg+xml' })
                  resolve(svgBlob)
                  return
                default:
                  mimeType = 'image/jpeg'
              }

              // è½¬æ¢è´¨é‡å¤„ç†
              let qualityValue = quality / 100
              if (format === 'png' || format === 'svg') {
                // PNGå’ŒSVGæ ¼å¼ä¸æ”¯æŒè´¨é‡å‚æ•°
                qualityValue = undefined
              }

              canvas.toBlob(
                (blob) => {
                  if (blob) {
                    resolve(blob)
                  } else {
                    reject(new Error('å›¾ç‰‡è½¬æ¢å¤±è´¥'))
                  }
                },
                mimeType,
                qualityValue
              )
            }

            img.onerror = () => {
              reject(new Error('å›¾ç‰‡åŠ è½½å¤±è´¥'))
            }

            img.src = e.target.result
          }

          reader.onerror = () => {
            reject(new Error('æ–‡ä»¶è¯»å–å¤±è´¥'))
          }

          reader.readAsDataURL(file)
        })
      }

      // ä¸‹è½½æ‰€æœ‰è½¬æ¢åçš„å›¾ç‰‡
      function downloadAll() {
        if (!uploadedFiles.some((file) => file.converted)) {
          alert('æ²¡æœ‰å¯ä¸‹è½½çš„è½¬æ¢ç»“æœ')
          return
        }

        // åˆ›å»ºå¹¶è§¦å‘ä¸‹è½½
        uploadedFiles.forEach((fileInfo) => {
          if (fileInfo.converted) {
            const a = document.createElement('a')
            a.href = fileInfo.converted.url
            a.download = fileInfo.converted.name
            document.body.appendChild(a)
            a.click()
            document.body.removeChild(a)
          }
        })
      }

      // é‡ç½®æ‰€æœ‰
      function resetAll() {
        // é‡Šæ”¾å¯¹è±¡URL
        uploadedFiles.forEach((fileInfo) => {
          if (fileInfo.converted) {
            URL.revokeObjectURL(fileInfo.converted.url)
          }
        })

        uploadedFiles = []
        fileInput.value = ''
        previewContainer.innerHTML = '<p>å›¾ç‰‡é¢„è§ˆåŒº</p>'
        convertBtn.disabled = true
        downloadBtn.disabled = true
        updateFileList()
      }

      // åˆ›å»ºSVGä»Canvas
      function createSVGFromCanvas(canvas) {
        const dataURL = canvas.toDataURL('image/png')
        const svgContent = `<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="${canvas.width}" height="${canvas.height}" viewBox="0 0 ${canvas.width} ${canvas.height}">
  <image width="${canvas.width}" height="${canvas.height}" xlink:href="${dataURL}"/>
</svg>`
        return svgContent
      }

      // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
      function formatFileSize(bytes) {
        if (bytes < 1024) return bytes + ' B'
        else if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB'
        else return (bytes / 1048576).toFixed(1) + ' MB'
      }

      // åˆå§‹åŒ–
      window.onload = initEvents
    </script>
  </body>
</html>
